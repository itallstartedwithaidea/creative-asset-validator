<!DOCTYPE html>
<html>
<head>
    <title>Google Sign-In Test</title>
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            justify-content: center; 
            min-height: 100vh;
            background: #1a1a2e;
            color: white;
            margin: 0;
        }
        #status { 
            margin: 20px; 
            padding: 20px; 
            background: #16213e; 
            border-radius: 8px;
            max-width: 600px;
            width: 90%;
        }
        .success { color: #4ade80; }
        .error { color: #f87171; }
        .info { color: #60a5fa; }
        h1 { color: #ec4899; }
        pre { 
            background: #0f0f23; 
            padding: 10px; 
            border-radius: 4px; 
            overflow: auto;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <h1>ðŸ§ª Google Sign-In Test</h1>
    
    <div id="google-signin-container"></div>
    
    <div id="status">
        <p class="info">Loading Google Sign-In...</p>
    </div>

    <script>
        const CLIENT_ID = '487493187407-tpdf56sd9elitl7fke0votho17h7m7gs.apps.googleusercontent.com';
        
        function log(message, type = 'info') {
            const status = document.getElementById('status');
            const p = document.createElement('p');
            p.className = type;
            p.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            status.appendChild(p);
            console.log(`[${type}]`, message);
        }
        
        function handleCredentialResponse(response) {
            log('âœ… CALLBACK FIRED! Credential received!', 'success');
            
            try {
                const base64Url = response.credential.split('.')[1];
                const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
                const payload = JSON.parse(decodeURIComponent(atob(base64).split('').map(c => 
                    '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2)
                ).join('')));
                
                log(`Logged in as: ${payload.email}`, 'success');
                log(`Name: ${payload.name}`, 'success');
                
                log('Storing credentials in sessionStorage...', 'info');
                sessionStorage.setItem('google_credential', response.credential);
                sessionStorage.setItem('google_email', payload.email);
                sessionStorage.setItem('google_name', payload.name);
                sessionStorage.setItem('google_picture', payload.picture || '');
                sessionStorage.setItem('google_sub', payload.sub);
                
                const storedEmail = sessionStorage.getItem('google_email');
                log('Verified storage - email: ' + storedEmail, storedEmail ? 'success' : 'error');
                
                log('âœ… Credentials stored! Redirecting to main app in 2 seconds...', 'success');
                
                setTimeout(() => {
                    window.location.href = '../index.html?auto_login=true';
                }, 2000);
                
            } catch (e) {
                log(`Error decoding: ${e.message}`, 'error');
            }
        }
        
        window.handleCredentialResponse = handleCredentialResponse;
        
        function initGoogle() {
            log(`Origin: ${window.location.origin}`);
            log(`Client ID: ${CLIENT_ID.substring(0, 20)}...`);
            
            if (typeof google === 'undefined') {
                log('Google API not loaded yet, retrying in 1s...', 'info');
                setTimeout(initGoogle, 1000);
                return;
            }
            
            log('Google API loaded, initializing...', 'info');
            
            try {
                google.accounts.id.initialize({
                    client_id: CLIENT_ID,
                    callback: handleCredentialResponse,
                    auto_select: false,
                    use_fedcm_for_prompt: false
                });
                
                log('Google initialized, rendering button...', 'info');
                
                google.accounts.id.renderButton(
                    document.getElementById('google-signin-container'),
                    { theme: 'filled_blue', size: 'large', text: 'signin_with' }
                );
                
                log('Button rendered! Click to sign in.', 'success');
                
                google.accounts.id.prompt((notification) => {
                    log(`Prompt notification: displayed=${!notification.isNotDisplayed()}, skipped=${notification.isSkippedMoment()}`, 'info');
                    if (notification.isNotDisplayed()) {
                        log(`Not displayed reason: ${notification.getNotDisplayedReason()}`, 'error');
                    }
                });
                
            } catch (e) {
                log(`Error: ${e.message}`, 'error');
            }
        }
        
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initGoogle);
        } else {
            initGoogle();
        }
    </script>
</body>
</html>
