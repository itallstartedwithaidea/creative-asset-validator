<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Creative Asset Validator</title>
    <meta name="description" content="Professional creative asset validation tool with Google SSO authentication">
    
    <!-- Performance: DNS Prefetch & Preconnect -->
    <link rel="dns-prefetch" href="https://accounts.google.com">
    <link rel="dns-prefetch" href="https://fonts.googleapis.com">
    <link rel="dns-prefetch" href="https://apis.google.com">
    <link rel="preconnect" href="https://accounts.google.com" crossorigin>
    
    <!-- Favicon -->
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üé¨</text></svg>">
    
    <!-- Performance: Preload Critical Resources -->
    <link rel="preload" href="validator.css?v=5.1.0" as="style">
    <link rel="preload" href="security-core.js?v=5.1.0" as="script">
    <link rel="preload" href="validator-app.js?v=5.1.0" as="script">
    
    <!-- Google Fonts - Optimized Loading -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet" media="print" onload="this.media='all'">
    <noscript><link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet"></noscript>
    
    <!-- Google Identity Services -->
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    
    <!-- Google GenAI SDK for Veo 3.1 Video Generation -->
    <script type="module">
        // Load Google GenAI SDK dynamically
        (async function() {
            try {
                const { GoogleGenAI } = await import('https://esm.run/@google/genai');
                window.GoogleGenAI = GoogleGenAI;
                console.log('‚úÖ Google GenAI SDK loaded successfully');
            } catch (error) {
                console.warn('‚ö†Ô∏è Google GenAI SDK not available:', error.message);
                console.warn('   Video generation will fall back to REST API');
            }
        })();
    </script>
    
    <!-- Main Styles -->
    <link rel="stylesheet" href="validator.css?v=5.1.0">
    
    <style>
        /* ============================================
           MODERN DESIGN SYSTEM - BLACK/PINK/WHITE
           Inspired by HubSpot & Monday.com
           ============================================ */
        
        :root {
            /* Primary Colors - Hot Pink */
            --cav-primary: #ec4899;
            --cav-primary-dark: #db2777;
            --cav-primary-light: #f472b6;
            --cav-primary-soft: rgba(236, 72, 153, 0.15);
            
            /* Background Colors - Clean Black/Dark */
            --cav-bg-dark: #0a0a0a;
            --cav-bg-medium: #141414;
            --cav-bg-light: #1f1f1f;
            --cav-bg-card: #1a1a1a;
            --cav-bg-elevated: #252525;
            
            /* Text Colors */
            --cav-text-primary: #ffffff;
            --cav-text-secondary: #a1a1aa;
            --cav-text-muted: #71717a;
            
            /* Accent Colors */
            --cav-success: #10b981;
            --cav-warning: #f59e0b;
            --cav-error: #ef4444;
            --cav-info: #3b82f6;
            
            /* Borders & Surfaces */
            --cav-border: rgba(255, 255, 255, 0.08);
            --cav-border-hover: rgba(255, 255, 255, 0.15);
            --cav-surface: rgba(255, 255, 255, 0.03);
            --cav-surface-hover: rgba(255, 255, 255, 0.06);
            
            /* Shadows */
            --cav-shadow-sm: 0 1px 2px rgba(0, 0, 0, 0.4);
            --cav-shadow-md: 0 4px 12px rgba(0, 0, 0, 0.5);
            --cav-shadow-lg: 0 8px 32px rgba(0, 0, 0, 0.6);
            --cav-shadow-pink: 0 4px 24px rgba(236, 72, 153, 0.25);
            
            /* Spacing */
            --cav-space-xs: 0.25rem;
            --cav-space-sm: 0.5rem;
            --cav-space-md: 1rem;
            --cav-space-lg: 1.5rem;
            --cav-space-xl: 2rem;
            --cav-space-2xl: 3rem;
            
            /* Border Radius */
            --cav-radius-sm: 6px;
            --cav-radius-md: 10px;
            --cav-radius-lg: 16px;
            --cav-radius-xl: 24px;
            --cav-radius-full: 9999px;
            
            /* Transitions */
            --cav-transition-fast: 0.15s ease;
            --cav-transition-normal: 0.25s ease;
            --cav-transition-slow: 0.4s ease;
        }

        *, *::before, *::after { 
            box-sizing: border-box; 
            margin: 0; 
            padding: 0; 
        }
        
        html { 
            scroll-behavior: smooth; 
        }
        
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: var(--cav-bg-dark);
            min-height: 100vh;
            color: var(--cav-text-primary);
            line-height: 1.6;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        /* ============================================
           LOGIN MODAL - Clean & Modern
           ============================================ */
        .login-modal {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.97);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 100000;
            padding: var(--cav-space-xl);
            backdrop-filter: blur(8px);
        }
        
        .login-modal.hidden { display: none; }

        .login-content {
            background: var(--cav-bg-card);
            border-radius: var(--cav-radius-xl);
            padding: var(--cav-space-2xl);
            max-width: 440px;
            width: 100%;
            border: 1px solid var(--cav-border);
            text-align: center;
            box-shadow: var(--cav-shadow-lg);
            position: relative;
            overflow: hidden;
        }
        
        .login-content::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, var(--cav-primary), #f472b6, var(--cav-primary));
        }

        .login-content h2 {
            font-size: 1.875rem;
            margin-bottom: var(--cav-space-md);
            color: var(--cav-text-primary);
            font-weight: 700;
            letter-spacing: -0.02em;
        }

        .login-content p {
            color: var(--cav-text-secondary);
            margin-bottom: var(--cav-space-xl);
            font-size: 1rem;
            line-height: 1.6;
        }

        /* Google Sign-in Button */
        .google-signin-btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            padding: 14px 32px;
            background: #ffffff;
            border: none;
            border-radius: var(--cav-radius-md);
            color: #1f1f1f;
            font-family: inherit;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: var(--cav-transition-normal);
            box-shadow: var(--cav-shadow-md);
            min-width: 260px;
        }

        .google-signin-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(255, 255, 255, 0.15);
        }

        .google-signin-btn:active {
            transform: translateY(0);
        }

        .google-signin-btn img {
            width: 20px;
            height: 20px;
        }

        #google-signin-container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 50px;
        }

        #google-signin-container iframe {
            border-radius: var(--cav-radius-md) !important;
        }

        .g_id_signin {
            display: inline-block !important;
        }

        /* ============================================
           OLD HEADER (Hidden - Now Using Sidebar)
           ============================================ */
        .site-header {
            display: none !important;
        }

        /* Keep animations for general use */
        @keyframes nav-glow {
            0%, 100% { box-shadow: 0 4px 20px rgba(225, 48, 108, 0.4); }
            50% { box-shadow: 0 4px 30px rgba(225, 48, 108, 0.6); }
        }

        @keyframes pulse-glow {
            0%, 100% { box-shadow: 0 0 8px rgba(225, 48, 108, 0.4); }
            50% { box-shadow: 0 0 20px rgba(225, 48, 108, 0.6); }
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        @keyframes slideOut {
            from { transform: translateX(0); opacity: 1; }
            to { transform: translateX(100%); opacity: 0; }
        }

        /* Admin Button - Topbar Style */
        .admin-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 36px;
            height: 36px;
            background: var(--cav-glass-bg);
            border: none;
            border-radius: var(--cav-radius-sm);
            color: var(--cav-text-secondary);
            cursor: pointer;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 2px 8px rgba(225, 48, 108, 0.25);
        }

        .admin-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(225, 48, 108, 0.4);
        }

        .admin-btn:active {
            transform: scale(0.98);
        }

        /* Logout Button - Adobe Style */
        .logout-btn {
            padding: 10px 18px;
            background: rgba(255, 255, 255, 0.04);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            color: rgba(255, 255, 255, 0.7);
            cursor: pointer;
            font-size: 0.875rem;
            font-weight: 500;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .logout-btn:hover {
            background: rgba(239, 68, 68, 0.15);
            border-color: rgba(239, 68, 68, 0.4);
            color: #fca5a5;
            transform: translateY(-1px);
        }

        /* ============================================
           MAIN CONTAINER
           ============================================ */
        #creative-asset-validator-root {
            max-width: 1600px;
            margin: 0 auto;
            padding: var(--cav-space-lg);
        }

        /* ============================================
           FOOTER - Sidebar Layout
           ============================================ */
        .site-footer {
            text-align: center;
            padding: var(--cav-space-6);
            color: var(--cav-text-muted);
            margin-left: var(--sidebar-width-collapsed, 72px);
            transition: margin-left 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            font-size: 0.875rem;
            border-top: 1px solid var(--cav-border);
            margin-top: var(--cav-space-xl);
            background: var(--cav-bg-medium);
        }

        .site-footer a {
            color: var(--cav-primary);
            text-decoration: none;
            transition: var(--cav-transition-fast);
        }
        
        .site-footer a:hover {
            color: var(--cav-primary-light);
        }

        /* ============================================
           DEMO LOGIN MODAL - For Add User etc.
           ============================================ */
        .demo-login-modal {
            position: fixed;
            inset: 0;
            z-index: 300000; /* Higher than admin modal */
            display: flex;
            align-items: center;
            justify-content: center;
            padding: var(--cav-space-lg);
        }
        
        .demo-login-overlay {
            position: absolute;
            inset: 0;
            background: rgba(0, 0, 0, 0.85);
            backdrop-filter: blur(8px);
        }
        
        .demo-login-content {
            position: relative;
            background: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 100%);
            border-radius: 16px;
            padding: 2rem;
            max-width: 400px;
            width: 90%;
            text-align: center;
            border: 1px solid rgba(255,255,255,0.1);
            box-shadow: 0 25px 50px rgba(0,0,0,0.5);
            z-index: 1;
        }
        
        .demo-login-close {
            position: absolute;
            top: 1rem;
            right: 1rem;
            background: none;
            border: none;
            color: #9ca3af;
            font-size: 1.25rem;
            cursor: pointer;
            padding: 0.5rem;
            border-radius: 8px;
            transition: all 0.2s;
        }
        
        .demo-login-close:hover {
            background: rgba(255,255,255,0.1);
            color: #fff;
        }
        
        .demo-login-btn {
            width: 100%;
            padding: 0.875rem 1.5rem;
            border-radius: 8px;
            border: none;
            background: linear-gradient(135deg, #ec4899 0%, #a855f7 100%);
            color: #fff;
            font-weight: 600;
            cursor: pointer;
            font-size: 1rem;
            transition: all 0.2s;
        }
        
        .demo-login-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 24px rgba(168, 85, 247, 0.4);
        }

        /* ============================================
           ADMIN MODAL - Modern Glass Effect
           ============================================ */
        .admin-modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.85);
            z-index: 200000;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: var(--cav-space-lg);
            backdrop-filter: blur(8px);
        }

        .admin-modal {
            background: var(--cav-bg-card);
            border-radius: var(--cav-radius-xl);
            width: 100%;
            max-width: 1200px;
            max-height: 90vh;
            overflow: hidden;
            border: 1px solid var(--cav-border);
            display: flex;
            flex-direction: column;
            box-shadow: var(--cav-shadow-lg);
        }

        .admin-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: var(--cav-space-lg) var(--cav-space-xl);
            border-bottom: 1px solid var(--cav-border);
            background: var(--cav-bg-elevated);
        }

        .admin-header h2 {
            font-size: 1.5rem;
            color: var(--cav-text-primary);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .admin-close-btn {
            background: none;
            border: none;
            color: #fff;
            font-size: 1.5rem;
            cursor: pointer;
            padding: 0.5rem;
            border-radius: 8px;
            transition: background 0.2s;
        }

        .admin-close-btn:hover {
            background: rgba(255,255,255,0.1);
        }

        .admin-tabs {
            display: flex;
            gap: 0;
            background: rgba(0,0,0,0.2);
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        .admin-tab {
            padding: 1rem 1.5rem;
            background: none;
            border: none;
            color: var(--cav-text-muted);
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 500;
            transition: all 0.2s;
            border-bottom: 2px solid transparent;
        }

        .admin-tab:hover {
            color: #fff;
            background: rgba(255,255,255,0.05);
        }

        .admin-tab.active {
            color: #fff;
            border-bottom-color: var(--cav-primary);
            background: var(--cav-primary-soft);
        }

        .admin-content {
            flex: 1;
            overflow-y: auto;
            padding: var(--cav-space-xl);
        }

        .admin-section {
            display: none;
        }

        .admin-section.active {
            display: block;
        }

        /* ============================================
           STATS GRID - Modern Cards
           ============================================ */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: var(--cav-space-md);
            margin-bottom: var(--cav-space-xl);
        }

        .stat-card {
            background: var(--cav-bg-elevated);
            padding: var(--cav-space-lg);
            border-radius: var(--cav-radius-lg);
            text-align: center;
            border: 1px solid var(--cav-border);
            transition: var(--cav-transition-normal);
        }
        
        .stat-card:hover {
            border-color: var(--cav-primary);
            transform: translateY(-2px);
        }

        .stat-value {
            font-size: 2.25rem;
            font-weight: 700;
            background: linear-gradient(135deg, var(--cav-primary), #f472b6);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .stat-label {
            color: var(--cav-text-muted);
            font-size: 0.875rem;
            margin-top: var(--cav-space-xs);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        /* ============================================
           TABLES - Clean Modern Style
           ============================================ */
        .admin-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.875rem;
        }

        .admin-table th {
            padding: var(--cav-space-md);
            text-align: left;
            color: var(--cav-text-muted);
            background: var(--cav-bg-elevated);
            font-weight: 600;
            text-transform: uppercase;
            font-size: 0.75rem;
            letter-spacing: 0.05em;
        }

        .admin-table td {
            padding: var(--cav-space-md);
            border-top: 1px solid var(--cav-border);
            color: var(--cav-text-primary);
        }

        .admin-table tr:hover td {
            background: var(--cav-surface-hover);
        }

        /* ============================================
           BADGES - Pill Style
           ============================================ */
        .badge {
            display: inline-flex;
            align-items: center;
            padding: 4px 12px;
            border-radius: var(--cav-radius-full);
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.03em;
        }

        .badge-admin { background: linear-gradient(135deg, #f59e0b, #d97706); color: #fff; }
        .badge-editor { background: linear-gradient(135deg, #3b82f6, #2563eb); color: #fff; }
        .badge-viewer { background: var(--cav-bg-elevated); color: var(--cav-text-secondary); }
        .badge-corporate { background: linear-gradient(135deg, #10b981, #059669); color: #fff; }
        .badge-personal { background: linear-gradient(135deg, var(--cav-primary), #f472b6); color: #fff; }
        .badge-blocked { background: linear-gradient(135deg, #ef4444, #dc2626); color: #fff; }
        .badge-active { background: linear-gradient(135deg, #10b981, #059669); color: #fff; }

        /* ============================================
           GLOBAL BUTTONS - HubSpot/Monday Style
           ============================================ */
        .btn, button[class*="btn-"], button[class*="admin-btn"] {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 10px 20px;
            border-radius: var(--cav-radius-md);
            font-size: 0.875rem;
            font-weight: 600;
            cursor: pointer;
            transition: var(--cav-transition-normal);
            border: none;
            font-family: inherit;
        }
        
        .btn-primary, .admin-btn-primary {
            background: linear-gradient(135deg, var(--cav-primary), var(--cav-primary-dark));
            color: #ffffff;
            box-shadow: var(--cav-shadow-sm);
        }

        .btn-primary:hover, .admin-btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: var(--cav-shadow-pink);
        }

        .btn-secondary, .admin-btn-secondary {
            background: var(--cav-bg-elevated);
            border: 1px solid var(--cav-border);
            color: var(--cav-text-primary);
        }

        .btn-secondary:hover, .admin-btn-secondary:hover {
            background: var(--cav-surface-hover);
            border-color: var(--cav-border-hover);
        }

        .btn-danger, .admin-btn-danger {
            background: transparent;
            border: 1px solid var(--cav-error);
            color: var(--cav-error);
        }

        .btn-danger:hover, .admin-btn-danger:hover {
            background: rgba(239, 68, 68, 0.1);
        }

        .btn-success, .admin-btn-success {
            background: linear-gradient(135deg, #10b981, #059669);
            color: #ffffff;
        }

        .btn-success:hover, .admin-btn-success:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 16px rgba(16, 185, 129, 0.4);
        }
        
        .btn-ghost {
            background: transparent;
            color: var(--cav-text-secondary);
            padding: 8px 16px;
        }
        
        .btn-ghost:hover {
            background: var(--cav-surface);
            color: var(--cav-text-primary);
        }

        /* ============================================
           GLOBAL CARDS - Clean Elevated Style
           ============================================ */
        .card {
            background: var(--cav-bg-card);
            border: 1px solid var(--cav-border);
            border-radius: var(--cav-radius-lg);
            padding: var(--cav-space-lg);
            transition: var(--cav-transition-normal);
        }
        
        .card:hover {
            border-color: var(--cav-border-hover);
            box-shadow: var(--cav-shadow-md);
        }
        
        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--cav-space-md);
            padding-bottom: var(--cav-space-md);
            border-bottom: 1px solid var(--cav-border);
        }
        
        .card-title {
            font-size: 1.125rem;
            font-weight: 600;
            color: var(--cav-text-primary);
        }

        /* ============================================
           FORM INPUTS - Modern Style
           ============================================ */
        input[type="text"],
        input[type="email"],
        input[type="password"],
        input[type="number"],
        input[type="url"],
        input[type="search"],
        textarea,
        select {
            width: 100%;
            padding: 12px 16px;
            background: var(--cav-bg-elevated);
            border: 1px solid var(--cav-border);
            border-radius: var(--cav-radius-md);
            color: var(--cav-text-primary);
            font-size: 0.9375rem;
            font-family: inherit;
            transition: var(--cav-transition-fast);
        }
        
        input:focus,
        textarea:focus,
        select:focus {
            outline: none;
            border-color: var(--cav-primary);
            box-shadow: 0 0 0 3px var(--cav-primary-soft);
        }
        
        input::placeholder,
        textarea::placeholder {
            color: var(--cav-text-muted);
        }
        
        select {
            cursor: pointer;
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%23a1a1aa' d='M6 8L1 3h10z'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 12px center;
            padding-right: 36px;
        }
        
        select option {
            background: var(--cav-bg-card);
            color: var(--cav-text-primary);
        }

        /* ============================================
           SCROLLBAR - Sleek Style
           ============================================ */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        
        ::-webkit-scrollbar-track {
            background: var(--cav-bg-dark);
        }
        
        ::-webkit-scrollbar-thumb {
            background: var(--cav-bg-light);
            border-radius: var(--cav-radius-full);
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: var(--cav-primary);
        }

        /* ============================================
           TOOLTIPS & POPOVERS
           ============================================ */
        [data-tooltip] {
            position: relative;
        }
        
        [data-tooltip]::after {
            content: attr(data-tooltip);
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            padding: 6px 12px;
            background: var(--cav-bg-elevated);
            color: var(--cav-text-primary);
            font-size: 0.75rem;
            border-radius: var(--cav-radius-sm);
            white-space: nowrap;
            opacity: 0;
            visibility: hidden;
            transition: var(--cav-transition-fast);
            z-index: 1000;
            box-shadow: var(--cav-shadow-md);
        }
        
        [data-tooltip]:hover::after {
            opacity: 1;
            visibility: visible;
        }

        /* Forms */
        .admin-form-group {
            margin-bottom: 1.5rem;
        }

        .admin-form-group label {
            display: block;
            margin-bottom: 0.5rem;
            color: var(--cav-text-secondary);
            font-weight: 500;
        }

        .admin-input {
            width: 100%;
            padding: 0.75rem 1rem;
            background: rgba(0,0,0,0.3);
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: 8px;
            color: #fff;
            font-size: 0.9rem;
        }

        .admin-input:focus {
            outline: none;
            border-color: var(--cav-primary);
        }

        .admin-input::placeholder {
            color: var(--cav-text-muted);
        }

        .admin-select {
            width: 100%;
            padding: 0.75rem 1rem;
            background: rgba(0,0,0,0.3);
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: 8px;
            color: #fff;
            font-size: 0.9rem;
            cursor: pointer;
        }

        .admin-select option {
            background: #1e1b4b;
        }

        /* Toggle Switch */
        .toggle-switch {
            position: relative;
            width: 50px;
            height: 26px;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(255,255,255,0.2);
            transition: 0.3s;
            border-radius: 26px;
        }

        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 20px;
            width: 20px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: 0.3s;
            border-radius: 50%;
        }

        .toggle-switch input:checked + .toggle-slider {
            background-color: var(--cav-success);
        }

        .toggle-switch input:checked + .toggle-slider:before {
            transform: translateX(24px);
        }

        /* Domain Tags */
        .domain-tag {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            background: rgba(0,0,0,0.3);
            border-radius: 20px;
            margin: 0.25rem;
            font-size: 0.875rem;
        }

        .domain-tag-remove {
            background: none;
            border: none;
            color: var(--cav-error);
            cursor: pointer;
            font-size: 1rem;
            padding: 0;
            line-height: 1;
        }

        /* Activity Log */
        .activity-item {
            padding: 0.75rem 0;
            border-bottom: 1px solid rgba(255,255,255,0.05);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .activity-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 0.5rem;
        }

        .activity-dot.login { background: var(--cav-success); }
        .activity-dot.logout { background: var(--cav-error); }
        .activity-dot.action { background: var(--cav-primary); }

        /* Responsive */
        @media (max-width: 768px) {
            .site-header { padding: 1rem; flex-wrap: wrap; gap: 1rem; }
            .site-logo span { display: none; }
            .user-details { display: none; }
            .admin-tabs { overflow-x: auto; }
            .admin-tab { white-space: nowrap; }
            .admin-modal { max-height: 95vh; }
            .admin-content { padding: 1rem; }
        }
    </style>
</head>
<body>
    <!-- Login Modal -->
    <div id="login-modal" class="login-modal">
        <div class="login-content">
            <div style="font-size: 4rem; margin-bottom: 1rem;">üé¨</div>
            <h2>Welcome!</h2>
            <p>Sign in with your Google account to access the Creative Asset Validator</p>
            <div id="google-signin-container">
                <button class="google-signin-btn" id="google-signin-btn">
                    <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" alt="Google">
                    Sign in with Google
                </button>
            </div>
            <p style="margin-top: 1.5rem; font-size: 0.8rem; color: var(--cav-text-muted);">
                Corporate emails get team sharing access
            </p>
            <p id="signin-help-link" style="margin-top: 0.75rem; font-size: 0.75rem; display: none;">
                <a href="#" onclick="startDirectOAuth(); return false;" style="color: #a855f7;">
                    Having trouble? Click here for help
                </a>
            </p>
        </div>
    </div>

    <!-- SVG Icon Definitions (Adobe Express Style) -->
    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
        <defs>
            <!-- Library/Folder Icon -->
            <symbol id="icon-library" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                <path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"/>
            </symbol>
            <!-- Analyze/Chart Icon -->
            <symbol id="icon-analyze" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                <path d="M21 21H4.6c-.56 0-.84 0-1.05-.11a1 1 0 0 1-.44-.44C3 20.24 3 19.96 3 19.4V3"/>
                <path d="m7 14 4-4 4 4 6-6"/>
                <path d="M18 8h3v3"/>
            </symbol>
            <!-- Strategy/Target Icon -->
            <symbol id="icon-strategy" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                <circle cx="12" cy="12" r="10"/>
                <circle cx="12" cy="12" r="6"/>
                <circle cx="12" cy="12" r="2"/>
            </symbol>
            <!-- Learn/Book Icon -->
            <symbol id="icon-learn" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                <path d="M4 19.5v-15A2.5 2.5 0 0 1 6.5 2H20v20H6.5a2.5 2.5 0 0 1 0-5H20"/>
                <path d="M8 7h6"/>
                <path d="M8 11h8"/>
            </symbol>
            <!-- AI Studio/Sparkles Icon -->
            <symbol id="icon-ai-studio" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                <path d="m12 3-1.9 5.8a2 2 0 0 1-1.3 1.3L3 12l5.8 1.9a2 2 0 0 1 1.3 1.3L12 21l1.9-5.8a2 2 0 0 1 1.3-1.3L21 12l-5.8-1.9a2 2 0 0 1-1.3-1.3Z"/>
            </symbol>
            <!-- Brand Kit/Palette Icon -->
            <symbol id="icon-brand-kit" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                <circle cx="13.5" cy="6.5" r="0.5" fill="currentColor"/>
                <circle cx="17.5" cy="10.5" r="0.5" fill="currentColor"/>
                <circle cx="8.5" cy="7.5" r="0.5" fill="currentColor"/>
                <circle cx="6.5" cy="12.5" r="0.5" fill="currentColor"/>
                <path d="M12 2C6.5 2 2 6.5 2 12s4.5 10 10 10c.926 0 1.648-.746 1.648-1.688 0-.437-.18-.835-.437-1.125-.29-.289-.438-.652-.438-1.125a1.64 1.64 0 0 1 1.668-1.668h1.996c3.051 0 5.555-2.503 5.555-5.555C21.965 6.012 17.461 2 12 2z"/>
            </symbol>
            <!-- CRM/Users Icon -->
            <symbol id="icon-crm" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                <path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/>
                <circle cx="9" cy="7" r="4"/>
                <path d="M22 21v-2a4 4 0 0 0-3-3.87"/>
                <path d="M16 3.13a4 4 0 0 1 0 7.75"/>
            </symbol>
            <!-- Integrations/Puzzle Icon -->
            <symbol id="icon-integrations" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                <path d="M19.439 7.85c-.049.322.059.648.289.878l1.568 1.568c.47.47.706 1.087.706 1.704s-.235 1.233-.706 1.704l-1.611 1.611a.98.98 0 0 1-.837.276c-.47-.07-.802-.48-.968-.925a2.501 2.501 0 1 0-3.214 3.214c.446.166.855.497.925.968a.979.979 0 0 1-.276.837l-1.61 1.61a2.404 2.404 0 0 1-1.705.707 2.402 2.402 0 0 1-1.704-.706l-1.568-1.568a1.026 1.026 0 0 0-.877-.29c-.493.074-.84.504-1.02.968a2.5 2.5 0 1 1-3.237-3.237c.464-.18.894-.527.967-1.02a1.026 1.026 0 0 0-.289-.877l-1.568-1.568A2.402 2.402 0 0 1 1.998 12c0-.617.236-1.234.706-1.704L4.23 8.77c.24-.24.581-.353.917-.303.515.077.877.528 1.073 1.01a2.5 2.5 0 1 0 3.259-3.259c-.482-.196-.933-.558-1.01-1.073-.05-.336.062-.676.303-.917l1.525-1.525A2.402 2.402 0 0 1 12 1.998c.617 0 1.234.236 1.704.706l1.568 1.568c.23.23.556.338.877.29.493-.074.84-.504 1.02-.968a2.5 2.5 0 1 1 3.237 3.237c-.464.18-.894.527-.967 1.02Z"/>
            </symbol>
            <!-- Usage/Bar Chart Icon -->
            <symbol id="icon-usage" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                <rect x="3" y="12" width="4" height="9" rx="1"/>
                <rect x="10" y="8" width="4" height="13" rx="1"/>
                <rect x="17" y="3" width="4" height="18" rx="1"/>
            </symbol>
            <!-- Settings/Gear Icon -->
            <symbol id="icon-settings" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                <path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.08a2 2 0 0 1-1-1.74v-.5a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/>
                <circle cx="12" cy="12" r="3"/>
            </symbol>
            <!-- Admin/Shield Icon -->
            <symbol id="icon-admin" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/>
                <path d="m9 12 2 2 4-4"/>
            </symbol>
            <!-- Menu/Hamburger Icon -->
            <symbol id="icon-menu" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                <line x1="3" y1="6" x2="21" y2="6"/>
                <line x1="3" y1="12" x2="21" y2="12"/>
                <line x1="3" y1="18" x2="21" y2="18"/>
            </symbol>
            <!-- Theme Light/Sun Icon -->
            <symbol id="icon-sun" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                <circle cx="12" cy="12" r="4"/>
                <path d="M12 2v2"/>
                <path d="M12 20v2"/>
                <path d="m4.93 4.93 1.41 1.41"/>
                <path d="m17.66 17.66 1.41 1.41"/>
                <path d="M2 12h2"/>
                <path d="M20 12h2"/>
                <path d="m6.34 17.66-1.41 1.41"/>
                <path d="m19.07 4.93-1.41 1.41"/>
            </symbol>
            <!-- Theme Dark/Moon Icon -->
            <symbol id="icon-moon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                <path d="M12 3a6 6 0 0 0 9 9 9 9 0 1 1-9-9Z"/>
            </symbol>
            <!-- Logout Icon -->
            <symbol id="icon-logout" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/>
                <polyline points="16,17 21,12 16,7"/>
                <line x1="21" y1="12" x2="9" y2="12"/>
            </symbol>
            <!-- Chevron Right Icon -->
            <symbol id="icon-chevron-right" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                <polyline points="9,6 15,12 9,18"/>
            </symbol>
            <!-- Search Icon -->
            <symbol id="icon-search" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                <circle cx="11" cy="11" r="8"/>
                <path d="m21 21-4.3-4.3"/>
            </symbol>
            
            <!-- Channel Icons for Quick Start -->
            <symbol id="icon-instagram-story" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                <rect x="5" y="2" width="14" height="20" rx="3"/>
                <circle cx="12" cy="12" r="3"/>
                <path d="M12 6v0"/>
            </symbol>
            <symbol id="icon-facebook-post" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                <rect x="2" y="4" width="20" height="16" rx="2"/>
                <path d="M2 8h20"/>
                <circle cx="8" cy="15" r="2"/>
                <path d="M14 13h4"/>
                <path d="M14 16h4"/>
            </symbol>
            <symbol id="icon-youtube-thumb" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                <rect x="2" y="4" width="20" height="16" rx="2"/>
                <polygon points="10,8 16,12 10,16"/>
            </symbol>
            <symbol id="icon-tiktok-video" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                <rect x="5" y="2" width="14" height="20" rx="3"/>
                <path d="M9 11c0-1.66 1.34-3 3-3s3 1.34 3 3v4c0 .55-.45 1-1 1h-4c-.55 0-1-.45-1-1v-4z"/>
            </symbol>
            <symbol id="icon-linkedin-banner" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                <rect x="2" y="7" width="20" height="10" rx="2"/>
                <path d="M7 11h2v3H7z"/>
                <path d="M11 10h6"/>
                <path d="M11 13h4"/>
            </symbol>
            <symbol id="icon-google-display" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                <rect x="4" y="4" width="16" height="16" rx="2"/>
                <path d="M4 9h16"/>
                <path d="M9 9v11"/>
            </symbol>
            <symbol id="icon-app-store" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                <rect x="4" y="4" width="16" height="16" rx="4"/>
                <path d="M8 8h8v8H8z"/>
            </symbol>
            
            <!-- Common Action Icons -->
            <symbol id="icon-upload" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                <polyline points="17 8 12 3 7 8"/>
                <line x1="12" y1="3" x2="12" y2="15"/>
            </symbol>
            <symbol id="icon-download" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                <polyline points="7 10 12 15 17 10"/>
                <line x1="12" y1="15" x2="12" y2="3"/>
            </symbol>
            <symbol id="icon-plus" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                <line x1="12" y1="5" x2="12" y2="19"/>
                <line x1="5" y1="12" x2="19" y2="12"/>
            </symbol>
            <symbol id="icon-link" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"/>
                <path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"/>
            </symbol>
            <symbol id="icon-eye" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/>
                <circle cx="12" cy="12" r="3"/>
            </symbol>
            <symbol id="icon-edit" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/>
                <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/>
            </symbol>
            <symbol id="icon-trash" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                <polyline points="3 6 5 6 21 6"/>
                <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
            </symbol>
            <symbol id="icon-star" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                <polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/>
            </symbol>
            <symbol id="icon-filter" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                <polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"/>
            </symbol>
            <symbol id="icon-check" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                <polyline points="20 6 9 17 4 12"/>
            </symbol>
            <symbol id="icon-x" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                <line x1="18" y1="6" x2="6" y2="18"/>
                <line x1="6" y1="6" x2="18" y2="18"/>
            </symbol>
            <symbol id="icon-refresh" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                <polyline points="23 4 23 10 17 10"/>
                <polyline points="1 20 1 14 7 14"/>
                <path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"/>
            </symbol>
            <symbol id="icon-info" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                <circle cx="12" cy="12" r="10"/>
                <line x1="12" y1="16" x2="12" y2="12"/>
                <line x1="12" y1="8" x2="12.01" y2="8"/>
            </symbol>
            <symbol id="icon-folder" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                <path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"/>
            </symbol>
            <symbol id="icon-camera" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                <path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"/>
                <circle cx="12" cy="13" r="4"/>
            </symbol>
            <symbol id="icon-video" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                <polygon points="23 7 16 12 23 17 23 7"/>
                <rect x="1" y="5" width="15" height="14" rx="2" ry="2"/>
            </symbol>
            <symbol id="icon-image" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
                <circle cx="8.5" cy="8.5" r="1.5"/>
                <polyline points="21 15 16 10 5 21"/>
            </symbol>
            <symbol id="icon-globe" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                <circle cx="12" cy="12" r="10"/>
                <line x1="2" y1="12" x2="22" y2="12"/>
                <path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"/>
            </symbol>
            <symbol id="icon-users" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
                <circle cx="9" cy="7" r="4"/>
                <path d="M23 21v-2a4 4 0 0 0-3-3.87"/>
                <path d="M16 3.13a4 4 0 0 1 0 7.75"/>
            </symbol>
            <symbol id="icon-user" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/>
                <circle cx="12" cy="7" r="4"/>
            </symbol>
            <symbol id="icon-building" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                <rect x="4" y="2" width="16" height="20" rx="2" ry="2"/>
                <path d="M9 22v-4h6v4"/>
                <line x1="8" y1="6" x2="8" y2="6.01"/>
                <line x1="16" y1="6" x2="16" y2="6.01"/>
                <line x1="12" y1="6" x2="12" y2="6.01"/>
                <line x1="8" y1="10" x2="8" y2="10.01"/>
                <line x1="16" y1="10" x2="16" y2="10.01"/>
                <line x1="12" y1="10" x2="12" y2="10.01"/>
                <line x1="8" y1="14" x2="8" y2="14.01"/>
                <line x1="16" y1="14" x2="16" y2="14.01"/>
                <line x1="12" y1="14" x2="12" y2="14.01"/>
            </symbol>
            <symbol id="icon-document" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                <polyline points="14 2 14 8 20 8"/>
                <line x1="16" y1="13" x2="8" y2="13"/>
                <line x1="16" y1="17" x2="8" y2="17"/>
                <polyline points="10 9 9 9 8 9"/>
            </symbol>
            <symbol id="icon-calendar" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                <rect x="3" y="4" width="18" height="18" rx="2" ry="2"/>
                <line x1="16" y1="2" x2="16" y2="6"/>
                <line x1="8" y1="2" x2="8" y2="6"/>
                <line x1="3" y1="10" x2="21" y2="10"/>
            </symbol>
            <symbol id="icon-clock" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                <circle cx="12" cy="12" r="10"/>
                <polyline points="12 6 12 12 16 14"/>
            </symbol>
            <symbol id="icon-alert-triangle" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/>
                <line x1="12" y1="9" x2="12" y2="13"/>
                <line x1="12" y1="17" x2="12.01" y2="17"/>
            </symbol>
            <symbol id="icon-zap" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                <polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/>
            </symbol>
            <symbol id="icon-trophy" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                <path d="M6 9H4.5a2.5 2.5 0 0 1 0-5H6"/>
                <path d="M18 9h1.5a2.5 2.5 0 0 0 0-5H18"/>
                <path d="M4 22h16"/>
                <path d="M10 14.66V17c0 .55-.47.98-.97 1.21C7.85 18.75 7 20.24 7 22"/>
                <path d="M14 14.66V17c0 .55.47.98.97 1.21C16.15 18.75 17 20.24 17 22"/>
                <path d="M18 2H6v7a6 6 0 0 0 12 0V2Z"/>
            </symbol>
            <symbol id="icon-target" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                <circle cx="12" cy="12" r="10"/>
                <circle cx="12" cy="12" r="6"/>
                <circle cx="12" cy="12" r="2"/>
            </symbol>
            <symbol id="icon-chart" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                <line x1="18" y1="20" x2="18" y2="10"/>
                <line x1="12" y1="20" x2="12" y2="4"/>
                <line x1="6" y1="20" x2="6" y2="14"/>
            </symbol>
            <symbol id="icon-pie-chart" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                <path d="M21.21 15.89A10 10 0 1 1 8 2.83"/>
                <path d="M22 12A10 10 0 0 0 12 2v10z"/>
            </symbol>
            <symbol id="icon-compare" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                <rect x="3" y="3" width="7" height="9"/>
                <rect x="14" y="3" width="7" height="5"/>
                <rect x="14" y="12" width="7" height="9"/>
                <rect x="3" y="16" width="7" height="5"/>
            </symbol>
            <symbol id="icon-layers" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                <polygon points="12 2 2 7 12 12 22 7 12 2"/>
                <polyline points="2 17 12 22 22 17"/>
                <polyline points="2 12 12 17 22 12"/>
            </symbol>
            <symbol id="icon-grid" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                <rect x="3" y="3" width="7" height="7"/>
                <rect x="14" y="3" width="7" height="7"/>
                <rect x="14" y="14" width="7" height="7"/>
                <rect x="3" y="14" width="7" height="7"/>
            </symbol>
            <symbol id="icon-list" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                <line x1="8" y1="6" x2="21" y2="6"/>
                <line x1="8" y1="12" x2="21" y2="12"/>
                <line x1="8" y1="18" x2="21" y2="18"/>
                <line x1="3" y1="6" x2="3.01" y2="6"/>
                <line x1="3" y1="12" x2="3.01" y2="12"/>
                <line x1="3" y1="18" x2="3.01" y2="18"/>
            </symbol>
            <symbol id="icon-lock" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                <rect x="3" y="11" width="18" height="11" rx="2" ry="2"/>
                <path d="M7 11V7a5 5 0 0 1 10 0v4"/>
            </symbol>
            <symbol id="icon-unlock" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                <rect x="3" y="11" width="18" height="11" rx="2" ry="2"/>
                <path d="M7 11V7a5 5 0 0 1 9.9-1"/>
            </symbol>
            <symbol id="icon-copy" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                <rect x="9" y="9" width="13" height="13" rx="2" ry="2"/>
                <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/>
            </symbol>
            <symbol id="icon-mic" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                <path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"/>
                <path d="M19 10v2a7 7 0 0 1-14 0v-2"/>
                <line x1="12" y1="19" x2="12" y2="23"/>
                <line x1="8" y1="23" x2="16" y2="23"/>
            </symbol>
            <symbol id="icon-play" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                <polygon points="5 3 19 12 5 21 5 3"/>
            </symbol>
            <symbol id="icon-pause" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                <rect x="6" y="4" width="4" height="16"/>
                <rect x="14" y="4" width="4" height="16"/>
            </symbol>
            <symbol id="icon-brain" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                <path d="M9.5 2A2.5 2.5 0 0 1 12 4.5v15a2.5 2.5 0 0 1-4.96.44 2.5 2.5 0 0 1-2.96-3.08 3 3 0 0 1-.34-5.58 2.5 2.5 0 0 1 1.32-4.24 2.5 2.5 0 0 1 4.44-1.54"/>
                <path d="M14.5 2A2.5 2.5 0 0 0 12 4.5v15a2.5 2.5 0 0 0 4.96.44 2.5 2.5 0 0 0 2.96-3.08 3 3 0 0 0 .34-5.58 2.5 2.5 0 0 0-1.32-4.24 2.5 2.5 0 0 0-4.44-1.54"/>
            </symbol>
            <symbol id="icon-sparkles" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                <path d="m12 3-1.912 5.813a2 2 0 0 1-1.275 1.275L3 12l5.813 1.912a2 2 0 0 1 1.275 1.275L12 21l1.912-5.813a2 2 0 0 1 1.275-1.275L21 12l-5.813-1.912a2 2 0 0 1-1.275-1.275L12 3Z"/>
                <path d="M5 3v4"/>
                <path d="M19 17v4"/>
                <path d="M3 5h4"/>
                <path d="M17 19h4"/>
            </symbol>
            <symbol id="icon-bookmark" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                <path d="m19 21-7-4-7 4V5a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2v16z"/>
            </symbol>
            <symbol id="icon-tag" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                <path d="M12 2H2v10l9.29 9.29c.94.94 2.48.94 3.42 0l6.58-6.58c.94-.94.94-2.48 0-3.42L12 2Z"/>
                <path d="M7 7h.01"/>
            </symbol>
            <symbol id="icon-external-link" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"/>
                <polyline points="15 3 21 3 21 9"/>
                <line x1="10" y1="14" x2="21" y2="3"/>
            </symbol>
            <symbol id="icon-send" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                <line x1="22" y1="2" x2="11" y2="13"/>
                <polygon points="22 2 15 22 11 13 2 9 22 2"/>
            </symbol>
            <symbol id="icon-message" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/>
            </symbol>
            <symbol id="icon-bell" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                <path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"/>
                <path d="M13.73 21a2 2 0 0 1-3.46 0"/>
            </symbol>
            <symbol id="icon-arrow-left" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                <line x1="19" y1="12" x2="5" y2="12"/>
                <polyline points="12 19 5 12 12 5"/>
            </symbol>
            <symbol id="icon-arrow-right" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                <line x1="5" y1="12" x2="19" y2="12"/>
                <polyline points="12 5 19 12 12 19"/>
            </symbol>
            <symbol id="icon-trending-up" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                <polyline points="23 6 13.5 15.5 8.5 10.5 1 18"/>
                <polyline points="17 6 23 6 23 12"/>
            </symbol>
            <symbol id="icon-shield" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/>
            </symbol>
        </defs>
    </svg>

    <!-- Adobe Express-Style Sidebar Navigation -->
    <aside class="cav-sidebar" id="main-sidebar">
        <div class="cav-sidebar-header">
            <a href="/" class="cav-sidebar-logo">
                <div class="cav-sidebar-logo-icon">
                    <svg viewBox="0 0 32 32" fill="none">
                        <rect width="32" height="32" rx="8" fill="url(#logo-gradient)"/>
                        <path d="M10 22V10l6 12h2l6-12v12" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        <defs>
                            <linearGradient id="logo-gradient" x1="0" y1="0" x2="32" y2="32">
                                <stop stop-color="#e1306c"/>
                                <stop offset="1" stop-color="#ff6b9d"/>
                            </linearGradient>
                        </defs>
                    </svg>
                </div>
                <span class="cav-sidebar-logo-text">Creative Studio</span>
            </a>
            <button class="cav-sidebar-toggle" id="sidebar-toggle" title="Toggle sidebar">
                <svg class="cav-icon"><use href="#icon-menu"/></svg>
            </button>
        </div>

        <nav class="cav-sidebar-nav" id="main-nav" style="display: none;">
            <div class="cav-nav-section">
                <span class="cav-nav-section-label">Create</span>
                <button class="cav-nav-item active" id="nav-library" title="Asset Library">
                    <svg class="cav-icon"><use href="#icon-library"/></svg>
                    <span class="cav-nav-label">Library</span>
                </button>
                <button class="cav-nav-item" id="nav-analyze" title="Analyze - Creative Intelligence">
                    <svg class="cav-icon"><use href="#icon-analyze"/></svg>
                    <span class="cav-nav-label">Analyze</span>
                </button>
                <button class="cav-nav-item nav-highlight" id="nav-ai-studio" title="AI Studio">
                    <svg class="cav-icon"><use href="#icon-ai-studio"/></svg>
                    <span class="cav-nav-label">AI Studio</span>
                </button>
                <button class="cav-nav-item" id="nav-brand-kit" title="Brand Kit Generator">
                    <svg class="cav-icon"><use href="#icon-brand-kit"/></svg>
                    <span class="cav-nav-label">Brand Kit</span>
                </button>
            </div>

            <div class="cav-nav-section">
                <span class="cav-nav-section-label">Plan</span>
                <button class="cav-nav-item" id="nav-strategy" title="Strategy - Deployment Planning">
                    <svg class="cav-icon"><use href="#icon-strategy"/></svg>
                    <span class="cav-nav-label">Strategy</span>
                </button>
                <button class="cav-nav-item" id="nav-learn" title="Learn - Knowledge Intelligence">
                    <svg class="cav-icon"><use href="#icon-learn"/></svg>
                    <span class="cav-nav-label">Learn</span>
                </button>
                <button class="cav-nav-item" id="nav-crm" title="CRM">
                    <svg class="cav-icon"><use href="#icon-crm"/></svg>
                    <span class="cav-nav-label">CRM</span>
                </button>
            </div>

            <div class="cav-nav-section">
                <span class="cav-nav-section-label">Manage</span>
                <button class="cav-nav-item" id="nav-integrations" title="Integrations">
                    <svg class="cav-icon"><use href="#icon-integrations"/></svg>
                    <span class="cav-nav-label">Integrations</span>
                </button>
                <button class="cav-nav-item" id="nav-usage" title="Usage & Stats">
                    <svg class="cav-icon"><use href="#icon-usage"/></svg>
                    <span class="cav-nav-label">Usage</span>
                </button>
            </div>

            <div class="cav-nav-spacer"></div>

            <div class="cav-nav-section cav-nav-bottom">
                <button class="cav-nav-item" id="nav-settings" title="Settings - API Keys & Configuration">
                    <svg class="cav-icon"><use href="#icon-settings"/></svg>
                    <span class="cav-nav-label">Settings</span>
                </button>
                <button class="cav-nav-item" id="admin-btn-sidebar" title="Admin Panel" style="display: none;">
                    <svg class="cav-icon"><use href="#icon-admin"/></svg>
                    <span class="cav-nav-label">Admin</span>
                </button>
            </div>
        </nav>

        <div class="cav-sidebar-footer">
            <div class="cav-sidebar-user" id="sidebar-user-info" style="display: none;">
                <img id="sidebar-user-avatar" class="cav-sidebar-avatar" src="" alt="Avatar">
                <div class="cav-sidebar-user-details">
                    <div id="sidebar-user-name" class="cav-sidebar-user-name"></div>
                    <div id="sidebar-user-type" class="cav-sidebar-user-type"></div>
                </div>
            </div>
            <div class="cav-sidebar-actions">
                <button id="theme-toggle" class="cav-sidebar-action-btn" title="Toggle theme">
                    <svg class="cav-icon cav-icon-sun"><use href="#icon-sun"/></svg>
                    <svg class="cav-icon cav-icon-moon"><use href="#icon-moon"/></svg>
                </button>
                <button id="logout-btn" class="cav-sidebar-action-btn cav-logout-btn" title="Logout" style="display: none;">
                    <svg class="cav-icon"><use href="#icon-logout"/></svg>
                </button>
            </div>
        </div>
    </aside>

    <!-- Top Header Bar (Minimal) -->
    <header class="cav-topbar" id="topbar">
        <div class="cav-topbar-left">
            <button class="cav-mobile-menu-btn" id="mobile-menu-btn" title="Menu">
                <svg class="cav-icon"><use href="#icon-menu"/></svg>
            </button>
            <div class="cav-topbar-search">
                <svg class="cav-icon"><use href="#icon-search"/></svg>
                <input type="text" placeholder="Search assets, analyses, companies..." class="cav-topbar-search-input" id="global-search">
            </div>
        </div>
        <div class="cav-topbar-actions">
            <div class="cav-topbar-user" id="topbar-user-info" style="display: none;">
                <img id="user-avatar" class="cav-topbar-avatar" src="" alt="Avatar">
                <div class="cav-topbar-user-details">
                    <div id="user-name" class="cav-topbar-user-name"></div>
                    <div id="user-type" class="cav-topbar-user-type"></div>
                </div>
            </div>
            <button id="admin-btn" class="cav-topbar-btn admin-btn" style="display: none;">
                <svg class="cav-icon"><use href="#icon-admin"/></svg>
            </button>
        </div>
    </header>
    
    <!-- Mobile Sidebar Overlay -->
    <div class="cav-sidebar-overlay" id="sidebar-overlay"></div>

    <!-- Main App -->
    <main id="creative-asset-validator-root">
        <div class="cav-loading-container">
            <div class="cav-spinner"></div>
            <p>Loading Asset Validator...</p>
        </div>
    </main>

    <!-- Footer - Simplified (navigation now in sidebar) -->
    <footer class="site-footer">
        <p>Creative Asset Validator v5.1.0 ‚Ä¢ Creative Intelligence Platform</p>
        <p style="margin-top: 0.5rem; font-size: 0.75rem;">
            <a href="#" id="clear-data-link">Clear My Data</a>
        </p>
        <!-- Hidden links for backwards compatibility -->
        <a href="#" id="crm-link" style="display:none;"></a>
        <a href="#" id="integrations-link" style="display:none;"></a>
        <a href="#" id="ai-studio-link" style="display:none;"></a>
        <a href="#" id="ai-settings-link" style="display:none;"></a>
    </footer>

    <!-- EARLY DEV SESSION CREATION - Must run BEFORE module scripts load -->
    <script>
    (function() {
        // Create dev session SYNCHRONOUSLY before any modules initialize
        const urlParams = new URLSearchParams(window.location.search);
        if (urlParams.get('dev') === '1') {
            console.log('[CAV Auth] EARLY DEV MODE - Creating session before modules load');
            const devEmail = window.AUTH_CONFIG?.ADMIN_EMAILS?.[0] || 'dev@localhost';
            window.cavUserSession = {
                email: devEmail,
                name: 'Developer',
                picture: '',
                role: 'admin',
                isSuperAdmin: true,
                isAdmin: true,
                domain: 'itallstartedwithaidea.com',
                isAuthenticated: true,
                loginTime: Date.now()
            };
            console.log('[CAV Auth] EARLY DEV SESSION READY:', window.cavUserSession.email);
            
            // AGGRESSIVELY hide login modal via CSS injection
            const hideStyle = document.createElement('style');
            hideStyle.id = 'dev-mode-hide-login';
            hideStyle.textContent = `
                #login-modal, .cav-login-modal, .login-modal, 
                [class*="login-modal"], [id*="login-modal"] {
                    display: none !important;
                    visibility: hidden !important;
                    opacity: 0 !important;
                    pointer-events: none !important;
                    position: absolute !important;
                    left: -9999px !important;
                }
            `;
            document.head.appendChild(hideStyle);
            console.log('[CAV Auth] EARLY DEV MODE - Login modal CSS hidden');
            
            // Also try to hide the element directly if it exists yet
            const loginModal = document.getElementById('login-modal');
            if (loginModal) {
                loginModal.style.cssText = 'display: none !important; visibility: hidden !important;';
                loginModal.classList.add('hidden');
                console.log('[CAV Auth] EARLY DEV MODE - Login modal element hidden directly');
            }
            
            // And hide it again when DOM is ready
            document.addEventListener('DOMContentLoaded', function() {
                const modal = document.getElementById('login-modal');
                if (modal) {
                    modal.style.cssText = 'display: none !important; visibility: hidden !important;';
                    modal.classList.add('hidden');
                    console.log('[CAV Auth] EARLY DEV MODE - Login modal hidden on DOMContentLoaded');
                }
            });
        }
    })();
    </script>

    <!-- Main Application Script v5.0.0 - SaaS Edition with MySQL Sync -->
    <script src="validator-app.js?v=5.1.0"></script>
    
    <!-- AI Asset Adapter (Google AI Studio Integration) -->
    <script src="ai-adapter.js?v=5.1.0"></script>
    
    <!-- Internal CRM Module -->
    <script src="crm.js?v=5.1.0"></script>
    
    <!-- Integration Hub (Google Drive, OneDrive, Gmail, etc.) -->
    <script src="integrations.js?v=5.1.0"></script>
    
    <!-- Auto-Fix Workflow -->
    <script src="auto-fix.js?v=5.1.0"></script>
    
    <!-- AI Studio Interface (Nano Banana Pro + Veo 3.1 style) -->
    <script src="ai-studio.js?v=5.1.0"></script>
    
    <!-- Brand Kit Generator (Logo Generator / Nano Banana) -->
    <script src="logo-generator.js?v=5.1.0"></script>
    
    <!-- AI Library Manager (Session-based storage, CRM integration) -->
    <script src="ai-library-manager.js?v=5.1.0"></script>
    
    <!-- AI Library Integration (adds AI buttons to asset cards) v3.0.0 -->
    <script src="ai-library-integration.js?v=5.1.0"></script>
    
    <!-- Advanced Features (Queue, Batch, Pagination, Folders, Reports, Versioning) -->
    <script src="advanced-features.js?v=5.1.0"></script>
    
    <!-- Advanced Toolbar (Quick access to all features) -->
    <script src="advanced-toolbar.js?v=5.1.0"></script>
    
    <!-- ===== v3.0 CREATIVE INTELLIGENCE MODULES ===== -->
    
    <!-- Data Models - Extended v3.0 schemas -->
    <script src="data-models.js?v=5.1.0"></script>
    
    <!-- Settings Module - API key management + Super Admin Platform Settings -->
    <script src="settings-module.js?v=5.1.0"></script>
    
    <!-- AI Orchestrator - Multi-AI task routing with GPT-5.2 & Claude 4.5 -->
    <script src="ai-orchestrator.js?v=5.1.0"></script>
    
    <!-- AI Intelligence Engine - Chained Analysis Pipeline (GPT-5.2‚ÜíSearchAPI‚ÜíClaude 4.5) -->
    <script src="ai-intelligence-engine.js?v=5.1.0"></script>
    
    <!-- Analyze Module - Hook, CTA, Brand, Audio, Thumb-Stop, Predictions -->
    <!-- v4.0: Advanced chained analysis, brand guidelines, audience personas -->
    <script src="analyze-module.js?v=5.1.0"></script>
    
    <!-- Strategy Module - Placement Matrix, Roadmap, Budget, A/B, Fatigue -->
    <!-- v4.0: Advanced strategy, brand context, competitor comparison -->
    <script src="strategy-module.js?v=5.1.0"></script>
    
    <!-- Learn Module - URL Analyzer, Competitors, Benchmarks, Swipe File -->
    <!-- v4.0: Competitor creative comparison, industry benchmarks, compliance checking -->
    <script src="learn-module.js?v=5.1.0"></script>
    
    <!-- Security Core Module (must load first) -->
    <script src="security-core.js?v=5.1.0"></script>
    
    <!-- Auth Configuration -->
    <script src="auth-config.js?v=5.1.0"></script>
    
    <!-- SaaS Backend Integration (MySQL Sync + Cloudinary) v5.0.0 -->
    <script src="sync-engine.js?v=5.1.0"></script>
    <script src="cloudinary-client.js?v=5.1.0"></script>
    
    <!-- Initialize SaaS components after auth -->
    <script>
        // Initialize sync engine and cloudinary client when app loads
        document.addEventListener('DOMContentLoaded', () => {
            // Set API base path
            const apiBase = window.location.pathname.includes('/tools/') 
                ? window.location.pathname.replace(/\/[^\/]*$/, '') + '/api'
                : '/api';
            
            // Initialize SyncEngine
            window.syncEngine = new SyncEngine({ apiBase: apiBase });
            
            // Initialize Cloudinary Client
            window.cloudinaryClient = new CloudinaryClient({ 
                apiBase: apiBase,
                syncEngine: window.syncEngine 
            });
            
            // Check for stored session token
            const storedToken = localStorage.getItem('cav_session_token');
            if (storedToken) {
                window.syncEngine.setSessionToken(storedToken);
                console.log('[SaaS] Restored session, sync enabled');
            }
            
            // Listen for authentication events
            window.syncEngine.on('authenticated', (user) => {
                console.log('[SaaS] User authenticated:', user.email);
                window.cloudinaryClient.getQuota().then(quota => {
                    console.log('[SaaS] User quota:', quota);
                });
            });
            
            window.syncEngine.on('sync_complete', (result) => {
                console.log('[SaaS] Sync complete:', result.pulled, 'pulled,', result.pushed, 'pushed');
            });
            
            console.log('[SaaS] v5.0.0 initialized with MySQL sync + Cloudinary');
        });
    </script>
    
    <!-- Authentication & Admin System (v3.0 - Enterprise Security) -->
    <script>
    (function() {
        'use strict';

        // =============================================
        // VERSION & SECURITY INFO
        // =============================================
        const AUTH_VERSION = '3.0.0';
        console.log('[CAV Auth] Version:', AUTH_VERSION, '- Enterprise Security Edition');

        // =============================================
        // STORAGE KEYS (use security-core keys for encrypted storage)
        // =============================================
        const STORAGE_KEYS = window.CAVSecurity?.SECURE_KEYS || {
            SESSION: 'cav_secure_session_v3',
            ACTIVITY: 'cav_activity_log_v3',
            USERS: 'cav_managed_users_v3',
            SETTINGS: 'cav_admin_settings_v3',
            WHITELIST_REQUESTS: 'cav_whitelist_requests_v3'
        };

        // =============================================
        // DEFAULT SETTINGS - SECURITY ENFORCED
        // =============================================
        const DEFAULT_SETTINGS = {
            teamSharingEnabled: true,
            personalUsersEnabled: false,  // LOCKED: Personal emails blocked by default
            requireApproval: false,
            defaultRole: 'editor',
            corporateDomains: window.AUTH_CONFIG?.CORPORATE_DOMAINS || [],
            adminEmails: window.AUTH_CONFIG?.ADMIN_EMAILS || [],
            whitelistedEmails: [],
            blockedEmails: [],
            blockedDomains: [],
            sessionDurationDays: 30,
            enforceDeviceBinding: true
        };

        // Personal email domains that are BLOCKED by default
        const PERSONAL_EMAIL_DOMAINS = window.CAVSecurity?.PERSONAL_EMAIL_DOMAINS || [
            'gmail.com', 'googlemail.com',
            'hotmail.com', 'outlook.com', 'live.com', 'msn.com', 'hotmail.co.uk',
            'yahoo.com', 'yahoo.co.uk', 'ymail.com', 'rocketmail.com',
            'aol.com', 'protonmail.com', 'proton.me',
            'icloud.com', 'me.com', 'mac.com',
            'mail.com', 'zoho.com', 'gmx.com', 'gmx.de', 'gmx.net',
            'yandex.com', 'yandex.ru',
            'fastmail.com', 'tutanota.com',
            'qq.com', '163.com', '126.com',
            'mailinator.com', 'guerrillamail.com', 'tempmail.com'
        ];

        // =============================================
        // EARLY SESSION INITIALIZATION (Secure)
        // Waits for security module then restores session
        // =============================================
        let securityReady = false;
        let pendingSessionRestore = null;

        async function initSecureSession() {
            try {
                // Wait for security module
                if (!window.CAVSecurity) {
                    console.log('[CAV Auth] Waiting for security module...');
                    await new Promise(resolve => setTimeout(resolve, 100));
                    if (!window.CAVSecurity) {
                        console.error('[CAV Auth] Security module not loaded!');
                        return null;
                    }
                }

                // Initialize security
                await window.CAVSecurity.init();
                securityReady = true;

                // Restore session from encrypted storage
                const session = window.CAVSecurity.SecureSessionManager.getSession();
                
                if (session && session.email) {
                    // Validate session hasn't expired
                    if (Date.now() > session.expiresAt) {
                        console.log('[CAV Auth] Session expired, clearing...');
                        window.CAVSecurity.SecureSessionManager.clearSession();
                        return null;
                    }

                    // Recalculate permissions (in case settings changed)
                    const email = session.email.toLowerCase();
                    const domain = email.split('@')[1] || '';
                    const settings = getSettings();
                    
                    const adminEmails = (settings.adminEmails || []).map(e => e.toLowerCase());
                    const isAdmin = adminEmails.includes(email);
                    const role = isAdmin ? 'admin' : (session.role || settings.defaultRole || 'editor');
                    
                    const corporateDomains = (settings.corporateDomains || []).map(d => d.toLowerCase());
                    let userType = 'corporate';
                    if (isAdmin) userType = 'admin';
                    else if (corporateDomains.includes(domain)) userType = 'corporate';
                    else if (PERSONAL_EMAIL_DOMAINS.includes(domain)) userType = 'personal';
                    
                    const canUploadPerm = role === 'admin' || role === 'editor';
                    const canEditPerm = role === 'admin' || role === 'editor';
                    const canDeletePerm = role === 'admin';
                    const canManageUsersPerm = role === 'admin';
                    const canAccessTeamPerm = userType === 'admin' || userType === 'corporate' || role === 'admin' || role === 'editor';
                    
                    // Set the full session with permissions
                    window.cavUserSession = {
                        ...session,
                        role: role,
                        userType: userType,
                        canAccessTeam: canAccessTeamPerm,
                        permissions: {
                            canUpload: canUploadPerm,
                            canEdit: canEditPerm,
                            canDelete: canDeletePerm,
                            canManageUsers: canManageUsersPerm,
                            canAccessTeam: canAccessTeamPerm
                        }
                    };
                    
                    console.log('[CAV Auth] Secure session restored:', session.email, 
                        'Role:', role, 
                        'Session ID:', session.id?.substring(0, 20) + '...',
                        'Expires:', new Date(session.expiresAt).toLocaleString());
                    
                    return window.cavUserSession;
                }
                
                return null;
            } catch (e) {
                console.error('[CAV Auth] Failed to initialize secure session:', e);
                return null;
            }
        }

        // Start secure session initialization immediately and wait for it
        pendingSessionRestore = initSecureSession().then(session => {
            // If session was restored, update UI immediately
            if (session) {
                window.cavUserSession = session;
                console.log('[CAV Auth] Early session ready for UI');
            }
            return session;
        });

        // =============================================
        // CONFIGURATION
        // =============================================
        function getConfig() {
            const settings = getSettings();
            return {
                GOOGLE_CLIENT_ID: window.AUTH_CONFIG?.GOOGLE_CLIENT_ID || 'YOUR_GOOGLE_CLIENT_ID.apps.googleusercontent.com',
                ADMIN_EMAILS: settings.adminEmails,
                CORPORATE_DOMAINS: settings.corporateDomains,
                PERSONAL_DOMAINS: [
                    'gmail.com', 'googlemail.com',
                    'hotmail.com', 'outlook.com', 'live.com', 'msn.com',
                    'yahoo.com', 'ymail.com',
                    'aol.com', 'protonmail.com', 'icloud.com', 'me.com',
                    'mail.com', 'zoho.com', 'gmx.com'
                ]
            };
        }

        // =============================================
        // SETTINGS MANAGEMENT
        // =============================================
        function getSettings() {
            try {
                const saved = JSON.parse(localStorage.getItem(STORAGE_KEYS.SETTINGS));
                return { ...DEFAULT_SETTINGS, ...saved };
            } catch {
                return { ...DEFAULT_SETTINGS };
            }
        }

        function saveSettings(settings) {
            localStorage.setItem(STORAGE_KEYS.SETTINGS, JSON.stringify(settings));
        }

        // =============================================
        // USER MANAGEMENT
        // =============================================
        function getManagedUsers() {
            try {
                return JSON.parse(localStorage.getItem(STORAGE_KEYS.USERS) || '{}');
            } catch {
                return {};
            }
        }

        function saveManagedUsers(users) {
            localStorage.setItem(STORAGE_KEYS.USERS, JSON.stringify(users));
        }

        function getManagedUser(email) {
            const users = getManagedUsers();
            return users[email.toLowerCase()] || null;
        }

        function setManagedUser(email, userData) {
            const users = getManagedUsers();
            users[email.toLowerCase()] = {
                ...userData,
                email: email.toLowerCase(),
                updatedAt: new Date().toISOString()
            };
            saveManagedUsers(users);
            return users[email.toLowerCase()];
        }

        function removeManagedUser(email) {
            const users = getManagedUsers();
            delete users[email.toLowerCase()];
            saveManagedUsers(users);
        }

        // =============================================
        // SESSION MANAGEMENT
        // =============================================
        function getSession() {
            try {
                // Check secure session first (primary method)
                if (window.CAVSecurity?.SecureSessionManager) {
                    const secureSession = window.CAVSecurity.SecureSessionManager.getSession();
                    if (secureSession && secureSession.email) {
                        return secureSession;
                    }
                }
                
                // Check global session variable
                if (window.cavUserSession && window.cavUserSession.email) {
                    return window.cavUserSession;
                }
                
                // Fallback to legacy localStorage session
                return JSON.parse(localStorage.getItem(STORAGE_KEYS.SESSION));
            } catch {
                return null;
            }
        }
        
        // Global auth check - Returns true if logged in, shows login prompt if not
        // ONLY shows warning when NOT logged in
        function requireAuth(actionName = 'this feature') {
            // Check secure session first
            const secureSession = window.CAVSecurity?.SecureSessionManager?.getSession();
            if (secureSession && secureSession.email) {
                return true; // User is logged in via secure session
            }
            
            // Check legacy session
            const legacySession = window.cavUserSession || getSession();
            if (legacySession && legacySession.email) {
                return true; // User is logged in via legacy session
            }
            
            // Not logged in - show login prompt
            showLoginRequiredModal(actionName);
            return false;
        }
        
        // Show login required modal for non-authenticated users
        function showLoginRequiredModal(actionName) {
            // Remove any existing modal
            const existing = document.querySelector('.auth-required-modal');
            if (existing) existing.remove();
            
            const modal = document.createElement('div');
            modal.className = 'auth-required-modal';
            modal.style.cssText = 'position:fixed;inset:0;z-index:100001;display:flex;align-items:center;justify-content:center;background:rgba(0,0,0,0.85);backdrop-filter:blur(8px);';
            modal.innerHTML = `
                <div style="background:linear-gradient(135deg,#1a1a1a 0%,#2d2d2d 100%);border-radius:16px;padding:2rem;max-width:400px;width:90%;text-align:center;border:1px solid rgba(255,255,255,0.1);box-shadow:0 25px 50px rgba(0,0,0,0.5);">
                    <div style="font-size:3rem;margin-bottom:1rem;">üîê</div>
                    <h2 style="color:#fff;margin:0 0 0.5rem;font-size:1.5rem;">Sign In Required</h2>
                    <p style="color:#a1a1aa;margin:0 0 1.5rem;font-size:0.95rem;">
                        Please sign in with your corporate email to access ${actionName}.
                    </p>
                    <div style="display:flex;flex-direction:column;gap:0.75rem;">
                        <button onclick="this.closest('.auth-required-modal').remove();document.getElementById('google-signin-btn')?.click();" 
                                style="background:linear-gradient(135deg,#ec4899 0%,#a855f7 100%);border:none;padding:0.875rem 1.5rem;border-radius:8px;color:#fff;font-weight:600;cursor:pointer;font-size:1rem;">
                            Sign In with Google
                        </button>
                        <button onclick="this.closest('.auth-required-modal').remove();" 
                                style="background:none;border:1px solid rgba(255,255,255,0.2);padding:0.75rem 1.5rem;border-radius:8px;color:#888;cursor:pointer;">
                            Cancel
                        </button>
                    </div>
                    <p style="color:#6b7280;font-size:0.8rem;margin-top:1.5rem;">
                        Need access? Contact <strong style="color:#ec4899;">your administrator</strong>
                    </p>
                </div>
            `;
            document.body.appendChild(modal);
            
            // Close on background click
            modal.addEventListener('click', (e) => {
                if (e.target === modal) modal.remove();
            });
        }
        
        // Expose requireAuth globally for other modules to use
        window.requireAuth = requireAuth;
        
        // Expose user management functions for settings module
        window.getManagedUsers = getManagedUsers;
        window.getManagedUser = getManagedUser;
        window.setManagedUser = setManagedUser;

        function setSession(userData) {
            const session = {
                ...userData,
                loginTime: new Date().toISOString(),
                lastActivity: new Date().toISOString()
            };
            localStorage.setItem(STORAGE_KEYS.SESSION, JSON.stringify(session));
            logActivity('login', userData);
            return session;
        }

        function clearSession() {
            const session = getSession();
            if (session) {
                logActivity('logout', session);
            }
            localStorage.removeItem(STORAGE_KEYS.SESSION);
        }

        function updateActivity() {
            const session = getSession();
            if (session) {
                session.lastActivity = new Date().toISOString();
                localStorage.setItem(STORAGE_KEYS.SESSION, JSON.stringify(session));
            }
        }

        // =============================================
        // ACTIVITY LOGGING
        // =============================================
        function logActivity(action, userData, details = {}) {
            try {
                const activities = JSON.parse(localStorage.getItem(STORAGE_KEYS.ACTIVITY) || '[]');
                activities.push({
                    action,
                    email: userData.email,
                    name: userData.name,
                    userType: userData.userType,
                    role: userData.role,
                    timestamp: new Date().toISOString(),
                    userAgent: navigator.userAgent,
                    details
                });
                // Keep last 1000 activities
                if (activities.length > 1000) {
                    activities.splice(0, activities.length - 1000);
                }
                localStorage.setItem(STORAGE_KEYS.ACTIVITY, JSON.stringify(activities));
            } catch (e) {
                console.warn('Failed to log activity:', e);
            }
        }

        function getActivityLog() {
            try {
                return JSON.parse(localStorage.getItem(STORAGE_KEYS.ACTIVITY) || '[]');
            } catch {
                return [];
            }
        }

        // =============================================
        // USER TYPE & ROLE DETECTION
        // =============================================
        function getEmailDomain(email) {
            return email.split('@')[1]?.toLowerCase() || '';
        }

        function isAdminEmail(email) {
            const settings = getSettings();
            return settings.adminEmails.map(e => e.toLowerCase()).includes(email.toLowerCase());
        }

        function isCorporateDomain(domain) {
            const settings = getSettings();
            return settings.corporateDomains.map(d => d.toLowerCase()).includes(domain.toLowerCase());
        }

        function isPersonalDomain(domain) {
            const config = getConfig();
            return config.PERSONAL_DOMAINS.includes(domain.toLowerCase());
        }

        function isBlocked(email) {
            const settings = getSettings();
            const domain = getEmailDomain(email);
            const blockedEmails = [...(settings.blockedEmails || []), ...(window.AUTH_CONFIG?.BLOCKED_EMAILS || [])];
            const blockedDomains = [...(settings.blockedDomains || []), ...(window.AUTH_CONFIG?.BLOCKED_DOMAINS || [])];
            return blockedEmails.map(e => e.toLowerCase()).includes(email.toLowerCase()) ||
                   blockedDomains.map(d => d.toLowerCase()).includes(domain.toLowerCase());
        }
        
        function isWhitelisted(email) {
            const whitelistedEmails = window.AUTH_CONFIG?.WHITELISTED_EMAILS || [];
            return whitelistedEmails.map(e => e.toLowerCase()).includes(email.toLowerCase());
        }

        function getUserType(email) {
            const domain = getEmailDomain(email);
            
            if (isAdminEmail(email)) {
                return 'admin';
            }
            if (isCorporateDomain(domain)) {
                return 'corporate';
            }
            if (isPersonalDomain(domain)) {
                return 'personal';
            }
            // Unknown domain - treat as corporate
            return 'corporate';
        }

        function getUserRole(email) {
            // Check if user has a managed role
            const managedUser = getManagedUser(email);
            if (managedUser && managedUser.role) {
                return managedUser.role;
            }
            
            // Admin emails always get admin role
            if (isAdminEmail(email)) {
                return 'admin';
            }
            
            // Default role from settings
            const settings = getSettings();
            return settings.defaultRole || 'viewer';
        }

        function canAccessTeam(userType, role) {
            const settings = getSettings();
            if (!settings.teamSharingEnabled) return false;
            return userType === 'admin' || userType === 'corporate' || role === 'admin' || role === 'editor';
        }

        function canUpload(role) {
            return role === 'admin' || role === 'editor';
        }

        function canEdit(role) {
            return role === 'admin' || role === 'editor';
        }

        function canDelete(role) {
            return role === 'admin';
        }

        function canManageUsers(role) {
            return role === 'admin';
        }

        // =============================================
        // UI ELEMENTS (lazy-loaded to ensure DOM is ready)
        // =============================================
        function getElements() {
            // Always get fresh elements - don't cache as DOM might not be ready initially
            return {
                loginModal: document.getElementById('login-modal'),
                userAvatar: document.getElementById('user-avatar'),
                userName: document.getElementById('user-name'),
                userType: document.getElementById('user-type'),
                adminBtn: document.getElementById('admin-btn'),
                logoutBtn: document.getElementById('logout-btn'),
                clearDataLink: document.getElementById('clear-data-link')
            };
        }

        // =============================================
        // UI UPDATES
        // =============================================
        function updateUI(session) {
            const el = getElements();
            if (!el.loginModal) {
                console.warn('[CAV] Login modal not found yet, retrying...');
                setTimeout(() => updateUI(session), 100);
                return;
            }
            
            if (session) {
                // Hide login modal with both class AND inline style for reliability
                el.loginModal.classList.add('hidden');
                el.loginModal.style.display = 'none';
                console.log('[CAV] Login modal hidden, classList:', el.loginModal.className);
                
                // Update topbar user info
                if (session.picture && el.userAvatar) {
                    el.userAvatar.src = session.picture;
                    el.userAvatar.style.display = 'block';
                }
                if (el.userName) el.userName.textContent = session.name;
                
                const typeLabels = {
                    admin: 'üëë Admin',
                    corporate: 'Corporate',
                    personal: 'üë§ Personal'
                };
                const roleLabels = {
                    admin: ' (Admin)',
                    editor: ' (Editor)',
                    viewer: ' (Viewer)'
                };
                if (el.userType) {
                    el.userType.textContent = (typeLabels[session.userType] || session.userType) + 
                        (session.role !== session.userType ? (roleLabels[session.role] || '') : '');
                    el.userType.className = `user-type ${session.userType}`;
                }
                
                // Update sidebar user info
                const sidebarAvatar = document.getElementById('sidebar-user-avatar');
                const sidebarName = document.getElementById('sidebar-user-name');
                const sidebarType = document.getElementById('sidebar-user-type');
                const sidebarUserInfo = document.getElementById('sidebar-user-info');
                const topbarUserInfo = document.getElementById('topbar-user-info');
                
                if (sidebarAvatar) {
                    if (session.picture) {
                        sidebarAvatar.src = session.picture;
                        sidebarAvatar.style.display = 'block';
                    } else {
                        // Generate initials avatar as fallback
                        const initials = (session.name || 'U').split(' ').map(n => n[0]).join('').toUpperCase().slice(0, 2);
                        sidebarAvatar.src = `data:image/svg+xml,${encodeURIComponent(`<svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 32 32"><rect fill="%23e1306c" width="32" height="32" rx="16"/><text x="16" y="20" font-family="system-ui" font-size="14" fill="white" text-anchor="middle">${initials}</text></svg>`)}`;
                        sidebarAvatar.style.display = 'block';
                    }
                }
                if (sidebarName) sidebarName.textContent = session.name;
                if (sidebarType) sidebarType.textContent = session.userType;
                if (sidebarUserInfo) sidebarUserInfo.style.display = 'flex';
                if (topbarUserInfo) topbarUserInfo.style.display = 'flex';
                
                // Show admin button for admins
                if (el.adminBtn) el.adminBtn.style.display = session.role === 'admin' ? 'block' : 'none';
                if (el.logoutBtn) el.logoutBtn.style.display = 'block';
                
                // Show sidebar admin button
                const sidebarAdminBtn = document.getElementById('admin-btn-sidebar');
                if (sidebarAdminBtn) {
                    sidebarAdminBtn.style.display = session.role === 'admin' ? 'flex' : 'none';
                }
                
                // Show main navigation
                const mainNav = document.getElementById('main-nav');
                if (mainNav) mainNav.style.display = 'flex';
                
                // Initialize navigation event listeners (only once)
                if (!window.navInitialized) {
                    initNavigation();
                    window.navInitialized = true;
                }
                
                // Expose session and permissions to validator app
                window.cavUserSession = {
                    ...session,
                    permissions: {
                        canUpload: canUpload(session.role),
                        canEdit: canEdit(session.role),
                        canDelete: canDelete(session.role),
                        canManageUsers: canManageUsers(session.role),
                        canAccessTeam: session.canAccessTeam
                    }
                };
                
                console.log('[CAV] UI updated for logged-in user:', session.name);
                
            } else {
                // Show login modal
                el.loginModal.classList.remove('hidden');
                el.loginModal.style.display = 'flex';
                if (el.userAvatar) el.userAvatar.style.display = 'none';
                if (el.userName) el.userName.textContent = '';
                if (el.userType) el.userType.textContent = '';
                if (el.adminBtn) el.adminBtn.style.display = 'none';
                if (el.logoutBtn) el.logoutBtn.style.display = 'none';
                window.cavUserSession = null;
            }
        }

        // =============================================
        // GOOGLE SIGN-IN (SSO ONLY - NO DEMO MODE)
        // =============================================
        let googleSignInAttempted = false;
        let googleSignInTimeout = null;
        let originErrorDetected = false;
        let popupCheckTimeout = null;
        
        function initGoogleSignIn() {
            const config = getConfig();
            
            // Check if Google Client ID is configured
            if (config.GOOGLE_CLIENT_ID === 'YOUR_GOOGLE_CLIENT_ID.apps.googleusercontent.com' || 
                !config.GOOGLE_CLIENT_ID || 
                config.GOOGLE_CLIENT_ID.includes('YOUR_')) {
                console.error('[CAV] Google Client ID not configured!');
                showConfigurationError();
                return;
            }

            // Set a timeout - if Google doesn't respond in 8 seconds, show error
            googleSignInTimeout = setTimeout(() => {
                if (!googleSignInAttempted) {
                    console.warn('[CAV] Google Sign-In taking too long');
                    showGoogleSignInError();
                }
            }, 8000);

            // Initialize real Google Sign-In
            try {
                if (typeof google === 'undefined' || !google.accounts || !google.accounts.id) {
                    console.warn('[CAV] Google Sign-In API not loaded yet, retrying...');
                    // Retry after a short delay
                    setTimeout(initGoogleSignIn, 1000);
                    return;
                }
                
                // Standard GSI popup mode - works in Chrome, Firefox, Safari
                // Only requires JavaScript Origins (not Redirect URIs)
                google.accounts.id.initialize({
                    client_id: config.GOOGLE_CLIENT_ID,
                    callback: handleGoogleResponse,
                    auto_select: false,
                    cancel_on_tap_outside: true,
                    itp_support: true
                });
                
                console.log('[CAV] Google Sign-In initialized (popup mode)');

                const container = document.getElementById('google-signin-container');
                if (container) {
                    google.accounts.id.renderButton(
                        container,
                        { 
                            theme: 'outline', 
                            size: 'large',
                            text: 'signin_with',
                            shape: 'rectangular',
                            logo_alignment: 'left',
                            width: 280
                        }
                    );
                    
                    // Mark as successful
                    googleSignInAttempted = true;
                    clearTimeout(googleSignInTimeout);
                    console.log('[CAV] Google Sign-In button rendered successfully');
                    
                    // Show help link after 3 seconds
                    setTimeout(() => {
                        const helpLink = document.getElementById('signin-help-link');
                        if (helpLink) helpLink.style.display = 'block';
                    }, 3000);
                    
                    // Add click listener to detect popup failures
                    setTimeout(() => {
                        const gsiButton = container.querySelector('iframe, div[role="button"]');
                        if (gsiButton) {
                            container.addEventListener('click', () => {
                                // If clicked and no popup after 3 seconds, likely origin issue
                                popupCheckTimeout = setTimeout(() => {
                                    // Check if we're still on the same page (no popup succeeded)
                                    const session = getSession();
                                    if (!session) {
                                        console.warn('[CAV] Sign-in popup may have been blocked or origin not authorized');
                                        showOriginHelpMessage();
                                    }
                                }, 3000);
                            }, { once: true });
                        }
                    }, 500);
                }
            } catch (error) {
                console.error('[CAV] Google Sign-In initialization failed:', error);
                clearTimeout(googleSignInTimeout);
                showGoogleSignInError();
            }
        }
        
        // Show helpful message if popup seems to fail
        function showOriginHelpMessage() {
            const container = document.getElementById('google-signin-container');
            if (!container) return;
            
            // Don't replace if already showing error
            if (container.querySelector('.origin-help-message')) return;
            
            const currentOrigin = window.location.origin;
            
            const helpDiv = document.createElement('div');
            helpDiv.className = 'origin-help-message';
            helpDiv.style.cssText = 'margin-top: 1rem; padding: 1rem; background: rgba(251,191,36,0.15); border-radius: 8px; border: 1px solid rgba(251,191,36,0.3);';
            helpDiv.innerHTML = `
                <p style="color: #fbbf24; margin: 0 0 0.5rem; font-weight: 600; font-size: 0.9rem;">‚ö†Ô∏è Sign-in not working?</p>
                <p style="color: #d1d5db; margin: 0 0 0.75rem; font-size: 0.8rem; line-height: 1.5;">
                    Your domain <code style="background: rgba(168,85,247,0.2); padding: 2px 6px; border-radius: 4px; color: #c4b5fd;">${currentOrigin}</code> 
                    may not be authorized in Google Cloud Console.
                </p>
                <a href="https://console.cloud.google.com/apis/credentials" target="_blank" 
                   style="display: inline-block; background: linear-gradient(135deg, #a855f7, #6366f1); color: #fff; padding: 0.5rem 1rem; border-radius: 6px; text-decoration: none; font-size: 0.8rem; font-weight: 500;">
                    Fix in Google Cloud Console ‚Üí
                </a>
            `;
            container.appendChild(helpDiv);
        }
        
        // Show specific error when origin/domain is not authorized
        function showOriginError() {
            const container = document.getElementById('google-signin-container');
            if (!container) return;
            
            const currentOrigin = window.location.origin;
            
            container.innerHTML = `
                <div style="text-align: center; padding: 1.5rem; background: rgba(239,68,68,0.15); border-radius: 12px; border: 1px solid rgba(239,68,68,0.4); max-width: 320px; margin: 0 auto;">
                    <p style="color: #ef4444; margin: 0 0 1rem; font-weight: 600; font-size: 1.1rem;">üö´ Domain Not Authorized</p>
                    <p style="color: #fca5a5; margin: 0 0 1rem; font-size: 0.85rem; line-height: 1.5;">
                        Your domain <strong style="color: #fff;">${currentOrigin}</strong> is not authorized in Google Cloud Console.
                    </p>
                    <div style="background: rgba(0,0,0,0.3); padding: 1rem; border-radius: 8px; text-align: left; margin-bottom: 1rem;">
                        <p style="color: #fff; font-weight: 600; margin: 0 0 0.5rem; font-size: 0.8rem;">To fix this:</p>
                        <ol style="color: #d1d5db; margin: 0; padding-left: 1.2rem; font-size: 0.75rem; line-height: 1.6;">
                            <li>Go to <a href="https://console.cloud.google.com/apis/credentials" target="_blank" style="color: #a78bfa;">Google Cloud Console</a></li>
                            <li>Click on your OAuth 2.0 Client ID</li>
                            <li>Under "Authorized JavaScript origins", add:<br>
                                <code style="background: rgba(168,85,247,0.2); padding: 2px 6px; border-radius: 4px; color: #c4b5fd;">${currentOrigin}</code>
                            </li>
                            <li>Click Save and wait 5-10 minutes</li>
                        </ol>
                    </div>
                    <button onclick="location.reload()" style="background: linear-gradient(135deg, #a855f7, #6366f1); color: #fff; border: none; padding: 0.75rem 1.5rem; border-radius: 8px; font-weight: 600; cursor: pointer;">
                        üîÑ Try Again
                    </button>
                </div>
            `;
        }
        
        // Show configuration error when Client ID is not set
        function showConfigurationError() {
            const container = document.getElementById('google-signin-container');
            if (!container) return;
            
            container.innerHTML = `
                <div style="text-align: center; padding: 1rem; background: rgba(239,68,68,0.1); border-radius: 12px; border: 1px solid rgba(239,68,68,0.3);">
                    <p style="color: #ef4444; margin: 0 0 0.5rem; font-weight: 600;">‚ö†Ô∏è Configuration Required</p>
                    <p style="color: #fca5a5; margin: 0; font-size: 0.8rem;">
                        Google Sign-In not configured.<br>
                        Please set GOOGLE_CLIENT_ID in auth-config.js
                    </p>
                </div>
            `;
        }
        
        // Show error when Google Sign-In fails to load
        function showGoogleSignInError() {
            const container = document.getElementById('google-signin-container');
            if (!container) return;
            
            // Keep the original button but add help text
            const existingButton = container.querySelector('button, iframe');
            if (!existingButton) {
                container.innerHTML = `
                    <div style="text-align: center;">
                        <button class="google-signin-btn" id="google-signin-btn" onclick="location.reload()">
                            <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" alt="Google">
                            Sign in with Google
                        </button>
                    </div>
                `;
            }
            
            // Add help text if not already there
            if (!container.querySelector('.signin-help-text')) {
                const helpDiv = document.createElement('div');
                helpDiv.className = 'signin-help-text';
                helpDiv.style.cssText = 'margin-top: 1rem; text-align: center; padding: 1rem; background: rgba(251,191,36,0.1); border-radius: 8px;';
                helpDiv.innerHTML = `
                    <p style="color: #fbbf24; margin: 0 0 0.5rem; font-size: 0.85rem; font-weight: 500;">
                        ‚ö†Ô∏è Sign-in button not loading?
                    </p>
                    <p style="color: #d1d5db; margin: 0; font-size: 0.75rem; line-height: 1.5;">
                        Your domain may need to be added to Google Cloud Console.<br>
                        <a href="https://console.cloud.google.com/apis/credentials" target="_blank" style="color: var(--cav-primary);">
                            Click here to configure
                        </a>
                    </p>
                `;
                container.appendChild(helpDiv);
            }
        }

        function handleGoogleResponse(response) {
            const payload = decodeJWT(response.credential);
            
            if (payload) {
                processLogin(payload.email, payload.name, payload.picture, payload.sub);
            }
        }

        function decodeJWT(token) {
            try {
                const base64Url = token.split('.')[1];
                const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
                const jsonPayload = decodeURIComponent(atob(base64).split('').map(c => 
                    '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2)
                ).join(''));
                return JSON.parse(jsonPayload);
            } catch (e) {
                console.error('Failed to decode JWT:', e);
                return null;
            }
        }

        async function processLogin(email, name, picture, googleId) {
            // Security: Use domain access control from security-core
            if (window.CAVSecurity?.DomainAccessControl) {
                const accessCheck = window.CAVSecurity.DomainAccessControl.checkAccess(email);
                
                if (!accessCheck.allowed) {
                    if (accessCheck.reason === 'personal_domain') {
                        // Show request access option for personal email users
                        showAccessDeniedModal(email, accessCheck.message);
                        return;
                    } else {
                        alert(accessCheck.message);
                        return;
                    }
                }
                
                console.log('[CAV Auth] Access check passed:', accessCheck);
            } else {
                // Fallback to legacy checks
                if (isBlocked(email)) {
                    alert('Access denied. Your account has been blocked. Please contact the administrator.');
                    return;
                }
            }

            const settings = getSettings();
            const userType = getUserType(email);
            
            // Check if personal users are allowed (STRICT ENFORCEMENT)
            if (userType === 'personal') {
                const personalAllowed = settings.personalUsersEnabled ?? window.AUTH_CONFIG?.FEATURES?.PERSONAL_USERS_ENABLED ?? false;
                const isUserWhitelisted = isWhitelisted(email);
                
                if (!personalAllowed && !isUserWhitelisted) {
                    showAccessDeniedModal(email, 'Access denied. Personal email accounts (Gmail, Yahoo, Hotmail, etc.) are not permitted.\n\nPlease use a corporate email or contact your administrator to request access.');
                    return;
                }
            }

            const role = getUserRole(email);
            const defaultPicture = `https://ui-avatars.com/api/?name=${encodeURIComponent(name)}&background=ec4899&color=fff&bold=true`;
            
            const sessionData = {
                email: email,
                name: name,
                picture: picture || defaultPicture,
                userType: userType,
                role: role,
                canAccessTeam: canAccessTeam(userType, role),
                googleId: googleId || 'demo-' + Date.now(),
                permissions: {
                    canUpload: canUpload(role),
                    canEdit: canEdit(role),
                    canDelete: canDelete(role),
                    canManageUsers: canManageUsers(role),
                    canAccessTeam: canAccessTeam(userType, role)
                }
            };

            // Use secure session manager if available
            let session;
            if (window.CAVSecurity?.SecureSessionManager) {
                console.log('[CAV Auth] Creating secure session...');
                session = await window.CAVSecurity.SecureSessionManager.createSession(sessionData);
                console.log('[CAV Auth] Secure session created:', session?.id?.substring(0, 20) + '...');
                
                // CRITICAL: Verify session was stored before reloading
                const storedSession = localStorage.getItem('cav_secure_session_v3');
                console.log('[CAV Auth] Session stored in localStorage:', !!storedSession, 
                    storedSession ? `(${storedSession.length} chars)` : '');
                
                if (!storedSession) {
                    console.error('[CAV Auth] CRITICAL: Session not stored! Cannot reload.');
                    alert('Session creation failed. Please try again.');
                    return;
                }
            } else {
                // Fallback to legacy session
                console.log('[CAV Auth] Using legacy session (no security module)');
                session = setSession(sessionData);
            }

            // Update managed user record
            setManagedUser(email, {
                name: name,
                picture: session.picture,
                userType: userType,
                role: role,
                lastLogin: new Date().toISOString()
            });

            // Set global session for immediate access with full permissions
            window.cavUserSession = {
                ...session,
                role: role,
                userType: userType,
                permissions: {
                    canUpload: role === 'admin' || role === 'editor',
                    canEdit: role === 'admin' || role === 'editor',
                    canDelete: role === 'admin',
                    canManageUsers: role === 'admin',
                    canAccessTeam: canAccessTeam(userType, role)
                }
            };

            console.log('[CAV Auth] Session complete for:', email, 'Role:', role);
            console.log('[CAV Auth] Permissions:', window.cavUserSession.permissions);
            
            // Update UI without reload first to show login succeeded
            updateUI(session);
            
            // Wait longer to ensure localStorage and IndexedDB are fully flushed
            await new Promise(resolve => setTimeout(resolve, 500));
            
            // Only reload if necessary
            location.reload();
        }

        // Show access denied modal with request access option
        function showAccessDeniedModal(email, message) {
            const modal = document.createElement('div');
            modal.className = 'demo-login-modal';
            modal.innerHTML = `
                <div class="demo-login-overlay"></div>
                <div class="demo-login-content" style="max-width: 480px;">
                    <button class="demo-login-close" onclick="this.closest('.demo-login-modal').remove()">‚úï</button>
                    <div style="font-size: 3rem; margin-bottom: 1rem;">üîí</div>
                    <h2 style="color: #ef4444;">Access Denied</h2>
                    <p style="white-space: pre-line; margin-bottom: 1.5rem;">${message}</p>
                    
                    <div style="background: rgba(0,0,0,0.3); border-radius: 12px; padding: 1.25rem; margin-bottom: 1rem; text-align: left;">
                        <h4 style="margin: 0 0 0.75rem; color: #fff; font-size: 0.9rem;">üé´ Request Access</h4>
                        <p style="font-size: 0.8rem; color: #a1a1aa; margin-bottom: 0.75rem;">You can request access for: <strong style="color: #ec4899;">${email}</strong></p>
                        <textarea id="access-request-reason" placeholder="Why do you need access? (Optional)" style="width: 100%; padding: 0.75rem; border: 1px solid rgba(255,255,255,0.2); border-radius: 8px; background: rgba(0,0,0,0.3); color: #fff; font-size: 0.875rem; resize: vertical; min-height: 60px; box-sizing: border-box; margin-bottom: 0.75rem;"></textarea>
                        <button id="submit-access-request" class="demo-login-btn" style="width: 100%; background: linear-gradient(135deg, #10b981 0%, #059669 100%);">Submit Access Request</button>
                    </div>
                    
                    <button onclick="this.closest('.demo-login-modal').remove()" style="background: none; border: 1px solid rgba(255,255,255,0.2); color: #a1a1aa; padding: 0.75rem 1.5rem; border-radius: 8px; cursor: pointer; width: 100%;">Cancel</button>
                </div>
            `;
            document.body.appendChild(modal);

            // Handle access request submission
            document.getElementById('submit-access-request').addEventListener('click', () => {
                const reason = document.getElementById('access-request-reason').value.trim();
                
                if (window.CAVSecurity?.DomainAccessControl) {
                    const result = window.CAVSecurity.DomainAccessControl.requestWhitelistAccess(email, reason);
                    modal.remove();
                    
                    if (result.success) {
                        showNotification('‚úÖ ' + result.message, 'success');
                    } else {
                        showNotification('‚ö†Ô∏è ' + result.message, 'warning');
                    }
                } else {
                    modal.remove();
                    showNotification('Access request submitted. Please contact the administrator.', 'info');
                }
            });
        }

        // Show notification toast
        function showNotification(message, type = 'info') {
            const toast = document.createElement('div');
            toast.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 1rem 1.5rem;
                background: ${type === 'success' ? '#10b981' : type === 'warning' ? '#f59e0b' : '#3b82f6'};
                color: white;
                border-radius: 12px;
                box-shadow: 0 10px 40px rgba(0,0,0,0.3);
                z-index: 200000;
                font-weight: 500;
                max-width: 400px;
                animation: slideIn 0.3s ease;
            `;
            toast.textContent = message;
            document.body.appendChild(toast);
            
            setTimeout(() => {
                toast.style.animation = 'slideOut 0.3s ease';
                setTimeout(() => toast.remove(), 300);
            }, 5000);
        }

        function signOut() {
            const config = getConfig();
            
            // Clear Google auto-select
            if (config.GOOGLE_CLIENT_ID !== 'YOUR_GOOGLE_CLIENT_ID.apps.googleusercontent.com') {
                try {
                    google.accounts.id.disableAutoSelect();
                } catch (e) {
                    console.warn('[CAV Auth] Could not disable Google auto-select:', e);
                }
            }
            
            // Use secure session manager if available
            if (window.CAVSecurity?.SecureSessionManager) {
                window.CAVSecurity.SecureSessionManager.clearSession();
            } else {
                clearSession();
            }
            
            // Clear global session
            window.cavUserSession = null;
            
            updateUI(null);
            location.reload();
        }

        // =============================================
        // ADMIN DASHBOARD
        // =============================================
        function showAdminDashboard() {
            const session = getSession();
            if (!session || session.role !== 'admin') {
                alert('Access denied. Admin only.');
                return;
            }

            // Show loading state immediately for better UX
            let existingModal = document.getElementById('admin-modal-container');
            if (existingModal) existingModal.remove();
            
            const loadingModal = document.createElement('div');
            loadingModal.id = 'admin-modal-container';
            loadingModal.innerHTML = `
                <div class="admin-modal-overlay">
                    <div class="admin-modal" style="display:flex;justify-content:center;align-items:center;min-height:300px;">
                        <div style="text-align:center;">
                            <div style="font-size:2rem;margin-bottom:1rem;">üëë</div>
                            <div style="color:#a855f7;font-size:1.2rem;">Loading Admin Dashboard...</div>
                        </div>
                    </div>
                </div>`;
            document.body.appendChild(loadingModal);

            // Use requestAnimationFrame for smoother rendering
            requestAnimationFrame(() => {
                renderAdminDashboardContent(session);
            });
        }

        function renderAdminDashboardContent(session) {
            const activities = getActivityLog();
            const managedUsers = getManagedUsers();
            const settings = getSettings();

            // Aggregate user data from activities
            const userStats = {};
            activities.forEach(a => {
                if (!userStats[a.email]) {
                    userStats[a.email] = {
                        email: a.email,
                        name: a.name,
                        userType: a.userType,
                        loginCount: 0,
                        lastLogin: null
                    };
                }
                if (a.action === 'login') {
                    userStats[a.email].loginCount++;
                    userStats[a.email].lastLogin = a.timestamp;
                }
            });

            // Merge with managed users
            Object.keys(managedUsers).forEach(email => {
                if (!userStats[email]) {
                    userStats[email] = {
                        email: email,
                        name: managedUsers[email].name || email.split('@')[0],
                        userType: managedUsers[email].userType || 'unknown',
                        loginCount: 0,
                        lastLogin: managedUsers[email].lastLogin
                    };
                }
                userStats[email].role = managedUsers[email].role;
                userStats[email].status = managedUsers[email].status || 'active';
            });

            const userList = Object.values(userStats).sort((a, b) => 
                new Date(b.lastLogin || 0) - new Date(a.lastLogin || 0)
            );

            // Replace loading modal with actual content
            const existingModal = document.getElementById('admin-modal-container');
            if (existingModal) existingModal.remove();
            
            // Create admin modal
            const modal = document.createElement('div');
            modal.id = 'admin-modal-container';
            modal.innerHTML = `
                <div class="admin-modal-overlay">
                    <div class="admin-modal">
                        <div class="admin-header">
                            <h2>üëë Admin Dashboard</h2>
                            <button class="admin-close-btn" id="admin-close">‚úï</button>
                        </div>
                        
                        <div class="admin-tabs">
                            <button class="admin-tab active" data-tab="overview"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right:4px;vertical-align:middle;"><rect x="3" y="3" width="18" height="18" rx="2"/><path d="M3 9h18M9 21V9"/></svg>Overview</button>
                            <button class="admin-tab" data-tab="requests" id="requests-tab-btn">üé´ Access Requests <span id="pending-requests-badge" style="background: #ef4444; color: white; border-radius: 50%; padding: 2px 6px; font-size: 0.7rem; margin-left: 4px;"></span></button>
                            <button class="admin-tab" data-tab="users"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right:4px;vertical-align:middle;"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>Users</button>
                            <button class="admin-tab" data-tab="roles">üîê Roles & Permissions</button>
                            <button class="admin-tab" data-tab="domains"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right:4px;vertical-align:middle;"><path d="M3 21h18M3 10h18M5 6l7-3 7 3M4 10v11M20 10v11M8 14v3M12 14v3M16 14v3"/></svg>Domains</button>
                            <button class="admin-tab" data-tab="security">üîí Security</button>
                            <button class="admin-tab" data-tab="settings">‚öôÔ∏è Settings</button>
                            <button class="admin-tab" data-tab="activity">üìú Activity Log</button>
                        </div>
                        
                        <div class="admin-content">
                            <!-- Overview Tab -->
                            <div class="admin-section active" id="tab-overview">
                                <div class="stats-grid">
                                    <div class="stat-card">
                                        <div class="stat-value" style="color: #a855f7;">${userList.length}</div>
                                        <div class="stat-label">Total Users</div>
                                    </div>
                                    <div class="stat-card">
                                        <div class="stat-value" style="color: #f59e0b;">${userList.filter(u => u.role === 'admin' || isAdminEmail(u.email)).length}</div>
                                        <div class="stat-label">Admins</div>
                                    </div>
                                    <div class="stat-card">
                                        <div class="stat-value" style="color: #3b82f6;">${userList.filter(u => u.role === 'editor').length}</div>
                                        <div class="stat-label">Editors</div>
                                    </div>
                                    <div class="stat-card">
                                        <div class="stat-value" style="color: #22c55e;">${userList.filter(u => u.userType === 'corporate').length}</div>
                                        <div class="stat-label">Corporate</div>
                                    </div>
                                    <div class="stat-card">
                                        <div class="stat-value" style="color: #8b5cf6;">${userList.filter(u => u.userType === 'personal').length}</div>
                                        <div class="stat-label">Personal</div>
                                    </div>
                                    <div class="stat-card">
                                        <div class="stat-value" style="color: #06b6d4;">${activities.length}</div>
                                        <div class="stat-label">Activities</div>
                                    </div>
                                </div>
                                
                                <h3 style="color: #fff; margin-bottom: 1rem;">Recent Users</h3>
                                <div style="background: rgba(0,0,0,0.3); border-radius: 12px; overflow: hidden;">
                                    <table class="admin-table">
                                        <thead>
                                            <tr>
                                                <th>User</th>
                                                <th>Type</th>
                                                <th>Role</th>
                                                <th>Last Login</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            ${userList.slice(0, 10).map(u => `
                                                <tr>
                                                    <td>
                                                        <div style="font-weight: 500;">${u.name}</div>
                                                        <div style="font-size: 0.75rem; color: #c4b5fd;">${u.email}</div>
                                                    </td>
                                                    <td><span class="badge badge-${u.userType}">${u.userType}</span></td>
                                                    <td><span class="badge badge-${u.role || getUserRole(u.email)}">${u.role || getUserRole(u.email)}</span></td>
                                                    <td style="color: #c4b5fd;">${u.lastLogin ? new Date(u.lastLogin).toLocaleString() : 'Never'}</td>
                                                </tr>
                                            `).join('')}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                            
                            <!-- Access Requests Tab -->
                            <div class="admin-section" id="tab-requests">
                                <h3 style="color: #fff; margin-bottom: 1.5rem;">üé´ Pending Access Requests</h3>
                                <p style="color: #a1a1aa; margin-bottom: 1.5rem;">Users with personal emails (Gmail, Hotmail, etc.) who have requested access will appear here. Approve to whitelist them.</p>
                                
                                <div id="access-requests-container" style="background: rgba(0,0,0,0.3); border-radius: 12px; overflow: hidden;">
                                    <!-- Dynamically populated -->
                                </div>
                            </div>
                            
                            <!-- Security Tab -->
                            <div class="admin-section" id="tab-security">
                                <h3 style="color: #fff; margin-bottom: 1.5rem;">üîí Security Dashboard</h3>
                                
                                <div class="stats-grid" style="margin-bottom: 2rem;">
                                    <div class="stat-card">
                                        <div class="stat-value" style="color: #10b981;">‚úì</div>
                                        <div class="stat-label">Session Encryption</div>
                                        <div style="font-size: 0.7rem; color: #6b7280;">AES-256-GCM</div>
                                    </div>
                                    <div class="stat-card">
                                        <div class="stat-value" style="color: #10b981;">‚úì</div>
                                        <div class="stat-label">Device Binding</div>
                                        <div style="font-size: 0.7rem; color: #6b7280;">Fingerprint Verified</div>
                                    </div>
                                    <div class="stat-card">
                                        <div class="stat-value" style="color: #10b981;">‚úì</div>
                                        <div class="stat-label">Anti-Tampering</div>
                                        <div style="font-size: 0.7rem; color: #6b7280;">HMAC Signatures</div>
                                    </div>
                                    <div class="stat-card">
                                        <div class="stat-value" style="color: #ef4444;">üö´</div>
                                        <div class="stat-label">Personal Emails</div>
                                        <div style="font-size: 0.7rem; color: #6b7280;">Blocked by Default</div>
                                    </div>
                                </div>
                                
                                <div style="background: rgba(0,0,0,0.3); border-radius: 12px; padding: 1.5rem; margin-bottom: 1.5rem;">
                                    <h4 style="color: #fff; margin-bottom: 1rem;">üõ°Ô∏è Security Features Active</h4>
                                    <ul style="color: #a1a1aa; list-style: none; padding: 0;">
                                        <li style="margin-bottom: 0.5rem;">‚úÖ Encrypted session storage (AES-256-GCM)</li>
                                        <li style="margin-bottom: 0.5rem;">‚úÖ Device fingerprinting for session binding</li>
                                        <li style="margin-bottom: 0.5rem;">‚úÖ HMAC integrity verification</li>
                                        <li style="margin-bottom: 0.5rem;">‚úÖ 30-day session expiration</li>
                                        <li style="margin-bottom: 0.5rem;">‚úÖ Personal email domain blocking</li>
                                        <li style="margin-bottom: 0.5rem;">‚úÖ Admin approval system for whitelist</li>
                                        <li style="margin-bottom: 0.5rem;">‚úÖ Full activity audit logging</li>
                                        <li style="margin-bottom: 0.5rem;">‚úÖ Tamper detection with auto-logout</li>
                                    </ul>
                                </div>
                                
                                <div style="background: rgba(239, 68, 68, 0.1); border: 1px solid rgba(239, 68, 68, 0.3); border-radius: 12px; padding: 1.5rem;">
                                    <h4 style="color: #ef4444; margin-bottom: 1rem;">‚ö†Ô∏è Blocked Email Domains</h4>
                                    <p style="color: #a1a1aa; font-size: 0.875rem; margin-bottom: 0.75rem;">The following personal email domains are automatically blocked unless explicitly whitelisted:</p>
                                    <div style="display: flex; flex-wrap: wrap; gap: 0.5rem;">
                                        ${PERSONAL_EMAIL_DOMAINS.slice(0, 15).map(d => `<span style="background: rgba(239,68,68,0.2); color: #fca5a5; padding: 4px 10px; border-radius: 20px; font-size: 0.75rem;">${d}</span>`).join('')}
                                        <span style="color: #6b7280; font-size: 0.75rem; padding: 4px 10px;">+${PERSONAL_EMAIL_DOMAINS.length - 15} more...</span>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Users Tab -->
                            <div class="admin-section" id="tab-users">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                                    <h3 style="color: #fff;">User Management</h3>
                                    <button class="admin-btn-primary" id="add-user-btn">+ Add User</button>
                                </div>
                                
                                <div style="background: rgba(0,0,0,0.3); border-radius: 12px; overflow: hidden;">
                                    <table class="admin-table">
                                        <thead>
                                            <tr>
                                                <th>User</th>
                                                <th>Type</th>
                                                <th>Role</th>
                                                <th>Status</th>
                                                <th>Logins</th>
                                                <th>Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody id="users-table-body">
                                            ${userList.map(u => {
                                                const role = u.role || getUserRole(u.email);
                                                const status = u.status || (isBlocked(u.email) ? 'blocked' : 'active');
                                                return `
                                                <tr data-email="${u.email}">
                                                    <td>
                                                        <div style="font-weight: 500;">${u.name}</div>
                                                        <div style="font-size: 0.75rem; color: #c4b5fd;">${u.email}</div>
                                                    </td>
                                                    <td><span class="badge badge-${u.userType}">${u.userType}</span></td>
                                                    <td>
                                                        <select class="admin-select user-role-select" data-email="${u.email}" style="width: auto; padding: 0.25rem 0.5rem;">
                                                            <option value="viewer" ${role === 'viewer' ? 'selected' : ''}>Viewer</option>
                                                            <option value="editor" ${role === 'editor' ? 'selected' : ''}>Editor</option>
                                                            <option value="admin" ${role === 'admin' ? 'selected' : ''}>Admin</option>
                                                        </select>
                                                    </td>
                                                    <td><span class="badge badge-${status}">${status}</span></td>
                                                    <td>${u.loginCount || 0}</td>
                                                    <td>
                                                        ${status === 'blocked' ? 
                                                            `<button class="admin-btn-success unblock-user-btn" data-email="${u.email}">Unblock</button>` :
                                                            `<button class="admin-btn-danger block-user-btn" data-email="${u.email}">Block</button>`
                                                        }
                                                        <button class="admin-btn-secondary remove-user-btn" data-email="${u.email}" style="margin-left: 0.5rem;">Remove</button>
                                                    </td>
                                                </tr>
                                            `}).join('')}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                            
                            <!-- Roles & Permissions Tab -->
                            <div class="admin-section" id="tab-roles">
                                <h3 style="color: #fff; margin-bottom: 1.5rem;">Role Permissions</h3>
                                
                                <div style="background: rgba(0,0,0,0.3); border-radius: 12px; overflow: hidden; margin-bottom: 2rem;">
                                    <table class="admin-table">
                                        <thead>
                                            <tr>
                                                <th>Permission</th>
                                                <th style="text-align: center;">üëÅÔ∏è Viewer</th>
                                                <th style="text-align: center;">‚úèÔ∏è Editor</th>
                                                <th style="text-align: center;">üëë Admin</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <tr>
                                                <td>View Assets</td>
                                                <td style="text-align: center; color: #22c55e;">‚úì</td>
                                                <td style="text-align: center; color: #22c55e;">‚úì</td>
                                                <td style="text-align: center; color: #22c55e;">‚úì</td>
                                            </tr>
                                            <tr>
                                                <td>Upload Assets</td>
                                                <td style="text-align: center; color: #ef4444;">‚úó</td>
                                                <td style="text-align: center; color: #22c55e;">‚úì</td>
                                                <td style="text-align: center; color: #22c55e;">‚úì</td>
                                            </tr>
                                            <tr>
                                                <td>Edit Assets</td>
                                                <td style="text-align: center; color: #ef4444;">‚úó</td>
                                                <td style="text-align: center; color: #22c55e;">‚úì</td>
                                                <td style="text-align: center; color: #22c55e;">‚úì</td>
                                            </tr>
                                            <tr>
                                                <td>Delete Assets</td>
                                                <td style="text-align: center; color: #ef4444;">‚úó</td>
                                                <td style="text-align: center; color: #f59e0b;">Own Only</td>
                                                <td style="text-align: center; color: #22c55e;">‚úì</td>
                                            </tr>
                                            <tr>
                                                <td>Access Team Assets</td>
                                                <td style="text-align: center; color: #ef4444;">‚úó</td>
                                                <td style="text-align: center; color: #22c55e;">‚úì</td>
                                                <td style="text-align: center; color: #22c55e;">‚úì</td>
                                            </tr>
                                            <tr>
                                                <td>Manage Users</td>
                                                <td style="text-align: center; color: #ef4444;">‚úó</td>
                                                <td style="text-align: center; color: #ef4444;">‚úó</td>
                                                <td style="text-align: center; color: #22c55e;">‚úì</td>
                                            </tr>
                                            <tr>
                                                <td>Admin Dashboard</td>
                                                <td style="text-align: center; color: #ef4444;">‚úó</td>
                                                <td style="text-align: center; color: #ef4444;">‚úó</td>
                                                <td style="text-align: center; color: #22c55e;">‚úì</td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                                
                                <div class="admin-form-group">
                                    <label>Default Role for New Users</label>
                                    <select class="admin-select" id="default-role-select">
                                        <option value="viewer" ${settings.defaultRole === 'viewer' ? 'selected' : ''}>Viewer (Read Only)</option>
                                        <option value="editor" ${settings.defaultRole === 'editor' ? 'selected' : ''}>Editor (Can Upload & Edit)</option>
                                    </select>
                                </div>
                            </div>
                            
                            <!-- Domains Tab -->
                            <div class="admin-section" id="tab-domains">
                                <h3 style="color: #fff; margin-bottom: 1.5rem;">Corporate Domains</h3>
                                <p style="color: #c4b5fd; margin-bottom: 1rem;">Users with these email domains automatically get corporate access and team sharing.</p>
                                
                                <div style="margin-bottom: 1.5rem;">
                                    <div id="corporate-domains-list" style="display: flex; flex-wrap: wrap; gap: 0.5rem; margin-bottom: 1rem;">
                                        ${settings.corporateDomains.map(d => `
                                            <span class="domain-tag">
                                                <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right:4px;vertical-align:middle;"><path d="M3 21h18M3 10h18M5 6l7-3 7 3M4 10v11M20 10v11M8 14v3M12 14v3M16 14v3"/></svg>${d}
                                                <button class="domain-tag-remove remove-corp-domain" data-domain="${d}">‚úï</button>
                                            </span>
                                        `).join('')}
                                    </div>
                                    <div style="display: flex; gap: 0.5rem;">
                                        <input type="text" class="admin-input" id="new-corp-domain" placeholder="example.com" style="flex: 1;">
                                        <button class="admin-btn-primary" id="add-corp-domain">Add Domain</button>
                                    </div>
                                </div>
                                
                                <h3 style="color: #fff; margin: 2rem 0 1rem;">Admin Emails</h3>
                                <p style="color: #c4b5fd; margin-bottom: 1rem;">These users always have full admin access regardless of domain.</p>
                                
                                <div style="margin-bottom: 1.5rem;">
                                    <div id="admin-emails-list" style="display: flex; flex-wrap: wrap; gap: 0.5rem; margin-bottom: 1rem;">
                                        ${settings.adminEmails.map(e => `
                                            <span class="domain-tag">
                                                üëë ${e}
                                                <button class="domain-tag-remove remove-admin-email" data-email="${e}">‚úï</button>
                                            </span>
                                        `).join('')}
                                    </div>
                                    <div style="display: flex; gap: 0.5rem;">
                                        <input type="email" class="admin-input" id="new-admin-email" placeholder="admin@example.com" style="flex: 1;">
                                        <button class="admin-btn-primary" id="add-admin-email">Add Admin</button>
                                    </div>
                                </div>
                                
                                <h3 style="color: #fff; margin: 2rem 0 1rem;">Whitelisted Personal Emails</h3>
                                <p style="color: #c4b5fd; margin-bottom: 1rem;">These personal emails (Gmail, Yahoo, etc.) are allowed access even when personal users are disabled.</p>
                                
                                <div style="margin-bottom: 1.5rem;">
                                    <div id="whitelisted-emails-list" style="display: flex; flex-wrap: wrap; gap: 0.5rem; margin-bottom: 1rem;">
                                        ${(window.AUTH_CONFIG?.WHITELISTED_EMAILS || []).map(e => `
                                            <span class="domain-tag" style="border: 1px solid #22c55e;">
                                                <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="#10b981" stroke-width="2" style="margin-right:4px;vertical-align:middle;"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>${e}
                                                <button class="domain-tag-remove remove-whitelisted-email" data-email="${e}">‚úï</button>
                                            </span>
                                        `).join('')}
                                        ${(window.AUTH_CONFIG?.WHITELISTED_EMAILS || []).length === 0 ? '<span style="color: #c4b5fd;">No whitelisted emails</span>' : ''}
                                    </div>
                                    <div style="display: flex; gap: 0.5rem;">
                                        <input type="email" class="admin-input" id="new-whitelisted-email" placeholder="user@gmail.com" style="flex: 1;">
                                        <button class="admin-btn-success" id="add-whitelisted-email">Add Email</button>
                                    </div>
                                    <p style="font-size: 0.75rem; color: #6b7280; margin-top: 0.5rem;">Note: Updates to whitelist require editing auth-config.js directly for persistence.</p>
                                </div>
                                
                                <h3 style="color: #fff; margin: 2rem 0 1rem;">Blocked Domains</h3>
                                <p style="color: #c4b5fd; margin-bottom: 1rem;">Users with these email domains cannot access the app.</p>
                                
                                <div>
                                    <div id="blocked-domains-list" style="display: flex; flex-wrap: wrap; gap: 0.5rem; margin-bottom: 1rem;">
                                        ${(settings.blockedDomains || []).map(d => `
                                            <span class="domain-tag" style="border: 1px solid #ef4444;">
                                                üö´ ${d}
                                                <button class="domain-tag-remove remove-blocked-domain" data-domain="${d}">‚úï</button>
                                            </span>
                                        `).join('')}
                                        ${(settings.blockedDomains || []).length === 0 ? '<span style="color: #c4b5fd;">No blocked domains</span>' : ''}
                                    </div>
                                    <div style="display: flex; gap: 0.5rem;">
                                        <input type="text" class="admin-input" id="new-blocked-domain" placeholder="spam.com" style="flex: 1;">
                                        <button class="admin-btn-danger" id="add-blocked-domain">Block Domain</button>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Settings Tab -->
                            <div class="admin-section" id="tab-settings">
                                <h3 style="color: #fff; margin-bottom: 1.5rem;">General Settings</h3>
                                
                                <div style="background: rgba(0,0,0,0.3); border-radius: 12px; padding: 1.5rem;">
                                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 1rem 0; border-bottom: 1px solid rgba(255,255,255,0.1);">
                                        <div>
                                            <div style="font-weight: 600; color: #fff;">Team Sharing</div>
                                            <div style="font-size: 0.875rem; color: #c4b5fd;">Allow corporate users to share assets with team members</div>
                                        </div>
                                        <label class="toggle-switch">
                                            <input type="checkbox" id="setting-team-sharing" ${settings.teamSharingEnabled ? 'checked' : ''}>
                                            <span class="toggle-slider"></span>
                                        </label>
                                    </div>
                                    
                                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 1rem 0; border-bottom: 1px solid rgba(255,255,255,0.1);">
                                        <div>
                                            <div style="font-weight: 600; color: #fff;">Allow Personal Users</div>
                                            <div style="font-size: 0.875rem; color: #c4b5fd;">Let users with personal email addresses (Gmail, Yahoo, etc.) access the app</div>
                                        </div>
                                        <label class="toggle-switch">
                                            <input type="checkbox" id="setting-personal-users" ${settings.personalUsersEnabled ? 'checked' : ''}>
                                            <span class="toggle-slider"></span>
                                        </label>
                                    </div>
                                    
                                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 1rem 0;">
                                        <div>
                                            <div style="font-weight: 600; color: #fff;">Require Approval</div>
                                            <div style="font-size: 0.875rem; color: #c4b5fd;">New users must be approved by an admin before accessing the app</div>
                                        </div>
                                        <label class="toggle-switch">
                                            <input type="checkbox" id="setting-require-approval" ${settings.requireApproval ? 'checked' : ''}>
                                            <span class="toggle-slider"></span>
                                        </label>
                                    </div>
                                </div>
                                
                                <div style="margin-top: 2rem; display: flex; gap: 1rem; flex-wrap: wrap;">
                                    <button class="admin-btn-primary" id="save-settings-btn">üíæ Save All Settings</button>
                                    <button class="admin-btn-secondary" id="export-settings-btn"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right:4px;vertical-align:middle;"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>Export Settings</button>
                                    <button class="admin-btn-secondary" id="import-settings-btn">üì• Import Settings</button>
                                </div>
                            </div>
                            
                            <!-- Activity Tab -->
                            <div class="admin-section" id="tab-activity">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                                    <h3 style="color: #fff;">Activity Log</h3>
                                    <div style="display: flex; gap: 0.5rem;">
                                        <button class="admin-btn-primary" id="export-activity-btn"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right:4px;vertical-align:middle;"><rect x="3" y="3" width="18" height="18" rx="2"/><path d="M3 9h18M9 21V9"/></svg>Export CSV</button>
                                        <button class="admin-btn-danger" id="clear-activity-btn">üóëÔ∏è Clear Log</button>
                                    </div>
                                </div>
                                
                                <div style="background: rgba(0,0,0,0.3); border-radius: 12px; padding: 1rem; max-height: 500px; overflow-y: auto;">
                                    ${activities.slice().reverse().slice(0, 100).map(a => `
                                        <div class="activity-item">
                                            <div>
                                                <span class="activity-dot ${a.action}"></span>
                                                <span style="color: #fff;">${a.name}</span>
                                                <span style="color: #c4b5fd; margin-left: 0.5rem;">${a.action}</span>
                                                ${a.details && Object.keys(a.details).length > 0 ? 
                                                    `<span style="color: #a855f7; margin-left: 0.5rem;">${JSON.stringify(a.details)}</span>` : ''
                                                }
                                            </div>
                                            <div style="color: #c4b5fd; font-size: 0.75rem;">${new Date(a.timestamp).toLocaleString()}</div>
                                        </div>
                                    `).join('')}
                                    ${activities.length === 0 ? '<p style="color: #c4b5fd; text-align: center; padding: 2rem;">No activity recorded yet</p>' : ''}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);

            // Tab switching
            modal.querySelectorAll('.admin-tab').forEach(tab => {
                tab.addEventListener('click', () => {
                    modal.querySelectorAll('.admin-tab').forEach(t => t.classList.remove('active'));
                    modal.querySelectorAll('.admin-section').forEach(s => s.classList.remove('active'));
                    tab.classList.add('active');
                    document.getElementById(`tab-${tab.dataset.tab}`).classList.add('active');
                });
            });

            // Close button
            document.getElementById('admin-close').addEventListener('click', () => modal.remove());
            
            // Populate access requests
            populateAccessRequests(modal, session);

            // Add User
            document.getElementById('add-user-btn').addEventListener('click', () => {
                showAddUserModal(session);
            });

            // Setup remaining admin event listeners
            setupAdminEventListeners(modal, session);
        }

        function populateAccessRequests(modal, session) {
            const container = document.getElementById('access-requests-container');
            const badge = document.getElementById('pending-requests-badge');
            
            // Get requests from security module or fallback
            let requests = [];
            if (window.CAVSecurity?.DomainAccessControl) {
                requests = window.CAVSecurity.DomainAccessControl.getWhitelistRequests();
            } else {
                try {
                    requests = JSON.parse(localStorage.getItem('cav_whitelist_requests_v3') || '[]');
                } catch (e) {
                    requests = [];
                }
            }
            
            const pendingRequests = requests.filter(r => r.status === 'pending');
            
            // Update badge
            if (badge) {
                if (pendingRequests.length > 0) {
                    badge.textContent = pendingRequests.length;
                    badge.style.display = 'inline';
                } else {
                    badge.style.display = 'none';
                }
            }
            
            if (!container) return;
            
            if (requests.length === 0) {
                container.innerHTML = `
                    <div style="padding: 3rem; text-align: center; color: #a1a1aa;">
                        <div style="font-size: 3rem; margin-bottom: 1rem;">üì≠</div>
                        <p>No access requests yet</p>
                        <p style="font-size: 0.8rem; color: #6b7280; margin-top: 0.5rem;">Users with personal emails who try to sign in will appear here.</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = `
                <table class="admin-table">
                    <thead>
                        <tr>
                            <th>Email</th>
                            <th>Reason</th>
                            <th>Requested</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${requests.sort((a, b) => new Date(b.requestedAt) - new Date(a.requestedAt)).map(r => `
                            <tr data-request-id="${r.id}">
                                <td style="font-weight: 500; color: ${r.status === 'pending' ? '#ec4899' : '#a1a1aa'};">${r.email}</td>
                                <td style="max-width: 200px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" title="${r.reason || 'No reason provided'}">${r.reason || 'No reason provided'}</td>
                                <td style="color: #a1a1aa; font-size: 0.8rem;">${new Date(r.requestedAt).toLocaleString()}</td>
                                <td>
                                    <span class="badge ${r.status === 'pending' ? 'badge-personal' : r.status === 'approved' ? 'badge-corporate' : 'badge-blocked'}">
                                        ${r.status === 'pending' ? '‚è≥ Pending' : r.status === 'approved' ? '‚úÖ Approved' : '‚ùå Denied'}
                                    </span>
                                </td>
                                <td>
                                    ${r.status === 'pending' ? `
                                        <button class="admin-btn-success approve-request-btn" data-id="${r.id}" data-email="${r.email}" style="padding: 0.4rem 0.75rem; font-size: 0.8rem;">Approve</button>
                                        <button class="admin-btn-danger deny-request-btn" data-id="${r.id}" data-email="${r.email}" style="margin-left: 0.5rem; padding: 0.4rem 0.75rem; font-size: 0.8rem;">Deny</button>
                                    ` : `
                                        <span style="color: #6b7280; font-size: 0.8rem;">${r.status === 'approved' ? 'Role: ' + (r.approvedRole || 'viewer') : ''}</span>
                                    `}
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
            
            // Approve button handlers
            container.querySelectorAll('.approve-request-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const requestId = btn.dataset.id;
                    const email = btn.dataset.email;
                    
                    // Show role selection modal
                    const roleModal = document.createElement('div');
                    roleModal.className = 'demo-login-modal';
                    roleModal.innerHTML = `
                        <div class="demo-login-overlay" onclick="this.parentElement.remove()"></div>
                        <div class="demo-login-content" style="max-width: 400px;">
                            <button class="demo-login-close" onclick="this.closest('.demo-login-modal').remove()">‚úï</button>
                            <h2>‚úÖ Approve Access</h2>
                            <p>Grant access to <strong style="color: #ec4899;">${email}</strong></p>
                            <label style="display: block; color: #a1a1aa; margin-bottom: 0.5rem; font-size: 0.875rem;">Select Role:</label>
                            <select id="approve-role-select" style="width: 100%; padding: 0.875rem 1rem; border: 1px solid rgba(255,255,255,0.2); border-radius: 8px; background: rgba(0,0,0,0.3); color: #fff; font-size: 1rem; margin-bottom: 1rem;">
                                <option value="viewer">Viewer (Read Only)</option>
                                <option value="editor" selected>Editor (Can Upload & Edit)</option>
                            </select>
                            <button id="confirm-approve-btn" class="demo-login-btn" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%);">Approve Access</button>
                        </div>
                    `;
                    document.body.appendChild(roleModal);
                    
                    roleModal.querySelector('#confirm-approve-btn').addEventListener('click', () => {
                        const role = roleModal.querySelector('#approve-role-select').value;
                        
                        if (window.CAVSecurity?.DomainAccessControl) {
                            const result = window.CAVSecurity.DomainAccessControl.approveWhitelistRequest(requestId, role);
                            roleModal.remove();
                            if (result.success) {
                                alert(result.message);
                                modal.remove();
                                showAdminDashboard();
                            } else {
                                alert('Error: ' + result.message);
                            }
                        } else {
                            roleModal.remove();
                            alert('Security module not available');
                        }
                    });
                });
            });
            
            // Deny button handlers
            container.querySelectorAll('.deny-request-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const requestId = btn.dataset.id;
                    const email = btn.dataset.email;
                    
                    if (confirm(`Deny access request from ${email}?`)) {
                        if (window.CAVSecurity?.DomainAccessControl) {
                            const result = window.CAVSecurity.DomainAccessControl.denyWhitelistRequest(requestId);
                            if (result.success) {
                                modal.remove();
                                showAdminDashboard();
                            } else {
                                alert('Error: ' + result.message);
                            }
                        }
                    }
                });
            });
        }

        function showAddUserModal(session) {
            const settings = getSettings();
            const sessionDomain = session.email.split('@')[1];
            const isSuperAdmin = settings.adminEmails.includes(session.email);
            const isDomainAdmin = session.role === 'admin' && !isSuperAdmin;
            
            // Get allowed domains for this admin
            const allowedDomains = isSuperAdmin 
                ? [...settings.corporateDomains, ...PERSONAL_EMAIL_DOMAINS.slice(0, 5)]
                : [sessionDomain]; // Domain admins can only add users from their domain
            
            // Create Add User modal on top of everything
            const modal = document.createElement('div');
            modal.id = 'add-user-modal-container';
            // Use very high z-index and ensure all styles are inline
            modal.setAttribute('style', `
                position: fixed !important;
                top: 0 !important;
                left: 0 !important;
                width: 100vw !important;
                height: 100vh !important;
                z-index: 2147483647 !important;
                display: flex !important;
                align-items: center !important;
                justify-content: center !important;
                background: rgba(0, 0, 0, 0.95) !important;
                backdrop-filter: blur(20px) !important;
                -webkit-backdrop-filter: blur(20px) !important;
            `.replace(/\n/g, ''));
            modal.innerHTML = `
                <div style="position:absolute;top:0;left:0;right:0;bottom:0;cursor:pointer;" onclick="document.getElementById('add-user-modal-container')?.remove();"></div>
                <div style="position:relative;z-index:10;background:linear-gradient(135deg,#1a1a1a 0%,#2d2d2d 100%);border-radius:16px;padding:2rem;max-width:450px;width:90%;text-align:center;border:1px solid rgba(255,255,255,0.2);box-shadow:0 25px 80px rgba(0,0,0,0.8);color:#fff;">
                    <button style="position:absolute;top:1rem;right:1rem;background:none;border:none;color:#9ca3af;font-size:1.25rem;cursor:pointer;padding:0.5rem;border-radius:8px;" onclick="document.getElementById('add-user-modal-container')?.remove();">‚úï</button>
                    <h2>üë§ Add User</h2>
                    <p style="margin-bottom: 1rem; color: #c4b5fd;">
                        ${isSuperAdmin ? 'üîë Super Admin: You can add users from any domain' : `üè¢ Domain Admin: You can add users from @${sessionDomain}`}
                    </p>
                    
                    <div style="margin-bottom: 1rem;">
                        <label style="display: block; margin-bottom: 0.5rem; color: #e9d5ff; font-size: 0.875rem;">User Email *</label>
                        <input type="email" id="add-user-email" placeholder="${isDomainAdmin ? `user@${sessionDomain}` : 'user@company.com'}" autocomplete="email" style="width: 100%; padding: 0.875rem 1rem; border: 1px solid rgba(255,255,255,0.2); border-radius: 8px; background: rgba(0,0,0,0.3); color: #fff; font-size: 1rem;">
                        ${isDomainAdmin ? `<small style="color: #fbbf24; margin-top: 0.25rem; display: block;">Only @${sessionDomain} emails allowed</small>` : ''}
                    </div>
                    
                    <div style="margin-bottom: 1rem;">
                        <label style="display: block; margin-bottom: 0.5rem; color: #e9d5ff; font-size: 0.875rem;">User Name</label>
                        <input type="text" id="add-user-name" placeholder="Full Name (optional)" style="width: 100%; padding: 0.875rem 1rem; border: 1px solid rgba(255,255,255,0.2); border-radius: 8px; background: rgba(0,0,0,0.3); color: #fff; font-size: 1rem;">
                    </div>
                    
                    <div style="margin-bottom: 1rem;">
                        <label style="display: block; margin-bottom: 0.5rem; color: #e9d5ff; font-size: 0.875rem;">Role</label>
                        <select id="add-user-role" style="width: 100%; padding: 0.875rem 1rem; border: 1px solid rgba(255,255,255,0.2); border-radius: 8px; background: rgba(0,0,0,0.3); color: #fff; font-size: 1rem;">
                            <option value="viewer">üëÅÔ∏è Viewer - Can view and download assets</option>
                            <option value="editor" selected>‚úèÔ∏è Editor - Can upload, edit, and use AI features</option>
                            ${isSuperAdmin ? '<option value="admin">üîê Admin - Full access + user management</option>' : ''}
                        </select>
                    </div>
                    
                    <div style="margin-bottom: 1.5rem;">
                        <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                            <input type="checkbox" id="add-user-team-access" checked style="width: 18px; height: 18px; accent-color: #a855f7;">
                            <span style="color: #e9d5ff;">Grant Team CRM Access</span>
                        </label>
                        <small style="color: #9ca3af; margin-top: 0.25rem; display: block; margin-left: 1.75rem;">Allow access to shared team CRM data</small>
                    </div>
                    
                    <button id="add-user-submit" class="demo-login-btn" style="width: 100%; padding: 1rem; font-size: 1rem; font-weight: 600;">
                        ‚ûï Add User
                    </button>
                    
                    <div id="add-user-error" style="color: #ef4444; margin-top: 1rem; display: none; font-size: 0.875rem; text-align: center;"></div>
                </div>
            `;
            document.body.appendChild(modal);
            
            setTimeout(() => document.getElementById('add-user-email').focus(), 100);

            document.getElementById('add-user-submit').addEventListener('click', () => {
                const email = document.getElementById('add-user-email').value.trim().toLowerCase();
                const nameInput = document.getElementById('add-user-name').value.trim();
                const role = document.getElementById('add-user-role').value;
                const teamAccess = document.getElementById('add-user-team-access').checked;
                const errorDiv = document.getElementById('add-user-error');
                
                // Validation
                if (!email || !email.includes('@')) {
                    errorDiv.textContent = '‚ùå Please enter a valid email address';
                    errorDiv.style.display = 'block';
                    return;
                }
                
                const emailDomain = email.split('@')[1];
                
                // Domain admin restriction
                if (isDomainAdmin && emailDomain !== sessionDomain) {
                    errorDiv.textContent = `‚ùå You can only add users from @${sessionDomain}`;
                    errorDiv.style.display = 'block';
                    return;
                }
                
                // Check if user already exists
                const existingUser = getManagedUser(email);
                if (existingUser) {
                    errorDiv.textContent = '‚ùå This user already exists';
                    errorDiv.style.display = 'block';
                    return;
                }
                
                // Create user
                const name = nameInput || email.split('@')[0].replace(/[._]/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
                const userType = getUserType(email);
                
                setManagedUser(email, {
                    name: name,
                    email: email,
                    userType: userType,
                    role: role,
                    status: 'active',
                    teamAccess: teamAccess,
                    domain: emailDomain,
                    addedBy: session.email,
                    addedAt: new Date().toISOString()
                });
                
                logActivity('user_added', session, { 
                    targetEmail: email, 
                    role: role, 
                    teamAccess: teamAccess,
                    domain: emailDomain 
                });
                
                // Show success message
                alert(`‚úÖ User "${name}" (${email}) added successfully with ${role} role!`);
                
                // Remove add user modal
                const addUserModal = document.getElementById('add-user-modal-container');
                if (addUserModal) addUserModal.remove();
            });
        }

        function setupAdminEventListeners(modal, session) {
            // Role change
            modal.querySelectorAll('.user-role-select').forEach(select => {
                select.addEventListener('change', (e) => {
                    const email = e.target.dataset.email;
                    const newRole = e.target.value;
                    const user = getManagedUser(email) || { email: email };
                    setManagedUser(email, { ...user, role: newRole });
                    logActivity('role_changed', session, { targetEmail: email, newRole: newRole });
                    alert(`Role updated to ${newRole}`);
                });
            });

            // Block user
            modal.querySelectorAll('.block-user-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const email = btn.dataset.email;
                    if (confirm(`Block ${email}? They will not be able to access the app.`)) {
                        const currentSettings = getSettings();
                        currentSettings.blockedEmails = currentSettings.blockedEmails || [];
                        if (!currentSettings.blockedEmails.includes(email.toLowerCase())) {
                            currentSettings.blockedEmails.push(email.toLowerCase());
                        }
                        saveSettings(currentSettings);
                        const user = getManagedUser(email) || { email: email };
                        setManagedUser(email, { ...user, status: 'blocked' });
                        logActivity('user_blocked', session, { targetEmail: email });
                        modal.remove();
                        showAdminDashboard();
                    }
                });
            });

            // Unblock user
            modal.querySelectorAll('.unblock-user-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const email = btn.dataset.email;
                    const currentSettings = getSettings();
                    currentSettings.blockedEmails = (currentSettings.blockedEmails || []).filter(e => e !== email.toLowerCase());
                    saveSettings(currentSettings);
                    const user = getManagedUser(email) || { email: email };
                    setManagedUser(email, { ...user, status: 'active' });
                    logActivity('user_unblocked', session, { targetEmail: email });
                    modal.remove();
                    showAdminDashboard();
                });
            });

            // Remove user
            modal.querySelectorAll('.remove-user-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const email = btn.dataset.email;
                    if (confirm(`Remove ${email} from the user list? They can still sign in again.`)) {
                        removeManagedUser(email);
                        logActivity('user_removed', session, { targetEmail: email });
                        modal.remove();
                        showAdminDashboard();
                    }
                });
            });

            // Add corporate domain
            document.getElementById('add-corp-domain').addEventListener('click', () => {
                const domain = document.getElementById('new-corp-domain').value.trim().toLowerCase();
                if (domain && domain.includes('.')) {
                    const currentSettings = getSettings();
                    if (!currentSettings.corporateDomains.includes(domain)) {
                        currentSettings.corporateDomains.push(domain);
                        saveSettings(currentSettings);
                        logActivity('domain_added', session, { domain: domain, type: 'corporate' });
                        modal.remove();
                        showAdminDashboard();
                    } else {
                        alert('Domain already exists');
                    }
                }
            });

            // Remove corporate domain
            modal.querySelectorAll('.remove-corp-domain').forEach(btn => {
                btn.addEventListener('click', () => {
                    const domain = btn.dataset.domain;
                    const currentSettings = getSettings();
                    currentSettings.corporateDomains = currentSettings.corporateDomains.filter(d => d !== domain);
                    saveSettings(currentSettings);
                    logActivity('domain_removed', session, { domain: domain, type: 'corporate' });
                    modal.remove();
                    showAdminDashboard();
                });
            });

            // Add admin email
            document.getElementById('add-admin-email').addEventListener('click', () => {
                const email = document.getElementById('new-admin-email').value.trim().toLowerCase();
                if (email && email.includes('@')) {
                    const currentSettings = getSettings();
                    if (!currentSettings.adminEmails.includes(email)) {
                        currentSettings.adminEmails.push(email);
                        saveSettings(currentSettings);
                        logActivity('admin_added', session, { email: email });
                        modal.remove();
                        showAdminDashboard();
                    } else {
                        alert('Email already an admin');
                    }
                }
            });

            // Remove admin email
            modal.querySelectorAll('.remove-admin-email').forEach(btn => {
                btn.addEventListener('click', () => {
                    const email = btn.dataset.email;
                    if (email === session.email) {
                        alert('You cannot remove yourself as admin');
                        return;
                    }
                    const currentSettings = getSettings();
                    currentSettings.adminEmails = currentSettings.adminEmails.filter(e => e !== email);
                    saveSettings(currentSettings);
                    logActivity('admin_removed', session, { email: email });
                    modal.remove();
                    showAdminDashboard();
                });
            });

            // Add blocked domain
            document.getElementById('add-blocked-domain').addEventListener('click', () => {
                const domain = document.getElementById('new-blocked-domain').value.trim().toLowerCase();
                if (domain && domain.includes('.')) {
                    const currentSettings = getSettings();
                    currentSettings.blockedDomains = currentSettings.blockedDomains || [];
                    if (!currentSettings.blockedDomains.includes(domain)) {
                        currentSettings.blockedDomains.push(domain);
                        saveSettings(currentSettings);
                        logActivity('domain_blocked', session, { domain: domain });
                        modal.remove();
                        showAdminDashboard();
                    } else {
                        alert('Domain already blocked');
                    }
                }
            });

            // Remove blocked domain
            modal.querySelectorAll('.remove-blocked-domain').forEach(btn => {
                btn.addEventListener('click', () => {
                    const domain = btn.dataset.domain;
                    const currentSettings = getSettings();
                    currentSettings.blockedDomains = (currentSettings.blockedDomains || []).filter(d => d !== domain);
                    saveSettings(currentSettings);
                    logActivity('domain_unblocked', session, { domain: domain });
                    modal.remove();
                    showAdminDashboard();
                });
            });

            // Default role change
            document.getElementById('default-role-select').addEventListener('change', (e) => {
                const currentSettings = getSettings();
                currentSettings.defaultRole = e.target.value;
                saveSettings(currentSettings);
                logActivity('setting_changed', session, { setting: 'defaultRole', value: e.target.value });
            });

            // Settings toggles
            document.getElementById('setting-team-sharing').addEventListener('change', (e) => {
                const currentSettings = getSettings();
                currentSettings.teamSharingEnabled = e.target.checked;
                saveSettings(currentSettings);
                logActivity('setting_changed', session, { setting: 'teamSharingEnabled', value: e.target.checked });
            });

            document.getElementById('setting-personal-users').addEventListener('change', (e) => {
                const currentSettings = getSettings();
                currentSettings.personalUsersEnabled = e.target.checked;
                saveSettings(currentSettings);
                logActivity('setting_changed', session, { setting: 'personalUsersEnabled', value: e.target.checked });
            });

            document.getElementById('setting-require-approval').addEventListener('change', (e) => {
                const currentSettings = getSettings();
                currentSettings.requireApproval = e.target.checked;
                saveSettings(currentSettings);
                logActivity('setting_changed', session, { setting: 'requireApproval', value: e.target.checked });
            });

            // Save settings button
            document.getElementById('save-settings-btn').addEventListener('click', () => {
                alert('Settings saved successfully!');
            });

            // Export settings
            document.getElementById('export-settings-btn').addEventListener('click', () => {
                const exportData = {
                    settings: getSettings(),
                    users: getManagedUsers(),
                    exportedAt: new Date().toISOString(),
                    exportedBy: session.email
                };
                const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = `cav-settings-${new Date().toISOString().split('T')[0]}.json`;
                link.click();
            });

            // Import settings
            document.getElementById('import-settings-btn').addEventListener('click', () => {
                const input = document.createElement('input');
                input.type = 'file';
                input.accept = '.json';
                input.onchange = (e) => {
                    const file = e.target.files[0];
                    const reader = new FileReader();
                    reader.onload = (event) => {
                        try {
                            const data = JSON.parse(event.target.result);
                            if (data.settings) {
                                saveSettings({ ...getSettings(), ...data.settings });
                            }
                            if (data.users) {
                                const currentUsers = getManagedUsers();
                                saveManagedUsers({ ...currentUsers, ...data.users });
                            }
                            logActivity('settings_imported', session);
                            alert('Settings imported successfully!');
                            modal.remove();
                            showAdminDashboard();
                        } catch (err) {
                            alert('Failed to import settings: ' + err.message);
                        }
                    };
                    reader.readAsText(file);
                };
                input.click();
            });

            // Export activity
            document.getElementById('export-activity-btn').addEventListener('click', () => {
                const csv = 'Timestamp,Action,Name,Email,UserType,Role,Details\n' + 
                    activities.map(a => `"${a.timestamp}","${a.action}","${a.name}","${a.email}","${a.userType}","${a.role || ''}","${JSON.stringify(a.details || {})}"`).join('\n');
                const blob = new Blob([csv], { type: 'text/csv' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = `activity-log-${new Date().toISOString().split('T')[0]}.csv`;
                link.click();
            });

            // Clear activity
            document.getElementById('clear-activity-btn').addEventListener('click', () => {
                if (confirm('Clear all activity logs? This cannot be undone.')) {
                    localStorage.removeItem(STORAGE_KEYS.ACTIVITY);
                    logActivity('activity_cleared', session);
                    modal.remove();
                    showAdminDashboard();
                }
            });
        }

        // =============================================
        // EVENT LISTENERS (deferred to ensure DOM is ready)
        // =============================================
        function setupEventListeners() {
            const el = getElements();
            if (el.logoutBtn) el.logoutBtn.addEventListener('click', signOut);
            if (el.adminBtn) el.adminBtn.addEventListener('click', showAdminDashboard);
            
            // Direct OAuth button (bypasses popup entirely)
            const directOAuthBtn = document.getElementById('direct-oauth-btn');
            if (directOAuthBtn) {
                directOAuthBtn.addEventListener('click', startDirectOAuth);
            }
        }
        
        // =============================================
        // DIRECT OAUTH (Bypass Popup for Cursor IDE)
        // =============================================
        // =============================================
        // ALTERNATIVE SIGN-IN HELP
        // =============================================
        function startDirectOAuth() {
            // Show help message for users having trouble with popup
            const modal = document.createElement('div');
            modal.style.cssText = 'position:fixed;inset:0;z-index:100002;display:flex;align-items:center;justify-content:center;background:rgba(0,0,0,0.9);backdrop-filter:blur(8px);';
            modal.innerHTML = `
                <div style="background:linear-gradient(135deg,#1a1a1a 0%,#2d2d2d 100%);border-radius:16px;padding:2rem;max-width:450px;width:90%;text-align:center;border:1px solid rgba(255,255,255,0.1);box-shadow:0 25px 50px rgba(0,0,0,0.5);">
                    <div style="font-size:3rem;margin-bottom:1rem;">üí°</div>
                    <h2 style="color:#fff;margin:0 0 1rem;font-size:1.25rem;">Sign-In Help</h2>
                    <div style="text-align:left;background:rgba(0,0,0,0.3);padding:1rem;border-radius:8px;margin-bottom:1.5rem;">
                        <p style="color:#a1a1aa;margin:0 0 1rem;font-size:0.9rem;line-height:1.6;">
                            <strong style="color:#fff;">If the Google button isn't working:</strong>
                        </p>
                        <ol style="color:#c4b5fd;margin:0;padding-left:1.2rem;font-size:0.85rem;line-height:1.8;">
                            <li>Open <strong>Chrome</strong> browser</li>
                            <li>Go to <code style="background:rgba(168,85,247,0.2);padding:2px 6px;border-radius:4px;">http://localhost:6400</code></li>
                            <li>Click "Sign in with Google"</li>
                            <li>Complete login - session lasts 30 days!</li>
                            <li>Return to Cursor - you'll be logged in</li>
                        </ol>
                    </div>
                    <p style="color:#6b7280;font-size:0.8rem;margin:0 0 1rem;">
                        Session is shared between browsers via localStorage.
                    </p>
                    <button onclick="this.closest('div').parentElement.remove()" style="background:linear-gradient(135deg,#a855f7 0%,#6366f1 100%);border:none;padding:0.75rem 2rem;border-radius:8px;color:#fff;cursor:pointer;font-size:0.9rem;font-weight:600;">
                        Got it
                    </button>
                </div>
            `;
            document.body.appendChild(modal);
        }
        
        
        // Sidebar admin button
        const sidebarAdminBtn = document.getElementById('admin-btn-sidebar');
        if (sidebarAdminBtn) {
            sidebarAdminBtn.addEventListener('click', showAdminDashboard);
        }
        
        // Sidebar toggle for mobile
        const sidebarToggle = document.getElementById('sidebar-toggle');
        const sidebar = document.getElementById('main-sidebar');
        const mobileMenuBtn = document.getElementById('mobile-menu-btn');
        const sidebarOverlay = document.getElementById('sidebar-overlay');
        
        if (sidebarToggle && sidebar) {
            sidebarToggle.addEventListener('click', () => {
                sidebar.classList.toggle('expanded');
                sidebar.classList.toggle('mobile-open');
                sidebarOverlay?.classList.toggle('visible');
            });
        }
        
        // Mobile menu button in topbar
        if (mobileMenuBtn && sidebar) {
            mobileMenuBtn.addEventListener('click', () => {
                sidebar.classList.toggle('mobile-open');
                sidebarOverlay?.classList.toggle('visible');
            });
        }
        
        // Close sidebar overlay click
        if (sidebarOverlay) {
            sidebarOverlay.addEventListener('click', () => {
                sidebar?.classList.remove('mobile-open');
                sidebarOverlay.classList.remove('visible');
            });
        }
        
        // Close sidebar on outside click (mobile)
        document.addEventListener('click', (e) => {
            if (window.innerWidth <= 1024 && sidebar && 
                !sidebar.contains(e.target) && 
                !mobileMenuBtn?.contains(e.target) &&
                sidebar.classList.contains('mobile-open')) {
                sidebar.classList.remove('mobile-open');
                sidebarOverlay?.classList.remove('visible');
            }
        });
        
        const clearDataLink = document.getElementById('clear-data-link');
        if (clearDataLink) {
            clearDataLink.addEventListener('click', (e) => {
                e.preventDefault();
                const session = getSession();
                if (!session) {
                    alert('Please sign in first.');
                    return;
                }
                if (confirm(`Clear all YOUR data (${session.name})? This cannot be undone.`)) {
                    const userKey = session.email.toLowerCase().replace(/[^a-z0-9]/g, '_');
                    localStorage.removeItem(`cav_assets_${userKey}`);
                    location.reload();
                }
            });
        }
        
        // AI Studio link (main interface)
        const aiStudioLink = document.getElementById('ai-studio-link');
        if (aiStudioLink) {
            aiStudioLink.addEventListener('click', (e) => {
                e.preventDefault();
                if (window.cavAIStudio && window.cavAIStudio.openStudio) {
                    window.cavAIStudio.openStudio();
                } else {
                    alert('AI Studio not loaded. Please refresh the page.');
                }
            });
        }
        
        // AI Settings link
        const aiSettingsLink = document.getElementById('ai-settings-link');
        if (aiSettingsLink) {
            aiSettingsLink.addEventListener('click', (e) => {
                e.preventDefault();
                if (window.cavAIAdapter && window.cavAIAdapter.createSettingsModal) {
                    const modal = window.cavAIAdapter.createSettingsModal();
                    document.body.appendChild(modal);
                    
                    // Close button handler
                    modal.querySelector('.cav-ai-settings-close').addEventListener('click', () => modal.remove());
                    
                    // Load current API key
                    const apiKeyInput = document.getElementById('cav-gemini-api-key');
                    if (apiKeyInput && window.cavAIAdapter.getApiKey()) {
                        apiKeyInput.value = window.cavAIAdapter.getApiKey();
                    }
                    
                    // Save API key handler
                    document.getElementById('cav-save-api-key').addEventListener('click', () => {
                        const key = document.getElementById('cav-gemini-api-key').value.trim();
                        if (key) {
                            window.cavAIAdapter.setApiKey(key);
                            alert('API key saved successfully!');
                            // Update status
                            const statusEl = document.getElementById('cav-api-status');
                            statusEl.querySelector('.status-indicator').classList.add('connected');
                            statusEl.querySelector('.status-text').textContent = 'Connected';
                        }
                    });
                    
                    // Check API status
                    const statusEl = document.getElementById('cav-api-status');
                    if (window.cavAIAdapter.hasApiKey()) {
                        statusEl.querySelector('.status-indicator').classList.add('connected');
                        statusEl.querySelector('.status-text').textContent = 'API Key Configured';
                    } else {
                        statusEl.querySelector('.status-text').textContent = 'No API Key - Enter your key above';
                    }
                } else {
                    alert('AI Adapter not loaded. Please refresh the page.');
                }
            });
        }
        
        // CRM Link
        const crmLink = document.getElementById('crm-link');
        if (crmLink) {
            crmLink.addEventListener('click', (e) => {
                e.preventDefault();
                const session = getSession();
                if (!session) {
                    alert('Please sign in to access the CRM.');
                    return;
                }
                
                if (window.cavCRM) {
                    // Remove existing CRM modal if it exists
                    const existingModal = document.getElementById('crm-modal-container');
                    if (existingModal) {
                        existingModal.remove();
                    }
                    
                    // Create CRM modal
                    const crmModal = document.createElement('div');
                    crmModal.id = 'crm-modal-container';
                    crmModal.innerHTML = `
                        <div class="admin-modal-overlay">
                            <div class="admin-modal" style="max-width: 1400px;">
                                <div class="admin-header">
                                    <h2><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right:8px;vertical-align:middle;"><rect x="3" y="3" width="18" height="18" rx="2"/><path d="M3 9h18M9 21V9"/></svg>CRM Dashboard</h2>
                                    <button class="admin-close-btn" id="crm-close">‚úï</button>
                                </div>
                                <div id="crm-content-area" style="overflow-y: auto; max-height: 80vh;"></div>
                            </div>
                        </div>
                    `;
                    document.body.appendChild(crmModal);
                    
                    // Render CRM dashboard
                    const crmDashboard = window.cavCRM.createDashboard(window.cavCRM);
                    document.getElementById('crm-content-area').appendChild(crmDashboard);
                    
                    // Close button
                    document.getElementById('crm-close').addEventListener('click', () => crmModal.remove());
                    
                    // CRM Tab switching
                    crmModal.querySelectorAll('.crm-tab').forEach(tab => {
                        tab.addEventListener('click', () => {
                            crmModal.querySelectorAll('.crm-tab').forEach(t => t.classList.remove('active'));
                            crmModal.querySelectorAll('.crm-tab-content').forEach(c => c.classList.remove('active'));
                            tab.classList.add('active');
                            document.getElementById(`crm-tab-${tab.dataset.tab}`).classList.add('active');
                            
                            // Render content based on tab
                            if (tab.dataset.tab === 'contacts') {
                                renderContactsList();
                            } else if (tab.dataset.tab === 'companies') {
                                renderCompaniesList();
                            } else if (tab.dataset.tab === 'projects') {
                                renderProjectsList();
                            } else if (tab.dataset.tab === 'deals') {
                                renderDealPipeline();
                            } else if (tab.dataset.tab === 'activity') {
                                renderActivityFeed();
                            }
                        });
                    });
                    
                    // Add Contact button
                    document.getElementById('crm-add-contact').addEventListener('click', () => {
                        const form = window.cavCRM.createContactForm();
                        document.body.appendChild(form);
                        
                        // Form handlers
                        form.querySelector('.crm-modal-close').addEventListener('click', () => form.remove());
                        form.querySelector('.crm-modal-cancel').addEventListener('click', () => form.remove());
                        form.querySelector('.crm-modal-save').addEventListener('click', () => {
                            const contactData = {
                                firstName: document.getElementById('contact-firstName').value,
                                lastName: document.getElementById('contact-lastName').value,
                                email: document.getElementById('contact-email').value,
                                phone: document.getElementById('contact-phone').value,
                                companyName: document.getElementById('contact-company').value,
                                title: document.getElementById('contact-title').value,
                                type: document.getElementById('contact-type').value,
                                notes: document.getElementById('contact-notes').value,
                            };
                            
                            if (!contactData.firstName || !contactData.email) {
                                alert('First name and email are required.');
                                return;
                            }
                            
                            window.cavCRM.createContact(contactData);
                            form.remove();
                            renderContactsList();
                            alert('Contact created successfully!');
                        });
                    });
                    
                    // Add Company button
                    document.getElementById('crm-add-company')?.addEventListener('click', () => {
                        const form = window.cavCRM.createCompanyForm();
                        document.body.appendChild(form);
                        
                        // Form handlers
                        form.querySelector('.crm-modal-close')?.addEventListener('click', () => form.remove());
                        form.querySelector('.crm-modal-cancel')?.addEventListener('click', () => form.remove());
                        form.querySelector('.crm-modal-save')?.addEventListener('click', () => {
                            const companyData = {
                                name: document.getElementById('company-name')?.value,
                                industry: document.getElementById('company-industry')?.value,
                                website: document.getElementById('company-website')?.value,
                                phone: document.getElementById('company-phone')?.value,
                                email: document.getElementById('company-email')?.value,
                                location: document.getElementById('company-location')?.value,
                                type: document.getElementById('company-type')?.value,
                                description: document.getElementById('company-description')?.value,
                                tags: document.getElementById('company-tags')?.value.split(',').map(t => t.trim()).filter(Boolean),
                                notes: document.getElementById('company-notes')?.value,
                            };
                            
                            if (!companyData.name) {
                                alert('Company name is required.');
                                return;
                            }
                            
                            window.cavCRM.createCompany(companyData);
                            form.remove();
                            renderCompaniesList();
                            alert('Company created successfully!');
                        });
                    });
                    
                    // Add Project button
                    document.getElementById('crm-add-project')?.addEventListener('click', () => {
                        const form = window.cavCRM.createProjectForm();
                        document.body.appendChild(form);
                        
                        // Form handlers
                        form.querySelector('.crm-modal-close')?.addEventListener('click', () => form.remove());
                        form.querySelector('.crm-modal-cancel')?.addEventListener('click', () => form.remove());
                        form.querySelector('.crm-modal-save')?.addEventListener('click', () => {
                            const projectData = {
                                name: document.getElementById('project-name')?.value,
                                client: document.getElementById('project-client')?.value,
                                clientName: document.getElementById('project-client')?.selectedOptions[0]?.text || '',
                                type: document.getElementById('project-type')?.value,
                                status: document.getElementById('project-status')?.value,
                                startDate: document.getElementById('project-start')?.value,
                                deadline: document.getElementById('project-deadline')?.value,
                                budget: parseFloat(document.getElementById('project-budget')?.value) || 0,
                                priority: document.getElementById('project-priority')?.value,
                                description: document.getElementById('project-description')?.value,
                                tags: document.getElementById('project-tags')?.value.split(',').map(t => t.trim()).filter(Boolean),
                            };
                            
                            if (!projectData.name) {
                                alert('Project name is required.');
                                return;
                            }
                            
                            window.cavCRM.createProject(projectData);
                            form.remove();
                            renderProjectsList();
                            alert('Project created successfully!');
                        });
                    });
                    
                    // Helper functions for rendering lists
                    function renderContactsList() {
                        const contacts = window.cavCRM.getAllContacts();
                        const list = document.getElementById('crm-contacts-list');
                        
                        if (contacts.length === 0) {
                            list.innerHTML = '<p style="color: #c4b5fd; text-align: center; padding: 2rem;">No contacts yet. Click "+ Add Contact" to get started.</p>';
                            return;
                        }
                        
                        list.innerHTML = contacts.map(c => `
                            <div class="crm-list-item" data-id="${c.id}">
                                <div class="crm-list-avatar">${c.firstName.charAt(0)}${c.lastName.charAt(0)}</div>
                                <div class="crm-list-info">
                                    <div class="crm-list-name">${c.firstName} ${c.lastName}</div>
                                    <div class="crm-list-meta">${c.email} ${c.companyName ? '‚Ä¢ ' + c.companyName : ''}</div>
                                </div>
                                <span class="crm-list-badge crm-badge-${c.type}">${c.type}</span>
                            </div>
                        `).join('');
                    }
                    
                    function renderCompaniesList() {
                        const companies = window.cavCRM.getAllCompanies();
                        const list = document.getElementById('crm-companies-list');
                        
                        if (companies.length === 0) {
                            list.innerHTML = '<p style="color: #c4b5fd; text-align: center; padding: 2rem;">No companies yet. Click "+ Add Company" to get started.</p>';
                            return;
                        }
                        
                        list.innerHTML = companies.map(c => `
                            <div class="crm-list-item crm-company-item" data-id="${c.id}" style="cursor: pointer;">
                                <div class="crm-list-avatar" style="background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);">
                                    ${c.logo ? `<img src="${c.logo}" alt="${c.name}" style="width:100%;height:100%;object-fit:cover;border-radius:50%;">` : 'üè¢'}
                                </div>
                                <div class="crm-list-info" style="flex: 1;">
                                    <div class="crm-list-name">${c.name}</div>
                                    <div class="crm-list-meta">${c.domain || c.website || 'No domain'} ${c.industry ? '‚Ä¢ ' + c.industry : ''}</div>
                                    <div class="crm-list-badges" style="display: flex; gap: 0.5rem; margin-top: 0.5rem; flex-wrap: wrap;">
                                        ${(c.linkedAssets?.length || 0) > 0 ? `<span style="font-size: 0.7rem; background: rgba(168,85,247,0.2); padding: 0.15rem 0.5rem; border-radius: 4px;">üì∑ ${c.linkedAssets.length} assets</span>` : ''}
                                        ${(c.analyses?.length || 0) > 0 ? `<span style="font-size: 0.7rem; background: rgba(59,130,246,0.2); padding: 0.15rem 0.5rem; border-radius: 4px;">${c.analyses.length} analyses</span>` : ''}
                                        ${(c.benchmarks?.length || 0) > 0 ? `<span style="font-size: 0.7rem; background: rgba(34,197,94,0.2); padding: 0.15rem 0.5rem; border-radius: 4px;">${c.benchmarks.length} benchmarks</span>` : ''}
                                        ${(c.swipeFiles?.length || 0) > 0 ? `<span style="font-size: 0.7rem; background: rgba(236,72,153,0.2); padding: 0.15rem 0.5rem; border-radius: 4px;">${c.swipeFiles.length} swipes</span>` : ''}
                                        ${(c.competitors?.length || 0) > 0 ? `<span style="font-size: 0.7rem; background: rgba(249,115,22,0.2); padding: 0.15rem 0.5rem; border-radius: 4px;">üëÄ ${c.competitors.length} competitors</span>` : ''}
                                    </div>
                                </div>
                                <div class="crm-list-actions" style="display: flex; gap: 0.5rem; align-items: center;">
                                    <span class="crm-list-badge crm-badge-${c.type}" style="margin-right: 0.5rem;">${c.type}</span>
                                    <button class="crm-btn-view-company" data-id="${c.id}" style="background: rgba(59,130,246,0.2); border: none; padding: 0.5rem 0.75rem; border-radius: 6px; cursor: pointer; color: #93c5fd;" title="View Details">üëÅÔ∏è</button>
                                    <button class="crm-btn-edit-company" data-id="${c.id}" style="background: rgba(168,85,247,0.2); border: none; padding: 0.5rem 0.75rem; border-radius: 6px; cursor: pointer; color: #c4b5fd;" title="Edit">‚úèÔ∏è</button>
                                </div>
                            </div>
                        `).join('');
                        
                        // Attach click handlers for viewing company details
                        list.querySelectorAll('.crm-company-item').forEach(item => {
                            item.addEventListener('click', (e) => {
                                if (!e.target.closest('.crm-btn-view-company') && !e.target.closest('.crm-btn-edit-company')) {
                                    const companyId = item.dataset.id;
                                    showCompanyDetailModal(companyId);
                                }
                            });
                        });
                        
                        list.querySelectorAll('.crm-btn-view-company').forEach(btn => {
                            btn.addEventListener('click', (e) => {
                                e.stopPropagation();
                                const companyId = btn.dataset.id;
                                showCompanyDetailModal(companyId);
                            });
                        });
                        
                        list.querySelectorAll('.crm-btn-edit-company').forEach(btn => {
                            btn.addEventListener('click', (e) => {
                                e.stopPropagation();
                                const companyId = btn.dataset.id;
                                const company = window.cavCRM.getCompany(companyId);
                                if (company) {
                                    editCompany(company);
                                }
                            });
                        });
                    }
                    
                    function showCompanyDetailModal(companyId) {
                        const company = window.cavCRM.getCompany(companyId);
                        if (!company) return;
                        
                        console.log('[CRM] Company detail modal opened for:', company.name);
                        
                        // Remove any existing company detail overlay
                        const existingOverlay = document.getElementById('company-detail-overlay');
                        if (existingOverlay) existingOverlay.remove();
                        
                        // Create a full-page overlay that covers everything with solid background
                        const overlay = document.createElement('div');
                        overlay.id = 'company-detail-overlay';
                        overlay.style.cssText = `
                            position: fixed;
                            top: 0;
                            left: 60px;
                            right: 0;
                            bottom: 0;
                            z-index: 99999;
                            background-color: #121212;
                            overflow-y: auto;
                            padding: 1.5rem;
                        `;
                        
                        // Use overlay as the contentArea
                        const contentArea = overlay;
                        
                        // Get assets from ALL possible sources
                        const allAssets = window.cavValidatorApp?.assets || 
                                         window.cavValidatorApp?.state?.assets || 
                                         JSON.parse(localStorage.getItem('cav_assets') || '[]');
                        
                        const assets = (company.linkedAssets || []).map(id => {
                            const asset = allAssets.find(a => a.id === id);
                            if (asset) return asset;
                            // Fallback: check localStorage by ID
                            try {
                                const stored = localStorage.getItem(`cav_asset_${id}`);
                                if (stored) return JSON.parse(stored);
                            } catch (e) {}
                            return { id, filename: 'Unknown Asset', thumbnail_url: null };
                        }).filter(a => a);
                        
                        const analyses = company.analyses || [];
                        const benchmarks = company.benchmarks || [];
                        const swipeFiles = company.swipeFiles || [];
                        const competitors = company.competitors || [];
                        const bestPractices = company.bestPractices || [];
                        const urlAnalyses = company.urlAnalyses || [];
                        const aiAnalyses = company.aiAnalyses || [];
                        
                        // Calculate stats
                        const avgHookScore = analyses.length > 0 ? Math.round(analyses.reduce((s,a) => s + (a.hookScore||0), 0) / analyses.filter(a=>a.hookScore).length) || 'N/A' : 'N/A';
                        const avgCtaScore = analyses.length > 0 ? Math.round(analyses.reduce((s,a) => s + (a.ctaScore||0), 0) / analyses.filter(a=>a.ctaScore).length) || 'N/A' : 'N/A';
                        
                        // Render company detail content into the overlay
                        contentArea.innerHTML = `
                            <!-- Full Page Company View -->
                            <div class="cav-company-detail-page" style="display: flex; flex-direction: column; min-height: 100%;">
                                <!-- Header -->
                                <div style="background: var(--cav-bg-card); padding: 1.25rem 1.5rem; display: flex; align-items: center; justify-content: space-between; border-bottom: 1px solid var(--cav-border); border-radius: var(--cav-radius-lg) var(--cav-radius-lg) 0 0; margin-bottom: 1.5rem;">
                                    <div style="display: flex; align-items: center; gap: 1.25rem;">
                                        <button class="company-detail-close cav-btn" style="padding: 0.5rem 1rem; display: flex; align-items: center; gap: 0.5rem;">
                                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M19 12H5M12 19l-7-7 7-7"/></svg>
                                            Back to CRM
                                        </button>
                                        <div style="display: flex; align-items: center; gap: 1rem;">
                                            <div style="width: 48px; height: 48px; background: var(--cav-primary); border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 1.5rem; color: #fff;">${company.logo ? `<img src="${company.logo}" style="width:100%;height:100%;border-radius:12px;object-fit:cover;">` : company.name.charAt(0).toUpperCase()}</div>
                                            <div>
                                                <h1 style="margin: 0; font-size: 1.5rem; color: var(--cav-text); font-weight: 700;">${company.name}</h1>
                                                <div style="display: flex; gap: 0.5rem; margin-top: 0.25rem;">
                                                    <span style="background: rgba(236,72,153,0.15); color: #f472b6; padding: 0.25rem 0.6rem; border-radius: 20px; font-size: 0.75rem; font-weight: 600;">${company.type || 'client'}</span>
                                                    <span style="color: #71717a; font-size: 0.85rem;">${company.industry || 'No industry'}</span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div style="display: flex; gap: 0.75rem;">
                                        <button id="edit-company-btn" class="cav-btn cav-btn-secondary" style="display: flex; align-items: center; gap: 0.5rem;">
                                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>
                                            Edit
                                        </button>
                                        <button id="ai-full-analysis-btn" class="cav-btn cav-btn-primary" style="display: flex; align-items: center; gap: 0.5rem;">
                                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M12 16v-4M12 8h.01"/></svg>
                                            AI Analysis
                                        </button>
                                    </div>
                                </div>
                                
                                <!-- Main Content Grid -->
                                <div style="flex: 1; display: grid; grid-template-columns: 260px 1fr 320px; gap: 1.5rem; padding: 0 1.5rem 1.5rem; overflow: hidden;">
                                    
                                    <!-- Left Sidebar - Company Info -->
                                    <div style="background: var(--cav-bg-card); padding: 1.25rem; overflow-y: auto; border-radius: var(--cav-radius-lg); border: 1px solid var(--cav-border);">
                                        <h3 style="margin: 0 0 1rem; font-size: 0.7rem; color: var(--cav-text-muted); text-transform: uppercase; letter-spacing: 0.08em; font-weight: 600;">Company Details</h3>
                                        <div style="display: flex; flex-direction: column; gap: 0.75rem;">
                                            <div><span style="color: var(--cav-text-muted); font-size: 0.75rem;">Website</span><p style="margin: 0.25rem 0 0; color: var(--cav-text);">${company.website ? `<a href="${company.website}" target="_blank" style="color: var(--cav-primary); text-decoration: none;">${company.website}</a>` : 'Not set'}</p></div>
                                            <div><span style="color: var(--cav-text-muted); font-size: 0.75rem;">Phone</span><p style="margin: 0.25rem 0 0; color: var(--cav-text);">${company.phone || 'Not set'}</p></div>
                                            <div><span style="color: var(--cav-text-muted); font-size: 0.75rem;">Created</span><p style="margin: 0.25rem 0 0; color: var(--cav-text);">${new Date(company.createdAt).toLocaleDateString()}</p></div>
                                            ${company.description ? `<div><span style="color: var(--cav-text-muted); font-size: 0.75rem;">About</span><p style="margin: 0.25rem 0 0; color: var(--cav-text-secondary); font-size: 0.9rem;">${company.description}</p></div>` : ''}
                                        </div>
                                        
                                        <h3 style="margin: 2rem 0 1rem; font-size: 0.75rem; color: #71717a; text-transform: uppercase; letter-spacing: 0.05em; font-weight: 600;">Quick Stats</h3>
                                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.75rem;">
                                            <div style="background: #1a1a1a; border: 1px solid rgba(255,255,255,0.08); padding: 0.75rem; border-radius: 12px; text-align: center;">
                                                <div style="font-size: 1.5rem; font-weight: 700; color: #ec4899;">${assets.length}</div>
                                                <div style="font-size: 0.7rem; color: #71717a; text-transform: uppercase;">Assets</div>
                                            </div>
                                            <div style="background: #1a1a1a; border: 1px solid rgba(255,255,255,0.08); padding: 0.75rem; border-radius: 12px; text-align: center;">
                                                <div style="font-size: 1.5rem; font-weight: 700; color: #3b82f6;">${analyses.length}</div>
                                                <div style="font-size: 0.7rem; color: #71717a; text-transform: uppercase;">Analyses</div>
                                            </div>
                                            <div style="background: #1a1a1a; border: 1px solid rgba(255,255,255,0.08); padding: 0.75rem; border-radius: 12px; text-align: center;">
                                                <div style="font-size: 1.5rem; font-weight: 700; color: #10b981;">${avgHookScore}</div>
                                                <div style="font-size: 0.7rem; color: #71717a; text-transform: uppercase;">Avg Hook</div>
                                            </div>
                                            <div style="background: #1a1a1a; border: 1px solid rgba(255,255,255,0.08); padding: 0.75rem; border-radius: 12px; text-align: center;">
                                                <div style="font-size: 1.5rem; font-weight: 700; color: #f59e0b;">${benchmarks.length}</div>
                                                <div style="font-size: 0.7rem; color: #71717a; text-transform: uppercase;">Benchmarks</div>
                                            </div>
                                        </div>
                                        
                                        <h3 style="margin: 2rem 0 1rem; font-size: 0.75rem; color: #71717a; text-transform: uppercase; letter-spacing: 0.05em; font-weight: 600;">Tags</h3>
                                        <div style="display: flex; flex-wrap: wrap; gap: 0.5rem;">
                                            ${(company.tags || []).map(t => `<span style="background: rgba(236,72,153,0.15); color: #f472b6; padding: 0.3rem 0.6rem; border-radius: 20px; font-size: 0.75rem; font-weight: 500;">${t}</span>`).join('') || '<span style="color: #71717a; font-size: 0.8rem;">No tags</span>'}
                                        </div>
                                    </div>
                                    
                                    <!-- Center - Main Content with Tabs -->
                                    <div style="overflow-y: auto; padding: 1.25rem; background: var(--cav-bg-card); border-radius: var(--cav-radius-lg); border: 1px solid var(--cav-border);">
                                        <!-- Tabs - Modern Design -->
                                        <div class="cav-company-tabs" style="display: flex; gap: 4px; margin-bottom: 1.5rem; flex-wrap: wrap; background: var(--cav-bg); padding: 4px; border-radius: 10px;">
                                            <button class="company-tab active" data-tab="overview">Overview</button>
                                            <button class="company-tab" data-tab="assets">Assets (${assets.length})</button>
                                            <button class="company-tab" data-tab="analyses">Analyses (${analyses.length})</button>
                                            <button class="company-tab" data-tab="benchmarks">Benchmarks (${benchmarks.length})</button>
                                            <button class="company-tab" data-tab="swipes">Swipes (${swipeFiles.length})</button>
                                            <button class="company-tab" data-tab="practices">Practices (${bestPractices.length})</button>
                                            <button class="company-tab" data-tab="competitors">Competitors</button>
                                            <button class="company-tab" data-tab="strategy">Strategy</button>
                                            <button class="company-tab" data-tab="learn">Learn</button>
                                            <button class="company-tab" data-tab="notes">Notes (${(company.notes_list || []).length})</button>
                                        </div>
                                        
                                        <!-- Overview Tab -->
                                        <div class="company-tab-content" id="tab-overview">
                                            <!-- Enrich Company Button -->
                                            <div style="margin-bottom: 1.5rem; padding: 1.25rem; background: #1a1a1a; border-radius: 16px; border: 1px solid rgba(236,72,153,0.2);">
                                                <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem;">
                                                    <div>
                                                        <h3 style="margin: 0; font-size: 1rem; color: #fff; font-weight: 600;"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right:6px;vertical-align:middle;"><circle cx="12" cy="12" r="10"/><line x1="2" y1="12" x2="22" y2="12"/><path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"/></svg>Company Intelligence</h3>
                                                        <p style="margin: 0.25rem 0 0; font-size: 0.8rem; color: #71717a;">Enrich with public data, news, and AI insights</p>
                                                    </div>
                                                    <button id="enrich-company-btn" style="background: linear-gradient(135deg, #ec4899 0%, #db2777 100%); border: none; padding: 0.75rem 1.5rem; border-radius: 10px; color: #fff; cursor: pointer; font-weight: 600; white-space: nowrap; box-shadow: 0 4px 16px rgba(236,72,153,0.25);"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right:4px;vertical-align:middle;"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/></svg>Enrich Company Data</button>
                                                </div>
                                                ${company.enrichedData ? `
                                                    <div style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid rgba(255,255,255,0.1);">
                                                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 1rem;">
                                                            ${company.enrichedData.founded ? `<div><span style="color: #6b7280; font-size: 0.75rem;">Founded</span><p style="margin: 0.25rem 0 0; color: #fff; font-size: 0.9rem;">${company.enrichedData.founded}</p></div>` : ''}
                                                            ${company.enrichedData.employees ? `<div><span style="color: #6b7280; font-size: 0.75rem;">Employees</span><p style="margin: 0.25rem 0 0; color: #fff; font-size: 0.9rem;">${company.enrichedData.employees}</p></div>` : ''}
                                                            ${company.enrichedData.revenue ? `<div><span style="color: #6b7280; font-size: 0.75rem;">Revenue</span><p style="margin: 0.25rem 0 0; color: #4ade80; font-size: 0.9rem;">${company.enrichedData.revenue}</p></div>` : ''}
                                                            ${company.enrichedData.headquarters ? `<div><span style="color: #6b7280; font-size: 0.75rem;">Headquarters</span><p style="margin: 0.25rem 0 0; color: #fff; font-size: 0.9rem;">${company.enrichedData.headquarters}</p></div>` : ''}
                                                            ${company.enrichedData.stockSymbol ? `<div><span style="color: #6b7280; font-size: 0.75rem;">Stock</span><p style="margin: 0.25rem 0 0; color: #60a5fa; font-size: 0.9rem;">${company.enrichedData.stockSymbol}</p></div>` : ''}
                                                            ${company.enrichedData.marketCap ? `<div><span style="color: #6b7280; font-size: 0.75rem;">Market Cap</span><p style="margin: 0.25rem 0 0; color: #4ade80; font-size: 0.9rem;">${company.enrichedData.marketCap}</p></div>` : ''}
                                                        </div>
                                                        ${company.enrichedData.description ? `<p style="margin: 1rem 0 0; color: #d1d5db; font-size: 0.85rem; line-height: 1.5;">${company.enrichedData.description}</p>` : ''}
                                                        ${company.enrichedData.recentNews ? `
                                                            <div style="margin-top: 1rem;">
                                                                <h4 style="margin: 0 0 0.5rem; font-size: 0.85rem; color: #9ca3af;">üì∞ Recent News</h4>
                                                                <div style="display: flex; flex-direction: column; gap: 0.5rem;">
                                                                    ${company.enrichedData.recentNews.slice(0,3).map(n => `
                                                                        <div style="padding: 0.5rem; background: rgba(0,0,0,0.2); border-radius: 6px;">
                                                                            <p style="margin: 0; color: #e5e7eb; font-size: 0.8rem;">${n}</p>
                                                                        </div>
                                                                    `).join('')}
                                                                </div>
                                                            </div>
                                                        ` : ''}
                                                        <p style="margin: 0.75rem 0 0; font-size: 0.65rem; color: #6b7280;">Last updated: ${new Date(company.enrichedData.updatedAt).toLocaleString()}</p>
                                                    </div>
                                                ` : `
                                                    <p style="margin: 0.75rem 0 0; font-size: 0.8rem; color: #6b7280;">Click "Enrich Company Data" to fetch public information, news, and industry insights.</p>
                                                `}
                                            </div>
                                            
                                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1.5rem;">
                                                <!-- Recent Assets -->
                                                <div style="background: rgba(0,0,0,0.3); border-radius: 12px; padding: 1.25rem;">
                                                    <h3 style="margin: 0 0 1rem; font-size: 1rem; color: #fff;">üì∑ Recent Assets</h3>
                                                    ${assets.length === 0 ? '<p style="color: #6b7280;">No assets linked yet.</p>' : `
                                                        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 0.75rem;">
                                                            ${assets.slice(0,6).map(a => `
                                                                <div style="aspect-ratio: 1; background: rgba(0,0,0,0.3); border-radius: 8px; overflow: hidden;">
                                                                    ${a.thumbnail_url || a.dataUrl || a.thumbnail ? `<img src="${a.thumbnail_url || a.dataUrl || a.thumbnail}" style="width:100%;height:100%;object-fit:cover;">` : '<div style="width:100%;height:100%;display:flex;align-items:center;justify-content:center;font-size:1.5rem;">üì∑</div>'}
                                                                </div>
                                                            `).join('')}
                                                        </div>
                                                    `}
                                                </div>
                                                
                                                <!-- Key Benchmarks -->
                                                <div style="background: rgba(0,0,0,0.3); border-radius: 12px; padding: 1.25rem;">
                                                    <h3 style="margin: 0 0 1rem; font-size: 1rem; color: #fff;"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right:6px;vertical-align:middle;"><line x1="18" y1="20" x2="18" y2="10"/><line x1="12" y1="20" x2="12" y2="4"/><line x1="6" y1="20" x2="6" y2="14"/></svg>Key Benchmarks</h3>
                                                    ${benchmarks.length === 0 ? '<p style="color: #6b7280;">No benchmarks yet.</p>' : `
                                                        <div style="display: flex; flex-direction: column; gap: 0.75rem;">
                                                            ${benchmarks.slice(0,5).map(b => {
                                                                // Parse value if it's a JSON string
                                                                let val = b.value;
                                                                if (typeof val === 'string') {
                                                                    try { val = JSON.parse(val); } catch(e) { /* keep as string */ }
                                                                }
                                                                // Format display value
                                                                let displayValue = val;
                                                                if (val === undefined || val === null || val === 'undefined') {
                                                                    displayValue = 'N/A';
                                                                } else if (typeof val === 'object' && val !== null) {
                                                                    if (val.low !== undefined && val.high !== undefined) {
                                                                        displayValue = (val.expected !== undefined ? val.expected : ((val.low + val.high) / 2).toFixed(1)) + ' (' + val.low + '-' + val.high + ')';
                                                                    } else if (val.min !== undefined && val.max !== undefined) {
                                                                        displayValue = val.min + ' - ' + val.max;
                                                                    } else {
                                                                        const entries = Object.entries(val);
                                                                        displayValue = entries.length > 0 ? entries.map(function(e) { return e[0] + ': ' + e[1]; }).join(', ') : 'N/A';
                                                                    }
                                                                }
                                                                const metricName = b.metric || b.name || 'Metric';
                                                                if (!metricName || metricName === 'undefined') return '';
                                                                return '<div style="display: flex; justify-content: space-between; align-items: center; padding: 0.5rem; background: rgba(34,197,94,0.1); border-radius: 6px;"><span style="color: #9ca3af; font-size: 0.85rem;">' + metricName + '</span><span style="color: #4ade80; font-weight: 600; font-size: 0.8rem;">' + (displayValue || 'N/A') + '</span></div>';
                                                            }).join('')}
                                                        </div>
                                                    `}
                                                </div>
                                                
                                                <!-- Best Practices Preview -->
                                                <div style="background: rgba(0,0,0,0.3); border-radius: 12px; padding: 1.25rem;">
                                                    <h3 style="margin: 0 0 1rem; font-size: 1rem; color: #fff;">üìñ Best Practices</h3>
                                                    ${bestPractices.length === 0 ? '<p style="color: #6b7280;">No best practices saved.</p>' : `
                                                        <div style="display: flex; flex-direction: column; gap: 0.5rem;">
                                                            ${bestPractices.slice(0,3).map(p => `
                                                                <div style="padding: 0.5rem; background: rgba(168,85,247,0.1); border-radius: 6px; border-left: 3px solid #a78bfa;">
                                                                    <p style="margin: 0; font-size: 0.85rem; color: #e9d5ff;">${(p.practice || p.description || '').substring(0,100)}...</p>
                                                                </div>
                                                            `).join('')}
                                                        </div>
                                                    `}
                                                </div>
                                                
                                                <!-- URL Analyses -->
                                                <div style="background: rgba(0,0,0,0.3); border-radius: 12px; padding: 1.25rem;">
                                                    <h3 style="margin: 0 0 1rem; font-size: 1rem; color: #fff;"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right:6px;vertical-align:middle;"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"/><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"/></svg>URL Analyses</h3>
                                                    ${urlAnalyses.length === 0 ? '<p style="color: #6b7280;">No URL analyses yet. Use the Learn module.</p>' : `
                                                        <div style="display: flex; flex-direction: column; gap: 0.5rem;">
                                                            ${urlAnalyses.slice(0,4).map(u => `
                                                                <div style="padding: 0.5rem; background: rgba(59,130,246,0.1); border-radius: 6px;">
                                                                    <p style="margin: 0; font-size: 0.8rem; color: #60a5fa; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${u.url || 'URL'}</p>
                                                                    <p style="margin: 0.25rem 0 0; font-size: 0.7rem; color: #6b7280;">${new Date(u.savedAt || u.analyzedAt).toLocaleDateString()}</p>
                                                                </div>
                                                            `).join('')}
                                                        </div>
                                                    `}
                                                </div>
                                            </div>
                                            
                                            <!-- STRATEGIC INSIGHTS SECTION -->
                                            <div style="margin-top: 2rem;">
                                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                                                    <h3 style="margin: 0; font-size: 1.25rem; color: #fff; font-weight: 700;"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right:6px;vertical-align:middle;"><circle cx="12" cy="12" r="10"/><circle cx="12" cy="12" r="6"/><circle cx="12" cy="12" r="2"/></svg>Strategic Insights</h3>
                                                    <button id="generate-strategy-btn" style="background: linear-gradient(135deg, #8b5cf6 0%, #6366f1 100%); border: none; padding: 0.6rem 1.2rem; border-radius: 8px; color: #fff; cursor: pointer; font-weight: 600; font-size: 0.85rem; display: flex; align-items: center; gap: 0.5rem;">
                                                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2a10 10 0 1 0 10 10"/><path d="M12 6v6l4 2"/></svg>
                                                        Generate AI Strategy
                                                    </button>
                                                </div>
                                                
                                                ${company.strategyInsights ? '' : '<div id="strategy-placeholder" style="background: rgba(139,92,246,0.1); border: 2px dashed rgba(139,92,246,0.3); border-radius: 16px; padding: 2rem; text-align: center;"><p style="color: #a78bfa; font-size: 1rem; margin: 0;">Click "Generate AI Strategy" to analyze your assets, benchmarks, and best practices to create a comprehensive creative and paid media strategy.</p></div>'}
                                                
                                                <div id="strategy-insights-content" style="${company.strategyInsights ? '' : 'display: none;'}">
                                                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 1.5rem;">
                                                        <!-- Creative Strategy -->
                                                        <div style="background: linear-gradient(180deg, rgba(236,72,153,0.15) 0%, rgba(236,72,153,0.05) 100%); border-radius: 16px; padding: 1.5rem; border: 1px solid rgba(236,72,153,0.2);">
                                                            <h4 style="margin: 0 0 1rem; color: #f472b6; font-size: 1rem; display: flex; align-items: center; gap: 0.5rem;">
                                                                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"/><circle cx="8.5" cy="8.5" r="1.5"/><polyline points="21 15 16 10 5 21"/></svg>
                                                                Creative Strategy
                                                            </h4>
                                                            <div id="creative-strategy-content" style="color: #f9a8d4; font-size: 0.9rem; line-height: 1.6;">
                                                                ${company.strategyInsights?.creativeStrategy || '<p style="color: #6b7280;">No creative strategy generated yet.</p>'}
                                                            </div>
                                                        </div>
                                                        
                                                        <!-- Paid Media Strategy -->
                                                        <div style="background: linear-gradient(180deg, rgba(59,130,246,0.15) 0%, rgba(59,130,246,0.05) 100%); border-radius: 16px; padding: 1.5rem; border: 1px solid rgba(59,130,246,0.2);">
                                                            <h4 style="margin: 0 0 1rem; color: #60a5fa; font-size: 1rem; display: flex; align-items: center; gap: 0.5rem;">
                                                                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="2" y1="12" x2="22" y2="12"/><path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"/></svg>
                                                                Paid Media Strategy
                                                            </h4>
                                                            <div id="paid-media-strategy-content" style="color: #93c5fd; font-size: 0.9rem; line-height: 1.6;">
                                                                ${company.strategyInsights?.paidMediaStrategy || '<p style="color: #6b7280;">No paid media strategy generated yet.</p>'}
                                                            </div>
                                                        </div>
                                                        
                                                        <!-- Performance Trends -->
                                                        <div style="background: linear-gradient(180deg, rgba(34,197,94,0.15) 0%, rgba(34,197,94,0.05) 100%); border-radius: 16px; padding: 1.5rem; border: 1px solid rgba(34,197,94,0.2);">
                                                            <h4 style="margin: 0 0 1rem; color: #4ade80; font-size: 1rem; display: flex; align-items: center; gap: 0.5rem;">
                                                                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="23 6 13.5 15.5 8.5 10.5 1 18"/><polyline points="17 6 23 6 23 12"/></svg>
                                                                Performance Trends & Insights
                                                            </h4>
                                                            <div id="performance-trends-content" style="color: #86efac; font-size: 0.9rem; line-height: 1.6;">
                                                                ${company.strategyInsights?.performanceTrends || '<p style="color: #6b7280;">No performance analysis generated yet.</p>'}
                                                            </div>
                                                        </div>
                                                        
                                                        <!-- Action Items -->
                                                        <div style="background: linear-gradient(180deg, rgba(249,115,22,0.15) 0%, rgba(249,115,22,0.05) 100%); border-radius: 16px; padding: 1.5rem; border: 1px solid rgba(249,115,22,0.2);">
                                                            <h4 style="margin: 0 0 1rem; color: #fb923c; font-size: 1rem; display: flex; align-items: center; gap: 0.5rem;">
                                                                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>
                                                                Priority Action Items
                                                            </h4>
                                                            <div id="action-items-content" style="color: #fdba74; font-size: 0.9rem; line-height: 1.6;">
                                                                ${company.strategyInsights?.actionItems || '<p style="color: #6b7280;">No action items generated yet.</p>'}
                                                            </div>
                                                        </div>
                                                    </div>
                                                    
                                                    <!-- Recommendations Summary -->
                                                    <div style="margin-top: 1.5rem; background: rgba(168,85,247,0.1); border-radius: 16px; padding: 1.5rem; border: 1px solid rgba(168,85,247,0.2);">
                                                        <h4 style="margin: 0 0 1rem; color: #c4b5fd; font-size: 1rem; display: flex; align-items: center; gap: 0.5rem;">
                                                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg>
                                                            Key Recommendations
                                                        </h4>
                                                        <div id="recommendations-content" style="color: #e9d5ff; font-size: 0.9rem; line-height: 1.6;">
                                                            ${company.strategyInsights?.recommendations || '<p style="color: #6b7280;">Generate a strategy to see recommendations.</p>'}
                                                        </div>
                                                    </div>
                                                    
                                                    ${company.strategyInsights?.generatedAt ? '<p style="margin: 1rem 0 0; font-size: 0.7rem; color: #6b7280; text-align: right;">Strategy generated: ' + new Date(company.strategyInsights.generatedAt).toLocaleString() + '</p>' : ''}
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <!-- Assets Tab -->
                                        <div class="company-tab-content" id="tab-assets" style="display: none;">
                                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                                                <h3 style="margin: 0; color: var(--cav-text);">Linked Assets</h3>
                                                <button id="associate-asset-btn" class="cav-btn cav-btn-primary" style="display: flex; align-items: center; gap: 0.5rem;">
                                                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
                                                    Associate Asset
                                                </button>
                                            </div>
                                            ${assets.length === 0 ? '<div style="text-align:center;padding:3rem;color:#6b7280;"><p style="font-size:3rem;margin-bottom:1rem;">üì∑</p><p>No assets linked yet. Click "Associate Asset" to link assets from your library.</p></div>' : `
                                                <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); gap: 1rem;">
                                                    ${assets.map((a, idx) => `
                                                        <div class="company-asset-card" data-asset-idx="${idx}" style="background: rgba(0,0,0,0.3); border-radius: 12px; overflow: hidden; cursor: pointer; transition: transform 0.2s, box-shadow 0.2s;" onmouseover="this.style.transform='scale(1.02)';this.style.boxShadow='0 8px 24px rgba(168,85,247,0.3)'" onmouseout="this.style.transform='scale(1)';this.style.boxShadow='none'">
                                                            <div style="aspect-ratio: 16/9; background: rgba(0,0,0,0.2); position: relative;">
                                                                ${a.thumbnail_url || a.dataUrl || a.thumbnail ? `<img src="${a.thumbnail_url || a.dataUrl || a.thumbnail}" style="width:100%;height:100%;object-fit:cover;">` : '<div style="width:100%;height:100%;display:flex;align-items:center;justify-content:center;font-size:3rem;">üì∑</div>'}
                                                                <div style="position: absolute; top: 0.5rem; right: 0.5rem; display: flex; gap: 0.25rem;">
                                                                    <span style="background: rgba(0,0,0,0.7); padding: 0.2rem 0.5rem; border-radius: 4px; font-size: 0.65rem; color: #fff;">${a.width || '?'}√ó${a.height || '?'}</span>
                                                                </div>
                                                                <div style="position: absolute; inset: 0; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; opacity: 0; transition: opacity 0.2s;" class="asset-preview-overlay">
                                                                    <span style="background: linear-gradient(135deg, #8b5cf6 0%, #6366f1 100%); padding: 0.5rem 1rem; border-radius: 8px; font-size: 0.85rem; color: #fff;">üëÅÔ∏è Preview</span>
                                                                </div>
                                                            </div>
                                                            <div style="padding: 0.75rem;">
                                                                <p style="margin: 0; font-size: 0.85rem; color: #fff; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;" title="${a.filename}">${a.filename}</p>
                                                                <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 0.5rem;">
                                                                    <span style="font-size: 0.7rem; color: #6b7280;">${a.type || 'image'}</span>
                                                                    ${a.validation?.compatible_channels ? `<span style="font-size: 0.65rem; background: rgba(34,197,94,0.2); color: #4ade80; padding: 0.15rem 0.4rem; border-radius: 4px;">‚úì ${a.validation.compatible_channels.length} channels</span>` : ''}
                                                                </div>
                                                            </div>
                                                        </div>
                                                    `).join('')}
                                                </div>
                                            `}
                                        </div>
                                        
                                        <!-- Analyses Tab -->
                                        <div class="company-tab-content" id="tab-analyses" style="display: none;">
                                            ${analyses.length === 0 ? '<div style="text-align:center;padding:3rem;color:#6b7280;"><p style="font-size:3rem;margin-bottom:1rem;">üìà</p><p>No analyses saved yet. Use the Analyze module to analyze creatives for this company.</p></div>' : `
                                                <div style="display: flex; flex-direction: column; gap: 1rem;">
                                                    ${analyses.map(a => `
                                                        <div style="background: rgba(0,0,0,0.3); border-radius: 12px; padding: 1.25rem;">
                                                            <div style="display: flex; justify-content: space-between; align-items: start;">
                                                                <div>
                                                                    <h4 style="margin: 0; color: #fff;">${a.assetFilename || 'Analysis'}</h4>
                                                                    <p style="margin: 0.25rem 0 0; font-size: 0.8rem; color: #6b7280;">${new Date(a.analyzedAt).toLocaleString()}</p>
                                                                </div>
                                                                <div style="display: flex; gap: 0.75rem;">
                                                                    ${a.hookScore ? `<div style="text-align: center;"><div style="font-size: 1.25rem; font-weight: 700; color: #4ade80;">${a.hookScore}</div><div style="font-size: 0.65rem; color: #6b7280;">Hook</div></div>` : ''}
                                                                    ${a.ctaScore ? `<div style="text-align: center;"><div style="font-size: 1.25rem; font-weight: 700; color: #60a5fa;">${a.ctaScore}</div><div style="font-size: 0.65rem; color: #6b7280;">CTA</div></div>` : ''}
                                                                    ${a.thumbStopScore ? `<div style="text-align: center;"><div style="font-size: 1.25rem; font-weight: 700; color: #a78bfa;">${a.thumbStopScore}</div><div style="font-size: 0.65rem; color: #6b7280;">Thumb</div></div>` : ''}
                                                                </div>
                                                            </div>
                                                        </div>
                                                    `).join('')}
                                                </div>
                                            `}
                                        </div>
                                        
                                        <!-- Benchmarks Tab -->
                                        <div class="company-tab-content" id="tab-benchmarks" style="display: none;">
                                            <div style="margin-bottom: 1rem; display: flex; gap: 0.75rem;">
                                                <button id="fetch-benchmarks-btn" style="background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%); border: none; padding: 0.75rem 1.5rem; border-radius: 8px; color: #fff; cursor: pointer; font-weight: 600;"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right:4px;vertical-align:middle;"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/></svg>Fetch Industry Benchmarks with AI</button>
                                            </div>
                                            ${benchmarks.length === 0 ? '<div style="text-align:center;padding:3rem;color:#6b7280;"><p style="font-size:3rem;margin-bottom:1rem;">üìä</p><p>No benchmarks saved. Click above to fetch industry benchmarks or analyze URLs to extract metrics.</p></div>' : `
                                                <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); gap: 1rem;">
                                                    ${benchmarks.map(b => {
                                                        // Parse value if it's a JSON string
                                                        let val = b.value;
                                                        if (typeof val === 'string') {
                                                            try { val = JSON.parse(val); } catch(e) { /* keep as string */ }
                                                        }
                                                        // Format display value
                                                        let displayValue = val;
                                                        let rangeInfo = '';
                                                        if (val === undefined || val === null || val === 'undefined') {
                                                            displayValue = 'N/A';
                                                        } else if (typeof val === 'object' && val !== null) {
                                                            if (val.low !== undefined && val.high !== undefined) {
                                                                displayValue = val.expected !== undefined ? val.expected : ((val.low + val.high) / 2).toFixed(1);
                                                                rangeInfo = '<div style="font-size: 0.7rem; color: #6b7280; margin-top: 0.25rem;">Range: ' + val.low + ' - ' + val.high + '</div>';
                                                            } else if (val.min !== undefined && val.max !== undefined) {
                                                                displayValue = ((val.min + val.max) / 2).toFixed(1);
                                                                rangeInfo = '<div style="font-size: 0.7rem; color: #6b7280; margin-top: 0.25rem;">Range: ' + val.min + ' - ' + val.max + '</div>';
                                                            } else {
                                                                const entries = Object.entries(val);
                                                                displayValue = entries.length > 0 ? entries[0][1] : 'N/A';
                                                            }
                                                        }
                                                        const metricName = b.metric || b.name || 'Benchmark';
                                                        if (!metricName || metricName === 'undefined') return '';
                                                        return '<div style="background: rgba(34,197,94,0.1); border-radius: 12px; padding: 1.25rem; text-align: center; border: 1px solid rgba(34,197,94,0.2);"><div style="font-size: 0.85rem; color: #9ca3af; margin-bottom: 0.5rem; text-transform: uppercase;">' + metricName + '</div><div style="font-size: 1.75rem; font-weight: 700; color: #4ade80;">' + (displayValue || 'N/A') + '</div>' + rangeInfo + (b.source ? '<div style="font-size: 0.65rem; color: #6b7280; margin-top: 0.5rem;">üìå ' + b.source + '</div>' : '') + (b.industry ? '<div style="font-size: 0.65rem; color: #a78bfa; margin-top: 0.25rem;">üè¢ ' + b.industry + '</div>' : '') + '</div>';
                                                    }).join('')}
                                                </div>
                                            `}
                                        </div>
                                        
                                        <!-- Swipes Tab -->
                                        <div class="company-tab-content" id="tab-swipes" style="display: none;">
                                            ${swipeFiles.length === 0 ? '<div style="text-align:center;padding:3rem;color:#6b7280;"><p style="font-size:3rem;margin-bottom:1rem;">üìÅ</p><p>No swipe files. URL analysis saves creative examples automatically.</p></div>' : `
                                                <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 1rem;">
                                                    ${swipeFiles.map(s => `
                                                        <div style="background: rgba(0,0,0,0.3); border-radius: 12px; overflow: hidden;">
                                                            <div style="height: 150px; background: rgba(0,0,0,0.2);">
                                                                ${s.thumbnailData ? `<img src="${s.thumbnailData}" style="width:100%;height:100%;object-fit:cover;">` : '<div style="width:100%;height:100%;display:flex;align-items:center;justify-content:center;font-size:3rem;">üìÅ</div>'}
                                                            </div>
                                                            <div style="padding: 1rem;">
                                                                <p style="margin: 0 0 0.5rem; font-size: 0.9rem; color: #fff;">${s.title || 'Swipe File'}</p>
                                                                ${s.sourceUrl ? `<a href="${s.sourceUrl}" target="_blank" style="font-size: 0.8rem; color: #a78bfa;">View source ‚ÜóÔ∏è</a>` : ''}
                                                            </div>
                                                        </div>
                                                    `).join('')}
                                                </div>
                                            `}
                                        </div>
                                        
                                        <!-- Practices Tab -->
                                        <div class="company-tab-content" id="tab-practices" style="display: none;">
                                            ${bestPractices.length === 0 ? '<div style="text-align:center;padding:3rem;color:#6b7280;"><p style="font-size:3rem;margin-bottom:1rem;">üìñ</p><p>No best practices. The Learn module extracts these from URL analyses.</p></div>' : `
                                                <div style="display: flex; flex-direction: column; gap: 1rem;">
                                                    ${bestPractices.map(p => `
                                                        <div style="background: rgba(0,0,0,0.3); border-radius: 12px; padding: 1.25rem; border-left: 4px solid #4ade80;">
                                                            <div style="display: flex; gap: 0.5rem; margin-bottom: 0.75rem;">
                                                                <span style="background: rgba(34,197,94,0.2); padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem; color: #4ade80;">${p.category || 'General'}</span>
                                                                ${p.source ? `<span style="font-size: 0.75rem; color: #6b7280;">from ${p.source}</span>` : ''}
                                                            </div>
                                                            <p style="margin: 0; color: #e9d5ff; line-height: 1.6;">${p.practice || p.description}</p>
                                                        </div>
                                                    `).join('')}
                                                </div>
                                            `}
                                        </div>
                                        
                                        <!-- Competitors Tab -->
                                        <div class="company-tab-content" id="tab-competitors" style="display: none;">
                                            <div style="margin-bottom: 1rem;">
                                                <button id="fetch-competitors-btn" style="background: linear-gradient(135deg, #f97316 0%, #ea580c 100%); border: none; padding: 0.75rem 1.5rem; border-radius: 8px; color: #fff; cursor: pointer; font-weight: 600;"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right:4px;vertical-align:middle;"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/></svg>Auto-Detect Competitors with AI</button>
                                            </div>
                                            ${competitors.length === 0 ? '<div style="text-align:center;padding:3rem;color:#6b7280;"><p style="font-size:3rem;margin-bottom:1rem;">üëÄ</p><p>No competitors tracked yet. Use AI to auto-detect or add manually.</p></div>' : `
                                                <div style="display: flex; flex-direction: column; gap: 1rem;">
                                                    ${competitors.map(c => `
                                                        <div style="background: rgba(249,115,22,0.1); border-radius: 12px; padding: 1.25rem; border: 1px solid rgba(249,115,22,0.3);">
                                                            <div style="display: flex; align-items: center; gap: 1rem;">
                                                                <div style="font-size: 2.5rem;">üè¢</div>
                                                                <div style="flex: 1;">
                                                                    <h4 style="margin: 0; color: #fff;">${c.name}</h4>
                                                                    <p style="margin: 0.25rem 0 0; font-size: 0.85rem; color: #9ca3af;">${c.website || c.domain || 'No website'}</p>
                                                                </div>
                                                                ${c.industry ? `<span style="background: rgba(168,85,247,0.2); padding: 0.25rem 0.75rem; border-radius: 999px; font-size: 0.75rem; color: #c4b5fd;">${c.industry}</span>` : ''}
                                                            </div>
                                                        </div>
                                                    `).join('')}
                                                </div>
                                            `}
                                        </div>
                                        
                                        <!-- Strategy Tab -->
                                        <div class="company-tab-content" id="tab-strategy" style="display: none;">
                                            <!-- Comprehensive Strategy Overview -->
                                            ${company.strategyInsights ? '' : '<div style="background: linear-gradient(135deg, rgba(139,92,246,0.15) 0%, rgba(236,72,153,0.15) 100%); border: 2px dashed rgba(139,92,246,0.3); border-radius: 16px; padding: 2rem; text-align: center; margin-bottom: 2rem;"><h3 style="margin: 0 0 0.5rem; color: #c4b5fd;"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right:6px;vertical-align:middle;"><circle cx="12" cy="12" r="10"/><circle cx="12" cy="12" r="6"/><circle cx="12" cy="12" r="2"/></svg>Generate Strategic Insights</h3><p style="color: #9ca3af; font-size: 0.9rem; margin: 0 0 1rem;">Go to the Overview tab and click "Generate AI Strategy" to create a comprehensive creative and paid media strategy based on your assets, benchmarks, and best practices.</p><button class="go-to-overview-btn" style="background: linear-gradient(135deg, #8b5cf6 0%, #ec4899 100%); border: none; padding: 0.75rem 2rem; border-radius: 10px; color: #fff; cursor: pointer; font-weight: 600;">Go to Overview</button></div>'}
                                            
                                            ${company.strategyInsights ? '<div style="margin-bottom: 2rem;"><div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 1.5rem;"><div style="background: linear-gradient(180deg, rgba(236,72,153,0.15) 0%, rgba(236,72,153,0.05) 100%); border-radius: 16px; padding: 1.5rem; border: 1px solid rgba(236,72,153,0.2);"><h4 style="margin: 0 0 1rem; color: #f472b6; font-size: 1rem;"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right:4px;vertical-align:middle;"><path d="M12 2L2 7l10 5 10-5-10-5z"/><path d="M2 17l10 5 10-5"/><path d="M2 12l10 5 10-5"/></svg>Creative Strategy</h4><div style="color: #f9a8d4; font-size: 0.9rem; line-height: 1.6;">' + (company.strategyInsights.creativeStrategy || 'Not generated') + '</div></div><div style="background: linear-gradient(180deg, rgba(59,130,246,0.15) 0%, rgba(59,130,246,0.05) 100%); border-radius: 16px; padding: 1.5rem; border: 1px solid rgba(59,130,246,0.2);"><h4 style="margin: 0 0 1rem; color: #60a5fa; font-size: 1rem;"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right:4px;vertical-align:middle;"><line x1="12" y1="1" x2="12" y2="23"/><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></svg>Paid Media Strategy</h4><div style="color: #93c5fd; font-size: 0.9rem; line-height: 1.6;">' + (company.strategyInsights.paidMediaStrategy || 'Not generated') + '</div></div></div><div style="margin-top: 1.5rem; background: rgba(168,85,247,0.1); border-radius: 16px; padding: 1.5rem; border: 1px solid rgba(168,85,247,0.2);"><h4 style="margin: 0 0 1rem; color: #c4b5fd; font-size: 1rem;">‚≠ê Key Recommendations</h4><div style="color: #e9d5ff; font-size: 0.9rem; line-height: 1.6;">' + (company.strategyInsights.recommendations || 'Not generated') + '</div></div><p style="margin: 1rem 0 0; font-size: 0.7rem; color: #6b7280; text-align: right;">Last updated: ' + (company.strategyInsights.generatedAt ? new Date(company.strategyInsights.generatedAt).toLocaleString() : 'N/A') + '</p></div>' : ''}
                                            
                                            <h3 style="margin: 0 0 1.5rem; font-size: 1.1rem; color: #fff; font-weight: 600;"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right:6px;vertical-align:middle;"><line x1="18" y1="20" x2="18" y2="10"/><line x1="12" y1="20" x2="12" y2="4"/><line x1="6" y1="20" x2="6" y2="14"/></svg>Strategy Tools</h3>
                                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 1.5rem;">
                                                <!-- Placement Strategy -->
                                                <div style="background: rgba(59,130,246,0.1); border-radius: 12px; padding: 1.25rem; border: 1px solid rgba(59,130,246,0.3);">
                                                    <h3 style="margin: 0 0 1rem; font-size: 1rem; color: #fff;">üì± Placement Matrix</h3>
                                                    <p style="color: #9ca3af; font-size: 0.85rem; margin-bottom: 1rem;">Optimal ad placements based on your assets</p>
                                                    <div style="display: flex; flex-wrap: wrap; gap: 0.5rem; margin-bottom: 1rem;">
                                                        ${assets.slice(0,3).map(a => {
                                                            const validation = a.validation || {};
                                                            const channels = validation.compatible_channels || [];
                                                            return channels.slice(0,2).map(ch => `<span style="background: rgba(34,197,94,0.2); padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.7rem; color: #4ade80;">${ch}</span>`).join('');
                                                        }).join('')}
                                                    </div>
                                                    <button class="open-strategy-module" data-view="placement" style="width: 100%; padding: 0.75rem; border-radius: 8px; border: none; background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); color: #fff; cursor: pointer; font-weight: 600;"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right:4px;vertical-align:middle;"><rect x="3" y="3" width="18" height="18" rx="2"/><path d="M3 9h18M9 21V9"/></svg>View Full Matrix</button>
                                                </div>
                                                
                                                <!-- Derivative Roadmap -->
                                                <div style="background: rgba(168,85,247,0.1); border-radius: 12px; padding: 1.25rem; border: 1px solid rgba(168,85,247,0.3);">
                                                    <h3 style="margin: 0 0 1rem; font-size: 1rem; color: #fff;"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right:6px;vertical-align:middle;"><path d="M12 2L2 7l10 5 10-5-10-5z"/><path d="M2 17l10 5 10-5"/><path d="M2 12l10 5 10-5"/></svg>Derivative Roadmap</h3>
                                                    <p style="color: #9ca3af; font-size: 0.85rem; margin-bottom: 1rem;">AI-recommended asset variations</p>
                                                    <div style="display: flex; flex-direction: column; gap: 0.5rem; margin-bottom: 1rem;">
                                                        <div style="display: flex; justify-content: space-between; padding: 0.5rem; background: rgba(0,0,0,0.2); border-radius: 6px;"><span style="color: #c4b5fd; font-size: 0.85rem;">Resize variants</span><span style="color: #4ade80;">Ready</span></div>
                                                        <div style="display: flex; justify-content: space-between; padding: 0.5rem; background: rgba(0,0,0,0.2); border-radius: 6px;"><span style="color: #c4b5fd; font-size: 0.85rem;">Video animations</span><span style="color: #f97316;">Pending</span></div>
                                                    </div>
                                                    <button class="open-strategy-module" data-view="roadmap" style="width: 100%; padding: 0.75rem; border-radius: 8px; border: none; background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%); color: #fff; cursor: pointer; font-weight: 600;">üó∫Ô∏è View Roadmap</button>
                                                </div>
                                                
                                                <!-- A/B Testing -->
                                                <div style="background: rgba(34,197,94,0.1); border-radius: 12px; padding: 1.25rem; border: 1px solid rgba(34,197,94,0.3);">
                                                    <h3 style="margin: 0 0 1rem; font-size: 1rem; color: #fff;">üß™ A/B Test Ideas</h3>
                                                    <p style="color: #9ca3af; font-size: 0.85rem; margin-bottom: 1rem;">AI-generated test hypotheses</p>
                                                    <div style="display: flex; flex-direction: column; gap: 0.5rem; margin-bottom: 1rem;">
                                                        <div style="padding: 0.5rem; background: rgba(0,0,0,0.2); border-radius: 6px; border-left: 3px solid #4ade80;"><span style="color: #86efac; font-size: 0.8rem;">Test headline variations</span></div>
                                                        <div style="padding: 0.5rem; background: rgba(0,0,0,0.2); border-radius: 6px; border-left: 3px solid #4ade80;"><span style="color: #86efac; font-size: 0.8rem;">Compare CTA placements</span></div>
                                                    </div>
                                                    <button class="open-strategy-module" data-view="ab-tests" style="width: 100%; padding: 0.75rem; border-radius: 8px; border: none; background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%); color: #fff; cursor: pointer; font-weight: 600;">üß™ Generate Tests</button>
                                                </div>
                                                
                                                <!-- Fatigue Prediction -->
                                                <div style="background: rgba(239,68,68,0.1); border-radius: 12px; padding: 1.25rem; border: 1px solid rgba(239,68,68,0.3);">
                                                    <h3 style="margin: 0 0 1rem; font-size: 1rem; color: #fff;">‚è∞ Creative Fatigue</h3>
                                                    <p style="color: #9ca3af; font-size: 0.85rem; margin-bottom: 1rem;">Predict when to refresh creatives</p>
                                                    <div style="background: rgba(0,0,0,0.2); padding: 1rem; border-radius: 8px; text-align: center; margin-bottom: 1rem;">
                                                        <div style="font-size: 2rem; font-weight: 700; color: #4ade80;">Healthy</div>
                                                        <div style="font-size: 0.75rem; color: #6b7280;">Last refresh: ${assets.length > 0 ? 'Recently' : 'N/A'}</div>
                                                    </div>
                                                    <button class="open-strategy-module" data-view="fatigue" style="width: 100%; padding: 0.75rem; border-radius: 8px; border: none; background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); color: #fff; cursor: pointer; font-weight: 600;"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right:4px;vertical-align:middle;"><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/></svg>View Forecast</button>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <!-- Learn Tab -->
                                        <div class="company-tab-content" id="tab-learn" style="display: none;">
                                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 1.5rem;">
                                                <!-- URL Analyzer -->
                                                <div style="background: rgba(59,130,246,0.1); border-radius: 12px; padding: 1.25rem; border: 1px solid rgba(59,130,246,0.3);">
                                                    <h3 style="margin: 0 0 1rem; font-size: 1rem; color: #fff;"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right:6px;vertical-align:middle;"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"/><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"/></svg>URL Analyzer</h3>
                                                    <p style="color: #9ca3af; font-size: 0.85rem; margin-bottom: 1rem;">Analyze competitor landing pages and ads</p>
                                                    <input type="text" id="company-url-input" placeholder="Enter URL to analyze..." style="width: 100%; padding: 0.75rem; border-radius: 8px; border: 1px solid rgba(255,255,255,0.2); background: rgba(0,0,0,0.3); color: #fff; margin-bottom: 0.75rem;">
                                                    <button class="analyze-url-btn" style="width: 100%; padding: 0.75rem; border-radius: 8px; border: none; background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); color: #fff; cursor: pointer; font-weight: 600;"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right:4px;vertical-align:middle;"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/></svg>Analyze URL</button>
                                                    ${urlAnalyses.length > 0 ? `
                                                        <div style="margin-top: 1rem; border-top: 1px solid rgba(255,255,255,0.1); padding-top: 1rem;">
                                                            <p style="color: #6b7280; font-size: 0.75rem; margin: 0 0 0.5rem;">Recent analyses:</p>
                                                            ${urlAnalyses.slice(0,3).map(u => `
                                                                <div style="padding: 0.5rem; background: rgba(0,0,0,0.2); border-radius: 4px; margin-bottom: 0.25rem;">
                                                                    <a href="${u.url}" target="_blank" style="color: #60a5fa; font-size: 0.75rem; text-decoration: none; display: block; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${u.url}</a>
                                                                </div>
                                                            `).join('')}
                                                        </div>
                                                    ` : ''}
                                                </div>
                                                
                                                <!-- Swipe File -->
                                                <div style="background: rgba(168,85,247,0.1); border-radius: 12px; padding: 1.25rem; border: 1px solid rgba(168,85,247,0.3);">
                                                    <h3 style="margin: 0 0 1rem; font-size: 1rem; color: #fff;"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right:6px;vertical-align:middle;"><path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"/></svg>Swipe File</h3>
                                                    <p style="color: #9ca3af; font-size: 0.85rem; margin-bottom: 1rem;">Creative inspiration library (${swipeFiles.length} saved)</p>
                                                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 0.5rem; margin-bottom: 1rem;">
                                                        ${swipeFiles.slice(0,4).map(s => `
                                                            <div style="aspect-ratio: 1; background: rgba(0,0,0,0.3); border-radius: 8px; overflow: hidden;">
                                                                ${s.thumbnailData ? `<img src="${s.thumbnailData}" style="width:100%;height:100%;object-fit:cover;">` : '<div style="width:100%;height:100%;display:flex;align-items:center;justify-content:center;color:#6b7280;">üìÅ</div>'}
                                                            </div>
                                                        `).join('')}
                                                    </div>
                                                    <button class="open-learn-module" data-view="swipe" style="width: 100%; padding: 0.75rem; border-radius: 8px; border: none; background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%); color: #fff; cursor: pointer; font-weight: 600;"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right:4px;vertical-align:middle;"><path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"/></svg>Open Swipe File</button>
                                                </div>
                                                
                                                <!-- Benchmarks -->
                                                <div style="background: rgba(34,197,94,0.1); border-radius: 12px; padding: 1.25rem; border: 1px solid rgba(34,197,94,0.3);">
                                                    <h3 style="margin: 0 0 1rem; font-size: 1rem; color: #fff;"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right:6px;vertical-align:middle;"><line x1="18" y1="20" x2="18" y2="10"/><line x1="12" y1="20" x2="12" y2="4"/><line x1="6" y1="20" x2="6" y2="14"/></svg>Industry Benchmarks</h3>
                                                    <p style="color: #9ca3af; font-size: 0.85rem; margin-bottom: 1rem;">${benchmarks.length} benchmarks tracked</p>
                                                    <div style="display: flex; flex-direction: column; gap: 0.5rem; margin-bottom: 1rem;">
                                                        ${benchmarks.slice(0,4).map(b => `
                                                            <div style="display: flex; justify-content: space-between; padding: 0.5rem; background: rgba(0,0,0,0.2); border-radius: 6px;">
                                                                <span style="color: #9ca3af; font-size: 0.8rem;">${b.metric || b.name}</span>
                                                                <span style="color: #4ade80; font-weight: 600; font-size: 0.8rem;">${typeof b.value === 'object' ? JSON.stringify(b.value) : b.value}</span>
                                                            </div>
                                                        `).join('')}
                                                    </div>
                                                    <button class="open-learn-module" data-view="benchmarks" style="width: 100%; padding: 0.75rem; border-radius: 8px; border: none; background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%); color: #fff; cursor: pointer; font-weight: 600;">üìä View All Benchmarks</button>
                                                </div>
                                                
                                                <!-- Best Practices -->
                                                <div style="background: rgba(249,115,22,0.1); border-radius: 12px; padding: 1.25rem; border: 1px solid rgba(249,115,22,0.3);">
                                                    <h3 style="margin: 0 0 1rem; font-size: 1rem; color: #fff;">üìñ Best Practices</h3>
                                                    <p style="color: #9ca3af; font-size: 0.85rem; margin-bottom: 1rem;">${bestPractices.length} practices saved</p>
                                                    <div style="display: flex; flex-direction: column; gap: 0.5rem; margin-bottom: 1rem;">
                                                        ${bestPractices.slice(0,3).map(p => `
                                                            <div style="padding: 0.5rem; background: rgba(0,0,0,0.2); border-radius: 6px; border-left: 3px solid #fb923c;">
                                                                <span style="color: #fed7aa; font-size: 0.8rem; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden;">${(p.practice || p.description || '').substring(0,80)}...</span>
                                                            </div>
                                                        `).join('')}
                                                    </div>
                                                    <button class="open-learn-module" data-view="practices" style="width: 100%; padding: 0.75rem; border-radius: 8px; border: none; background: linear-gradient(135deg, #f97316 0%, #ea580c 100%); color: #fff; cursor: pointer; font-weight: 600;">üìñ View All Practices</button>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <!-- Notes Tab -->
                                        <div class="company-tab-content" id="tab-notes" style="display: none;">
                                            <div style="margin-bottom: 1.5rem;">
                                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                                                    <h3 style="margin: 0; font-size: 1.1rem; color: #fff; font-weight: 600;">üìù Notes & Documentation</h3>
                                                    <button id="add-new-note" style="background: linear-gradient(135deg, #ec4899 0%, #db2777 100%); border: none; padding: 0.5rem 1rem; border-radius: 8px; color: #fff; cursor: pointer; font-weight: 600; font-size: 0.8rem;">+ Add Note</button>
                                                </div>
                                                <p style="color: #6b7280; font-size: 0.85rem;">Store important insights, meeting notes, and documentation about ${company.name}.</p>
                                            </div>
                                            
                                            <!-- Quick Note Form -->
                                            <div id="quick-note-form" style="display: none; margin-bottom: 1.5rem; padding: 1.25rem; background: rgba(0,0,0,0.3); border-radius: 12px; border: 1px solid rgba(168,85,247,0.3);">
                                                <div style="margin-bottom: 1rem;">
                                                    <label style="display: block; color: #a78bfa; font-size: 0.75rem; margin-bottom: 0.25rem;">Category</label>
                                                    <select id="note-category" style="width: 100%; padding: 0.5rem; border-radius: 6px; border: 1px solid rgba(255,255,255,0.2); background: rgba(0,0,0,0.4); color: #fff;">
                                                        <option value="general">General</option>
                                                        <option value="strategy">Strategy</option>
                                                        <option value="meeting">Meeting Notes</option>
                                                        <option value="insight">Insight</option>
                                                        <option value="task">Task/Action</option>
                                                        <option value="research">Research</option>
                                                    </select>
                                                </div>
                                                <div style="margin-bottom: 1rem;">
                                                    <label style="display: block; color: #a78bfa; font-size: 0.75rem; margin-bottom: 0.25rem;">Title</label>
                                                    <input id="note-title" type="text" placeholder="Note title..." style="width: 100%; padding: 0.5rem; border-radius: 6px; border: 1px solid rgba(255,255,255,0.2); background: rgba(0,0,0,0.4); color: #fff; box-sizing: border-box;">
                                                </div>
                                                <div style="margin-bottom: 1rem;">
                                                    <label style="display: block; color: #a78bfa; font-size: 0.75rem; margin-bottom: 0.25rem;">Content</label>
                                                    <textarea id="note-content" placeholder="Write your note here..." rows="4" style="width: 100%; padding: 0.5rem; border-radius: 6px; border: 1px solid rgba(255,255,255,0.2); background: rgba(0,0,0,0.4); color: #fff; resize: vertical; box-sizing: border-box;"></textarea>
                                                </div>
                                                <div style="display: flex; gap: 0.5rem; justify-content: flex-end;">
                                                    <button id="cancel-note" style="padding: 0.5rem 1rem; border-radius: 6px; border: 1px solid rgba(255,255,255,0.2); background: transparent; color: #9ca3af; cursor: pointer;">Cancel</button>
                                                    <button id="save-note-btn" style="background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%); border: none; padding: 0.5rem 1rem; border-radius: 6px; color: #fff; cursor: pointer; font-weight: 600;">Save Note</button>
                                                </div>
                                            </div>
                                            
                                            <!-- Notes List -->
                                            <div id="notes-list">
                                                ${(company.notes_list || []).length > 0 ? 
                                                    (company.notes_list || []).map((note, idx) => `
                                                        <div style="background: rgba(0,0,0,0.2); border-radius: 12px; padding: 1.25rem; margin-bottom: 1rem; border-left: 4px solid ${
                                                            note.category === 'strategy' ? '#8b5cf6' : 
                                                            note.category === 'meeting' ? '#3b82f6' : 
                                                            note.category === 'insight' ? '#ec4899' : 
                                                            note.category === 'task' ? '#f97316' : 
                                                            note.category === 'research' ? '#10b981' : '#6b7280'
                                                        };">
                                                            <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 0.5rem;">
                                                                <div>
                                                                    <span style="display: inline-block; padding: 0.15rem 0.5rem; border-radius: 4px; font-size: 0.65rem; text-transform: uppercase; background: ${
                                                                        note.category === 'strategy' ? 'rgba(139,92,246,0.2)' : 
                                                                        note.category === 'meeting' ? 'rgba(59,130,246,0.2)' : 
                                                                        note.category === 'insight' ? 'rgba(236,72,153,0.2)' : 
                                                                        note.category === 'task' ? 'rgba(249,115,22,0.2)' : 
                                                                        note.category === 'research' ? 'rgba(16,185,129,0.2)' : 'rgba(107,114,128,0.2)'
                                                                    }; color: ${
                                                                        note.category === 'strategy' ? '#c4b5fd' : 
                                                                        note.category === 'meeting' ? '#93c5fd' : 
                                                                        note.category === 'insight' ? '#f9a8d4' : 
                                                                        note.category === 'task' ? '#fdba74' : 
                                                                        note.category === 'research' ? '#6ee7b7' : '#9ca3af'
                                                                    };">${note.category || 'general'}</span>
                                                                    <h4 style="margin: 0.5rem 0 0; color: #fff; font-size: 0.95rem;">${note.title || 'Untitled Note'}</h4>
                                                                </div>
                                                                <span style="color: #6b7280; font-size: 0.7rem;">${note.createdAt ? new Date(note.createdAt).toLocaleDateString() : 'N/A'}</span>
                                                            </div>
                                                            <p style="color: #d1d5db; font-size: 0.85rem; line-height: 1.5; margin: 0; white-space: pre-wrap;">${note.content || ''}</p>
                                                            <div style="margin-top: 0.75rem; display: flex; gap: 0.5rem;">
                                                                <button class="edit-note-btn" data-idx="${idx}" style="padding: 0.25rem 0.5rem; border-radius: 4px; border: 1px solid rgba(255,255,255,0.1); background: transparent; color: #6b7280; cursor: pointer; font-size: 0.7rem;">Edit</button>
                                                                <button class="delete-note-btn" data-idx="${idx}" style="padding: 0.25rem 0.5rem; border-radius: 4px; border: 1px solid rgba(239,68,68,0.3); background: transparent; color: #fca5a5; cursor: pointer; font-size: 0.7rem;">Delete</button>
                                                            </div>
                                                        </div>
                                                    `).join('') :
                                                    `<div style="text-align: center; padding: 3rem; background: rgba(0,0,0,0.2); border-radius: 12px; border: 2px dashed rgba(255,255,255,0.1);">
                                                        <div style="font-size: 3rem; margin-bottom: 1rem;">üìù</div>
                                                        <h4 style="color: #fff; margin: 0 0 0.5rem;">No Notes Yet</h4>
                                                        <p style="color: #6b7280; font-size: 0.85rem; margin: 0;">Click "Add Note" to create your first note for ${company.name}.</p>
                                                    </div>`
                                                }
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Right Sidebar - AI Chat -->
                                    <div style="background: rgba(0,0,0,0.4); border-left: 1px solid rgba(255,255,255,0.1); display: flex; flex-direction: column; overflow: hidden;">
                                        <div style="padding: 1rem 1.25rem; border-bottom: 1px solid rgba(255,255,255,0.1);">
                                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                                <h3 style="margin: 0; font-size: 1rem; color: #fff;">ü§ñ AI Strategy Assistant</h3>
                                                <select id="ai-model-select" style="padding: 0.35rem 0.5rem; border-radius: 6px; border: 1px solid rgba(255,255,255,0.2); background: rgba(0,0,0,0.3); color: #fff; font-size: 0.75rem; cursor: pointer;">
                                                    <option value="gemini-3-flash">Gemini 3 Flash ‚ö°</option>
                                                    <option value="gemini-3-pro">Gemini 3 Pro üß†</option>
                                                    <option value="gemini-2.5-flash">Gemini 2.5 Flash</option>
                                                    <option value="claude-sonnet">Claude Sonnet 4.5 üî•</option>
                                                    <option value="claude-opus">Claude Opus 4.5</option>
                                                    <option value="gpt-5.2">GPT-5.2 (Latest) üöÄ</option>
                                                    <option value="gpt-5-mini">GPT-5 mini</option>
                                                    <option value="gpt-4.1">GPT-4.1</option>
                                                </select>
                                            </div>
                                            <p style="margin: 0.25rem 0 0; font-size: 0.75rem; color: #6b7280;">Ask about ${company.name}'s creative strategy</p>
                                        </div>
                                        
                                        <!-- Chat History Toggle -->
                                        <div style="padding: 0.5rem 1rem; border-bottom: 1px solid rgba(255,255,255,0.05); display: flex; gap: 0.5rem;">
                                            <button id="show-chat-history" style="flex: 1; padding: 0.35rem; border-radius: 4px; border: 1px solid rgba(168,85,247,0.3); background: transparent; color: #c4b5fd; cursor: pointer; font-size: 0.7rem;">üìú History (${(company.chatHistory || []).length})</button>
                                            <button id="clear-chat" style="padding: 0.35rem 0.5rem; border-radius: 4px; border: 1px solid rgba(239,68,68,0.3); background: transparent; color: #fca5a5; cursor: pointer; font-size: 0.7rem;">Clear</button>
                                        </div>
                                        
                                        <div id="ai-chat-messages" style="flex: 1; overflow-y: auto; padding: 1rem;">
                                            ${(company.chatHistory || []).length > 0 ? 
                                                (company.chatHistory || []).slice(-10).map(msg => `
                                                    <div style="display: flex; ${msg.role === 'user' ? 'justify-content: flex-end' : ''}; margin-bottom: 1rem;">
                                                        <div style="background: ${msg.role === 'user' ? 'rgba(168,85,247,0.3)' : 'rgba(59,130,246,0.2)'}; padding: 0.75rem 1rem; border-radius: 12px ${msg.role === 'user' ? '12px 0 12px' : '12px 12px 0'}; max-width: 85%;">
                                                            <div style="font-size: 0.65rem; color: #6b7280; margin-bottom: 0.25rem;">${msg.model || 'AI'} ‚Ä¢ ${new Date(msg.timestamp).toLocaleString()}</div>
                                                            <p style="margin: 0; color: #fff; font-size: 0.9rem; white-space: pre-wrap;">${msg.content.substring(0, 500)}${msg.content.length > 500 ? '...' : ''}</p>
                                                        </div>
                                                    </div>
                                                `).join('') :
                                                `<div style="text-align: center; padding: 2rem; color: #6b7280;">
                                                    <div style="font-size: 3rem; margin-bottom: 0.5rem;">ü§ñ</div>
                                                    <p style="margin: 0 0 1rem;">I can help analyze ${company.name}'s:</p>
                                                    <ul style="text-align: left; list-style: none; padding: 0; margin: 0; font-size: 0.85rem;">
                                                        <li style="padding: 0.25rem 0;">‚Ä¢ Creative performance & hooks</li>
                                                        <li style="padding: 0.25rem 0;">‚Ä¢ Competitive positioning</li>
                                                        <li style="padding: 0.25rem 0;">‚Ä¢ Media strategy recommendations</li>
                                                        <li style="padding: 0.25rem 0;">‚Ä¢ Landing page insights</li>
                                                    </ul>
                                                </div>`
                                            }
                                        </div>
                                        
                                        <!-- Quick Prompts -->
                                        <div style="padding: 0.75rem; border-top: 1px solid rgba(255,255,255,0.1);">
                                            <div style="display: flex; flex-wrap: wrap; gap: 0.5rem; margin-bottom: 0.75rem;">
                                                <button class="ai-quick-prompt" data-prompt="Analyze all creative performance for ${company.name}" style="padding: 0.35rem 0.75rem; border-radius: 999px; border: 1px solid rgba(168,85,247,0.3); background: rgba(168,85,247,0.1); color: #c4b5fd; cursor: pointer; font-size: 0.7rem;">üìà Performance</button>
                                                <button class="ai-quick-prompt" data-prompt="Suggest paid media strategy for ${company.name}" style="padding: 0.35rem 0.75rem; border-radius: 999px; border: 1px solid rgba(59,130,246,0.3); background: rgba(59,130,246,0.1); color: #93c5fd; cursor: pointer; font-size: 0.7rem;">üí∞ Media Plan</button>
                                                <button class="ai-quick-prompt" data-prompt="Compare ${company.name} to competitors" style="padding: 0.35rem 0.75rem; border-radius: 999px; border: 1px solid rgba(249,115,22,0.3); background: rgba(249,115,22,0.1); color: #fb923c; cursor: pointer; font-size: 0.7rem;">üëÄ Compare</button>
                                                <button class="ai-quick-prompt" data-prompt="What creative formats should ${company.name} prioritize?" style="padding: 0.35rem 0.75rem; border-radius: 999px; border: 1px solid rgba(34,197,94,0.3); background: rgba(34,197,94,0.1); color: #86efac; cursor: pointer; font-size: 0.7rem;">üé® Formats</button>
                                                <button class="ai-quick-prompt" data-prompt="Search the internet for ${company.name} and provide latest news, reviews, and market insights" style="padding: 0.35rem 0.75rem; border-radius: 999px; border: 1px solid rgba(236,72,153,0.3); background: rgba(236,72,153,0.1); color: #f9a8d4; cursor: pointer; font-size: 0.7rem;">üîç Web Research</button>
                                            </div>
                                        </div>
                                        
                                        <!-- Chat Input -->
                                        <div style="padding: 0.75rem; border-top: 1px solid rgba(255,255,255,0.1);">
                                            <div style="display: flex; gap: 0.5rem;">
                                                <input type="text" id="ai-chat-input" placeholder="Ask about strategy, creatives, competitors..." style="flex: 1; padding: 0.75rem; border-radius: 8px; border: 1px solid rgba(255,255,255,0.2); background: rgba(0,0,0,0.3); color: #fff; font-size: 0.85rem;">
                                                <button id="ai-chat-send" style="background: linear-gradient(135deg, #8b5cf6 0%, #6366f1 100%); border: none; padding: 0.75rem 1rem; border-radius: 8px; color: #fff; cursor: pointer;">Send</button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `;
                        
                        // Append overlay to body
                        document.body.appendChild(overlay);
                        
                        // Reference the overlay for event listeners
                        const page = overlay;
                        
                        // Close button - remove overlay and show CRM page
                        page.querySelector('.company-detail-close').addEventListener('click', () => {
                            overlay.remove();
                        });
                        
                        // "Go to Overview" button on Strategy tab
                        page.querySelector('.go-to-overview-btn')?.addEventListener('click', () => {
                            const overviewTab = page.querySelector('.company-tab[data-tab="overview"]');
                            if (overviewTab) overviewTab.click();
                        });
                        
                        // Edit company button
                        page.querySelector('#edit-company-btn')?.addEventListener('click', () => {
                            editCompany(company);
                        });
                        
                        // Associate Asset Button
                        page.querySelector('#associate-asset-btn')?.addEventListener('click', () => {
                            const allLibraryAssets = window.cavValidatorApp?.assets || 
                                                    window.cavValidatorApp?.state?.assets || 
                                                    JSON.parse(localStorage.getItem('cav_assets') || '[]');
                            
                            const linkedIds = company.linkedAssets || [];
                            const availableAssets = allLibraryAssets.filter(a => !linkedIds.includes(a.id));
                            
                            // Create asset picker modal
                            const pickerModal = document.createElement('div');
                            pickerModal.style.cssText = 'position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.8);z-index:100002;display:flex;align-items:center;justify-content:center;padding:2rem;';
                            
                            let pickerHTML = '<div style="background:#1a1a1a;border-radius:16px;max-width:800px;width:100%;max-height:80vh;overflow:hidden;display:flex;flex-direction:column;">';
                            pickerHTML += '<div style="padding:1.5rem;border-bottom:1px solid #333;display:flex;justify-content:space-between;align-items:center;">';
                            pickerHTML += '<h3 style="margin:0;color:#fff;">Select Asset to Associate</h3>';
                            pickerHTML += '<button class="picker-close" style="background:none;border:none;color:#999;font-size:1.5rem;cursor:pointer;">√ó</button>';
                            pickerHTML += '</div>';
                            pickerHTML += '<div style="padding:1.5rem;overflow-y:auto;flex:1;">';
                            
                            if (availableAssets.length === 0) {
                                pickerHTML += '<div style="text-align:center;padding:3rem;color:#6b7280;">';
                                pickerHTML += '<p style="font-size:2rem;margin-bottom:1rem;">üì∑</p>';
                                pickerHTML += '<p>No available assets to associate. Upload assets to your library first.</p>';
                                pickerHTML += '</div>';
                            } else {
                                pickerHTML += '<div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(150px,1fr));gap:1rem;">';
                                availableAssets.forEach(a => {
                                    const imgSrc = a.thumbnail_url || a.dataUrl || a.thumbnail;
                                    pickerHTML += '<div class="picker-asset" data-asset-id="' + a.id + '" style="background:#222;border-radius:8px;overflow:hidden;cursor:pointer;transition:transform 0.2s,box-shadow 0.2s;">';
                                    pickerHTML += '<div style="aspect-ratio:1;background:#111;">';
                                    if (imgSrc) {
                                        pickerHTML += '<img src="' + imgSrc + '" style="width:100%;height:100%;object-fit:cover;">';
                                    } else {
                                        pickerHTML += '<div style="width:100%;height:100%;display:flex;align-items:center;justify-content:center;font-size:2rem;">üì∑</div>';
                                    }
                                    pickerHTML += '</div>';
                                    pickerHTML += '<div style="padding:0.5rem;">';
                                    pickerHTML += '<p style="margin:0;font-size:0.75rem;color:#fff;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">' + (a.filename || 'Unknown') + '</p>';
                                    pickerHTML += '</div></div>';
                                });
                                pickerHTML += '</div>';
                            }
                            
                            pickerHTML += '</div></div>';
                            pickerModal.innerHTML = pickerHTML;
                            
                            document.body.appendChild(pickerModal);
                            
                            pickerModal.querySelector('.picker-close').addEventListener('click', () => pickerModal.remove());
                            pickerModal.addEventListener('click', (e) => { if (e.target === pickerModal) pickerModal.remove(); });
                            
                            pickerModal.querySelectorAll('.picker-asset').forEach(card => {
                                card.addEventListener('click', () => {
                                    const assetId = card.dataset.assetId;
                                    const currentLinked = company.linkedAssets || [];
                                    if (!currentLinked.includes(assetId)) {
                                        currentLinked.push(assetId);
                                        window.cavCRM.updateCompany(company.id, { linkedAssets: currentLinked });
                                        alert('Asset associated with ' + company.name + '!');
                                        pickerModal.remove();
                                        overlay.remove();
                                        showCompanyDetailModal(companyId);
                                    }
                                });
                                
                                // Add hover effects
                                card.addEventListener('mouseover', function() {
                                    this.style.transform = 'scale(1.05)';
                                    this.style.boxShadow = '0 4px 12px rgba(236,72,153,0.4)';
                                });
                                card.addEventListener('mouseout', function() {
                                    this.style.transform = 'scale(1)';
                                    this.style.boxShadow = 'none';
                                });
                            });
                        });
                        
                        // Tab switching
                        page.querySelectorAll('.company-tab').forEach(tab => {
                            tab.addEventListener('click', () => {
                                page.querySelectorAll('.company-tab').forEach(t => {
                                    t.classList.remove('active');
                                });
                                page.querySelectorAll('.company-tab-content').forEach(c => c.style.display = 'none');
                                
                                tab.classList.add('active');
                                page.querySelector(`#tab-${tab.dataset.tab}`).style.display = 'block';
                            });
                        });
                        
                        // AI Full Analysis Button
                        page.querySelector('#ai-full-analysis-btn')?.addEventListener('click', async () => {
                            const btn = page.querySelector('#ai-full-analysis-btn');
                            btn.disabled = true;
                            btn.innerHTML = '<span class="cav-spinner"></span> Analyzing...';
                            
                            const chatMessages = page.querySelector('#ai-chat-messages');
                            chatMessages.innerHTML = '<div style="text-align:center;padding:2rem;"><span class="cav-spinner" style="width:40px;height:40px;"></span><p style="color:var(--cav-text-muted);margin-top:1rem;">Running comprehensive AI analysis...</p></div>';
                            
                            try {
                                await sendAIChatMessage(`Provide a comprehensive analysis of ${company.name} including:
1. Creative Performance Summary - based on ${analyses.length} analyses with avg hook score ${avgHookScore}
2. Key Benchmarks (${benchmarks.length} tracked)
3. Competitive Landscape (${competitors.length} competitors)
4. Best Practices (${bestPractices.length} saved)
5. Strategic Recommendations for paid media and creative optimization
6. Priority Action Items`, chatMessages, company);
                            } catch (e) {
                                chatMessages.innerHTML = `<div style="padding:1rem;color:#ef4444;">Error: ${e.message}</div>`;
                            }
                            
                            btn.disabled = false;
                            btn.innerHTML = '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M12 16v-4M12 8h.01"/></svg> AI Analysis';
                        });
                        
                        // Fetch Competitors Button
                        page.querySelector('#fetch-competitors-btn')?.addEventListener('click', async () => {
                            const btn = page.querySelector('#fetch-competitors-btn');
                            btn.disabled = true;
                            btn.innerHTML = '<span class="cav-spinner" style="width:16px;height:16px;"></span> Detecting competitors...';
                            
                            try {
                                let newCompetitors = [];
                                
                                // Try Learn module first
                                if (window.CAVLearn?.autoFetchCompetitors) {
                                    newCompetitors = await window.CAVLearn.autoFetchCompetitors(company.name, company.industry);
                                }
                                
                                // Fallback: Direct Gemini API if no competitors found
                                if ((!newCompetitors || newCompetitors.length === 0) && window.geminiApiKey) {
                                    console.log('[CRM] Using direct Gemini fallback for competitors');
                                    const prompt = `List the top 3 direct competitors of ${company.name} in the ${company.industry || 'same'} industry.
Return ONLY a JSON array with 3 competitors:
[{"name":"Company Name","website":"https://example.com","description":"Brief description","marketPosition":"leader"}]
JSON only, no markdown:`;
                                    
                                    try {
                                        const response = await fetch('https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=' + window.geminiApiKey, {
                                            method: 'POST',
                                            headers: { 'Content-Type': 'application/json' },
                                            body: JSON.stringify({
                                                contents: [{ parts: [{ text: prompt }] }],
                                                generationConfig: { temperature: 0.3 }
                                            })
                                        });
                                        const data = await response.json();
                                        const text = data.candidates?.[0]?.content?.parts?.[0]?.text || '';
                                        const jsonMatch = text.match(/\[[\s\S]*?\]/);
                                        if (jsonMatch) {
                                            const parsed = JSON.parse(jsonMatch[0]);
                                            newCompetitors = parsed.slice(0, 3).map(c => ({
                                                name: c.name,
                                                website: c.website,
                                                description: c.description,
                                                marketPosition: c.marketPosition,
                                                source: 'AI Generated',
                                                addedAt: new Date().toISOString()
                                            }));
                                        }
                                    } catch (e) {
                                        console.error('[CRM] Gemini competitor fetch failed:', e);
                                    }
                                }
                                
                                if (newCompetitors?.length > 0) {
                                    for (const comp of newCompetitors) {
                                        window.cavCRM.addCompetitorToCompany(companyId, comp);
                                    }
                                    alert('‚úÖ Found ' + newCompetitors.length + ' competitors!');
                                    showCompanyDetailModal(companyId); // Refresh the page
                                } else {
                                    alert('No competitors found. Please configure Gemini API key in Settings for AI detection.');
                                }
                            } catch (e) {
                                console.error('[CRM] Competitor detection error:', e);
                                alert('Error: ' + e.message);
                            }
                            
                            btn.disabled = false;
                            btn.innerHTML = '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><path d="M21 21l-4.35-4.35"/></svg> Auto-Detect with AI';
                        });
                        
                        // Enrich Company Data Button
                        page.querySelector('#enrich-company-btn')?.addEventListener('click', async () => {
                            const btn = page.querySelector('#enrich-company-btn');
                            btn.disabled = true;
                            btn.innerHTML = '<span class="cav-spinner" style="width:14px;height:14px;"></span> Researching...';
                            
                            try {
                                const geminiKey = localStorage.getItem('cav_gemini_api_key') || '';
                                if (!geminiKey) {
                                    alert('Please configure your Gemini API key in Settings.');
                                    btn.disabled = false;
                                    btn.textContent = 'üîç Enrich Company Data';
                                    return;
                                }
                                
                                const prompt = `You are a business intelligence researcher. Research the company "${company.name}" and provide comprehensive public information.

The company operates in: ${company.industry || 'technology/business'}
Their website is: ${company.website || 'unknown'}

Return ONLY a valid JSON object with this exact structure (no markdown, no explanation):
{
    "founded": "Year founded (e.g., '2004')",
    "employees": "Number of employees (e.g., '10,000+' or '500-1000')",
    "revenue": "Annual revenue estimate (e.g., '$500M' or '$1.2B')",
    "headquarters": "City, Country",
    "stockSymbol": "Stock ticker if public (e.g., 'NASDAQ: AAPL') or 'Private'",
    "marketCap": "Market cap if public (e.g., '$50B') or 'N/A'",
    "description": "2-3 sentence company description",
    "ceo": "CEO name",
    "founded_by": "Founder names",
    "keyProducts": ["Product 1", "Product 2", "Product 3"],
    "recentNews": ["Recent news headline 1", "Recent news headline 2", "Recent news headline 3"],
    "socialMedia": {
        "linkedin": "followers count",
        "twitter": "followers count"
    },
    "competitors": ["Competitor 1", "Competitor 2", "Competitor 3"]
}

Provide accurate, up-to-date information. If unknown, use "Unknown" or omit the field.`;
                                
                                const res = await fetch(
                                    'https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=' + geminiKey,
                                    {
                                        method: 'POST',
                                        headers: { 'Content-Type': 'application/json' },
                                        body: JSON.stringify({
                                            contents: [{ parts: [{ text: prompt }] }],
                                            generationConfig: { temperature: 0.3, maxOutputTokens: 2048 }
                                        })
                                    }
                                );
                                const data = await res.json();
                                const responseText = data.candidates?.[0]?.content?.parts?.[0]?.text || '';
                                
                                // Parse enriched data from response
                                const jsonMatch = responseText.match(/\{[\s\S]*\}/);
                                if (jsonMatch) {
                                    const enrichedData = JSON.parse(jsonMatch[0]);
                                    enrichedData.updatedAt = new Date().toISOString();
                                    
                                    // Update company with enriched data
                                    window.cavCRM.updateCompany(companyId, { enrichedData });
                                    
                                    // Also add any detected competitors
                                    if (enrichedData.competitors?.length > 0) {
                                        for (const compName of enrichedData.competitors) {
                                            if (!company.competitors?.find(c => c.name === compName)) {
                                                window.cavCRM.addCompetitorToCompany(companyId, { 
                                                    name: compName, 
                                                    source: 'AI Research',
                                                    addedAt: new Date().toISOString()
                                                });
                                            }
                                        }
                                    }
                                    
                                    alert('‚úÖ Company data enriched successfully!');
                                    showCompanyDetailModal(companyId); // Refresh page
                                } else {
                                    alert('Could not parse company data. Try again.');
                                }
                            } catch (e) {
                                console.error('Enrich company error:', e);
                                alert('Error enriching company: ' + e.message);
                            }
                            
                            btn.disabled = false;
                            btn.innerHTML = '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><path d="M21 21l-4.35-4.35"/></svg> Enrich Data';
                        });
                        
                        // Generate AI Strategy Button
                        page.querySelector('#generate-strategy-btn')?.addEventListener('click', async () => {
                            const btn = page.querySelector('#generate-strategy-btn');
                            btn.disabled = true;
                            btn.innerHTML = '<span class="cav-spinner" style="width:14px;height:14px;"></span> Generating Strategy...';
                            
                            // Hide placeholder, show content area
                            const placeholder = page.querySelector('#strategy-placeholder');
                            const contentArea = page.querySelector('#strategy-insights-content');
                            if (placeholder) placeholder.style.display = 'none';
                            if (contentArea) contentArea.style.display = 'block';
                            
                            // Show loading in each section
                            const sections = ['creative-strategy-content', 'paid-media-strategy-content', 'performance-trends-content', 'action-items-content', 'recommendations-content'];
                            sections.forEach(id => {
                                const el = page.querySelector('#' + id);
                                if (el) el.innerHTML = '<div style="text-align:center;padding:1rem;"><span class="cav-spinner" style="width:20px;height:20px;"></span><p style="margin:0.5rem 0 0;color:#6b7280;font-size:0.8rem;">Analyzing...</p></div>';
                            });
                            
                            try {
                                const geminiKey = localStorage.getItem('cav_gemini_api_key') || '';
                                if (!geminiKey) {
                                    alert('Please configure your Gemini API key in Settings.');
                                    btn.disabled = false;
                                    btn.innerHTML = '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2a10 10 0 1 0 10 10"/><path d="M12 6v6l4 2"/></svg> Generate AI Strategy';
                                    return;
                                }
                                
                                // Gather all company data for analysis
                                const analysisData = {
                                    companyName: company.name,
                                    industry: company.industry || 'Digital Marketing',
                                    website: company.website || '',
                                    assetCount: assets.length,
                                    analysisCount: analyses.length,
                                    avgHookScore: avgHookScore,
                                    avgCtaScore: avgCtaScore,
                                    benchmarks: benchmarks.map(b => b.metric + ': ' + (typeof b.value === 'object' ? JSON.stringify(b.value) : b.value)).join('; '),
                                    bestPractices: bestPractices.slice(0,5).map(p => p.practice || p.description).join('; '),
                                    competitors: competitors.map(c => c.name).join(', '),
                                    urlAnalyses: urlAnalyses.slice(0,3).map(u => u.url).join(', '),
                                    enrichedData: company.enrichedData || {}
                                };
                                
                                const prompt = 'You are an expert creative strategist and paid media specialist. Analyze this company data and provide comprehensive strategic recommendations. Return a JSON object with these exact keys:\n\n' +
                                    '1. "creativeStrategy": A detailed 2-3 paragraph analysis of creative strategy recommendations based on the assets, analyses, and best practices. Include specific recommendations for ad formats, messaging, visuals, and hooks.\n\n' +
                                    '2. "paidMediaStrategy": A detailed 2-3 paragraph paid media strategy including channel recommendations (Meta, Google, TikTok, LinkedIn, etc.), budget allocation suggestions, targeting strategies, and campaign structures.\n\n' +
                                    '3. "performanceTrends": Analysis of performance patterns from the benchmarks and analyses. Identify what is working, what needs improvement, and industry comparisons.\n\n' +
                                    '4. "actionItems": A bullet list (use <ul><li> HTML) of 5-7 specific, prioritized action items the team should implement immediately.\n\n' +
                                    '5. "recommendations": A summary of the top 3-5 strategic recommendations that will have the biggest impact.\n\n' +
                                    'Company Data:\n' + JSON.stringify(analysisData, null, 2) + '\n\n' +
                                    'Return ONLY valid JSON, no markdown code blocks.';
                                
                                const res = await fetch('https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=' + geminiKey, {
                                    method: 'POST',
                                    headers: { 'Content-Type': 'application/json' },
                                    body: JSON.stringify({
                                        contents: [{ parts: [{ text: prompt }] }],
                                        generationConfig: { temperature: 0.7, maxOutputTokens: 4096 }
                                    })
                                });
                                
                                const data = await res.json();
                                const responseText = data.candidates?.[0]?.content?.parts?.[0]?.text || '';
                                
                                // Parse strategy data from response
                                const jsonMatch = responseText.match(/\{[\s\S]*\}/);
                                if (jsonMatch) {
                                    const strategyInsights = JSON.parse(jsonMatch[0]);
                                    strategyInsights.generatedAt = new Date().toISOString();
                                    
                                    // Update company with strategy insights
                                    window.cavCRM.updateCompany(companyId, { strategyInsights });
                                    
                                    // Update UI with the generated content
                                    const creativeEl = page.querySelector('#creative-strategy-content');
                                    const paidEl = page.querySelector('#paid-media-strategy-content');
                                    const trendsEl = page.querySelector('#performance-trends-content');
                                    const actionsEl = page.querySelector('#action-items-content');
                                    const recsEl = page.querySelector('#recommendations-content');
                                    
                                    if (creativeEl) creativeEl.innerHTML = strategyInsights.creativeStrategy || '<p>No data</p>';
                                    if (paidEl) paidEl.innerHTML = strategyInsights.paidMediaStrategy || '<p>No data</p>';
                                    if (trendsEl) trendsEl.innerHTML = strategyInsights.performanceTrends || '<p>No data</p>';
                                    if (actionsEl) actionsEl.innerHTML = strategyInsights.actionItems || '<p>No data</p>';
                                    if (recsEl) recsEl.innerHTML = strategyInsights.recommendations || '<p>No data</p>';
                                    
                                    // Also save to chat history
                                    if (!company.chatHistory) company.chatHistory = [];
                                    company.chatHistory.push({
                                        timestamp: new Date().toISOString(),
                                        prompt: 'Generated comprehensive strategy analysis',
                                        response: 'Strategy generated with creative, paid media, trends, and action items.',
                                        model: 'gemini-2.5-flash'
                                    });
                                    window.cavCRM.updateCompany(companyId, { chatHistory: company.chatHistory });
                                    
                                    alert('‚úÖ Strategy generated successfully!');
                                } else {
                                    alert('Could not generate strategy. Try again.');
                                    sections.forEach(id => {
                                        const el = page.querySelector('#' + id);
                                        if (el) el.innerHTML = '<p style="color:#6b7280;">Generation failed. Please try again.</p>';
                                    });
                                }
                            } catch (e) {
                                console.error('Generate strategy error:', e);
                                alert('Error generating strategy: ' + e.message);
                            }
                            
                            btn.disabled = false;
                            btn.innerHTML = '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2a10 10 0 1 0 10 10"/><path d="M12 6v6l4 2"/></svg> Generate AI Strategy';
                        });
                        
                        // Fetch Industry Benchmarks Button
                        page.querySelector('#fetch-benchmarks-btn')?.addEventListener('click', async () => {
                            const btn = page.querySelector('#fetch-benchmarks-btn');
                            btn.disabled = true;
                            btn.innerHTML = '<span class="cav-spinner" style="width:14px;height:14px;"></span> Fetching...';
                            
                            try {
                                const geminiKey = localStorage.getItem('cav_gemini_api_key') || '';
                                if (!geminiKey) {
                                    alert('Please configure your Gemini API key in Settings.');
                                    return;
                                }
                                
                                const prompt = `You are an industry research analyst. Provide real, current industry benchmarks for the ${company.industry || 'digital marketing'} industry, specifically for a company like ${company.name}.

Return ONLY a valid JSON array of benchmark objects. No markdown, no explanation, just the JSON array.

Format:
[
  {"metric": "CTR (Click-Through Rate)", "value": "1.5-3.0%", "industry": "${company.industry || 'Digital Marketing'}", "source": "Industry Average 2024"},
  {"metric": "CPM (Cost Per Mille)", "value": "$7-15", "industry": "${company.industry || 'Digital Marketing'}", "source": "Meta Ads Benchmark"},
  {"metric": "Conversion Rate", "value": "2.5-5%", "industry": "${company.industry || 'Digital Marketing'}", "source": "E-commerce Average"},
  {"metric": "ROAS (Return on Ad Spend)", "value": "4:1 - 6:1", "industry": "${company.industry || 'Digital Marketing'}", "source": "Industry Standard"},
  {"metric": "Engagement Rate", "value": "3-6%", "industry": "${company.industry || 'Digital Marketing'}", "source": "Social Media Benchmark"},
  {"metric": "Video View Rate", "value": "15-25%", "industry": "${company.industry || 'Digital Marketing'}", "source": "Video Ads Average"},
  {"metric": "Email Open Rate", "value": "15-25%", "industry": "${company.industry || 'Digital Marketing'}", "source": "Email Marketing Benchmark"},
  {"metric": "Bounce Rate", "value": "40-55%", "industry": "${company.industry || 'Digital Marketing'}", "source": "Landing Page Average"}
]

Provide accurate, realistic benchmarks. Return ONLY the JSON array.`;
                                
                                const res = await fetch(
                                    'https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=' + geminiKey,
                                    {
                                        method: 'POST',
                                        headers: { 'Content-Type': 'application/json' },
                                        body: JSON.stringify({
                                            contents: [{ parts: [{ text: prompt }] }],
                                            generationConfig: { temperature: 0.3, maxOutputTokens: 2048 }
                                        })
                                    }
                                );
                                const data = await res.json();
                                const responseText = data.candidates?.[0]?.content?.parts?.[0]?.text || '';
                                
                                // Parse benchmarks from response
                                const jsonMatch = responseText.match(/\[[\s\S]*\]/);
                                if (jsonMatch) {
                                    const newBenchmarks = JSON.parse(jsonMatch[0]);
                                    // Add to company benchmarks
                                    if (!company.benchmarks) company.benchmarks = [];
                                    for (const benchmark of newBenchmarks) {
                                        if (!company.benchmarks.find(b => b.metric === benchmark.metric)) {
                                            company.benchmarks.push({
                                                ...benchmark,
                                                addedAt: new Date().toISOString(),
                                                addedBy: 'AI Research'
                                            });
                                        }
                                    }
                                    window.cavCRM.updateCompany(companyId, { benchmarks: company.benchmarks });
                                    alert('‚úÖ Added ' + newBenchmarks.length + ' industry benchmarks!');
                                    showCompanyDetailModal(companyId); // Refresh page
                                } else {
                                    alert('Could not parse benchmarks. Try again.');
                                }
                            } catch (e) {
                                console.error('Benchmark fetch error:', e);
                                alert('Error fetching benchmarks: ' + e.message);
                            }
                            
                            btn.disabled = false;
                            btn.innerHTML = '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 3v18h18"/><path d="M18.7 8l-5.1 5.2-2.8-2.7L7 14.3"/></svg> Get Benchmarks';
                        });
                        
                        // AI Chat functionality
                        const chatInput = page.querySelector('#ai-chat-input');
                        const chatSend = page.querySelector('#ai-chat-send');
                        const chatMessages = page.querySelector('#ai-chat-messages');
                        const modelSelect = page.querySelector('#ai-model-select');
                        
                        // Clear chat button
                        page.querySelector('#clear-chat')?.addEventListener('click', () => {
                            if (confirm('Clear all chat history for this company?')) {
                                company.chatHistory = [];
                                window.cavCRM.updateCompany(companyId, { chatHistory: [] });
                                chatMessages.innerHTML = `<div style="text-align: center; padding: 2rem; color: var(--cav-text-muted);">
                                    <svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin: 0 auto 0.5rem; display: block;"><circle cx="12" cy="12" r="10"/><path d="M12 16v-4M12 8h.01"/></svg>
                                    <p style="margin: 0;">Chat history cleared. Start a new conversation!</p>
                                </div>`;
                            }
                        });
                        
                        async function sendAIChatMessage(message, messagesContainer, companyData) {
                            if (!message.trim()) return;
                            
                            const selectedModel = modelSelect?.value || 'gemini';
                            const modelLabels = { 
                                'gemini-3-flash': 'Gemini 3 Flash',
                                'gemini-3-pro': 'Gemini 3 Pro',
                                'gemini-2.5-flash': 'Gemini 2.5 Flash',
                                'claude-sonnet': 'Claude Sonnet 4.5',
                                'claude-opus': 'Claude Opus 4.5',
                                'gpt-5.2': 'GPT-5.2',
                                'gpt-5-mini': 'GPT-5 mini',
                                'gpt-4.1': 'GPT-4.1'
                            };
                            
                            // Save user message to history
                            const userMsg = { role: 'user', content: message, timestamp: new Date().toISOString(), model: 'User' };
                            if (!companyData.chatHistory) companyData.chatHistory = [];
                            companyData.chatHistory.push(userMsg);
                            
                            // Add user message to UI
                            messagesContainer.innerHTML += `
                                <div style="display: flex; justify-content: flex-end; margin-bottom: 1rem;">
                                    <div style="background: rgba(168,85,247,0.3); padding: 0.75rem 1rem; border-radius: 12px 12px 0 12px; max-width: 85%;">
                                        <div style="font-size: 0.65rem; color: #6b7280; margin-bottom: 0.25rem;">${new Date().toLocaleString()}</div>
                                        <p style="margin: 0; color: #fff; font-size: 0.9rem;">${message}</p>
                                    </div>
                                </div>
                            `;
                            
                            // Add loading
                            const loadingId = 'loading-' + Date.now();
                            messagesContainer.innerHTML += `
                                <div id="${loadingId}" style="display: flex; margin-bottom: 1rem;">
                                    <div style="background: rgba(59,130,246,0.2); padding: 0.75rem 1rem; border-radius: 12px 12px 12px 0; max-width: 85%;">
                                        <p style="margin: 0; color: #9ca3af;">ü§ñ ${modelLabels[selectedModel]} thinking...</p>
                                    </div>
                                </div>
                            `;
                            messagesContainer.scrollTop = messagesContainer.scrollHeight;
                            if (chatInput) chatInput.value = '';
                            
                            const contextPrompt = `You are an AI creative strategist analyzing ${companyData.name}.

COMPANY CONTEXT:
- Industry: ${companyData.industry || 'Unknown'}
- Type: ${companyData.type || 'client'}
- Website: ${companyData.website || 'Not set'}
- Assets: ${assets.length} linked creatives
- Analyses: ${analyses.length} creative analyses (Avg Hook: ${avgHookScore}, Avg CTA: ${avgCtaScore})
- Benchmarks: ${benchmarks.length} performance benchmarks
- Best Practices: ${bestPractices.length} saved practices
- Competitors: ${competitors.length} tracked
- Swipe Files: ${swipeFiles.length} creative examples

BENCHMARKS DATA:
${benchmarks.slice(0,10).map(b => `- ${b.metric || b.name}: ${typeof b.value === 'object' ? JSON.stringify(b.value) : b.value}`).join('\\n')}

BEST PRACTICES:
${bestPractices.slice(0,5).map(p => `- ${p.practice || p.description}`).join('\\n')}

USER QUESTION: ${message}

Provide actionable, specific strategic advice. Use data points where available. Format with clear sections and bullet points.`;

                            try {
                                let response = '';
                                const geminiKey = localStorage.getItem('cav_gemini_api_key') || window.CAVSettings?.getAPIKey?.('gemini') || '';
                                const claudeKey = localStorage.getItem('cav_claude_api_key') || window.CAVSettings?.getAPIKey?.('claude') || '';
                                const openaiKey = localStorage.getItem('cav_openai_api_key') || window.CAVSettings?.getAPIKey?.('openai') || '';
                                
                                // Claude models (Sonnet 4.5 or Opus 4.5) - https://platform.claude.com/docs
                                if ((selectedModel === 'claude-sonnet' || selectedModel === 'claude-opus') && claudeKey) {
                                    const claudeModel = selectedModel === 'claude-opus' ? 'claude-opus-4-5-20250929' : 'claude-sonnet-4-5-20250929';
                                    const res = await fetch('https://api.anthropic.com/v1/messages', {
                                        method: 'POST',
                                        headers: {
                                            'Content-Type': 'application/json',
                                            'x-api-key': claudeKey,
                                            'anthropic-version': '2023-06-01',
                                            'anthropic-dangerous-direct-browser-access': 'true'
                                        },
                                        body: JSON.stringify({
                                            model: claudeModel,
                                            max_tokens: 8192,
                                            messages: [{ role: 'user', content: contextPrompt }]
                                        })
                                    });
                                    const data = await res.json();
                                    response = data.content?.[0]?.text || data.error?.message || 'No response received';
                                } 
                                // OpenAI models (GPT-5.2, GPT-5 mini, GPT-4.1) - https://platform.openai.com/docs/models
                                else if ((selectedModel === 'gpt-5.2' || selectedModel === 'gpt-5-mini' || selectedModel === 'gpt-4.1') && openaiKey) {
                                    const openaiModel = selectedModel; // Model names match API IDs
                                    const res = await fetch('https://api.openai.com/v1/chat/completions', {
                                        method: 'POST',
                                        headers: {
                                            'Content-Type': 'application/json',
                                            'Authorization': 'Bearer ' + openaiKey
                                        },
                                        body: JSON.stringify({
                                            model: openaiModel,
                                            messages: [{ role: 'user', content: contextPrompt }],
                                            max_tokens: 8192
                                        })
                                    });
                                    const data = await res.json();
                                    response = data.choices?.[0]?.message?.content || data.error?.message || 'No response received';
                                } 
                                // Gemini models (3 Flash, 3 Pro, 2.5 Flash) - https://ai.google.dev/gemini-api/docs/models
                                else if (geminiKey) {
                                    const geminiModelMap = {
                                        'gemini-3-flash': 'gemini-3-flash-preview',
                                        'gemini-3-pro': 'gemini-3-pro-preview',
                                        'gemini-2.5-flash': 'gemini-2.5-flash'
                                    };
                                    const geminiModel = geminiModelMap[selectedModel] || 'gemini-2.5-flash';
                                    const res = await fetch(
                                        `https://generativelanguage.googleapis.com/v1beta/models/${geminiModel}:generateContent?key=` + geminiKey,
                                        {
                                            method: 'POST',
                                            headers: { 'Content-Type': 'application/json' },
                                            body: JSON.stringify({
                                                contents: [{ parts: [{ text: contextPrompt }] }],
                                                generationConfig: { temperature: 0.7, maxOutputTokens: 8192 }
                                            })
                                        }
                                    );
                                    const data = await res.json();
                                    response = data.candidates?.[0]?.content?.parts?.[0]?.text || 'No response received';
                                } else {
                                    response = `‚ö†Ô∏è No API key configured for ${modelLabels[selectedModel] || selectedModel}. Please set up API keys in Settings to enable AI chat.`;
                                }
                                
                                // Save AI response to history
                                const aiMsg = { role: 'assistant', content: response, timestamp: new Date().toISOString(), model: modelLabels[selectedModel] };
                                companyData.chatHistory.push(aiMsg);
                                
                                // Persist chat history to CRM
                                window.cavCRM.updateCompany(companyId, { chatHistory: companyData.chatHistory });
                                
                                // Update history count button
                                const historyBtn = page.querySelector('#show-chat-history');
                                if (historyBtn) historyBtn.textContent = 'üìú History (' + companyData.chatHistory.length + ')';
                                
                                // Remove loading and add response
                                document.getElementById(loadingId)?.remove();
                                messagesContainer.innerHTML += `
                                    <div style="display: flex; margin-bottom: 1rem;">
                                        <div style="background: rgba(59,130,246,0.2); padding: 1rem; border-radius: 12px 12px 12px 0; max-width: 85%;">
                                            <div style="font-size: 0.65rem; color: #6b7280; margin-bottom: 0.25rem;">${modelLabels[selectedModel]} ‚Ä¢ ${new Date().toLocaleString()}</div>
                                            <div style="color: #fff; font-size: 0.9rem; line-height: 1.6; white-space: pre-wrap;">${response}</div>
                                        </div>
                                    </div>
                                `;
                                messagesContainer.scrollTop = messagesContainer.scrollHeight;
                                
                            } catch (e) {
                                document.getElementById(loadingId)?.remove();
                                messagesContainer.innerHTML += `
                                    <div style="display: flex; margin-bottom: 1rem;">
                                        <div style="background: rgba(239,68,68,0.2); padding: 0.75rem 1rem; border-radius: 12px; max-width: 85%;">
                                            <p style="margin: 0; color: #fca5a5;">Error: ${e.message}</p>
                                        </div>
                                    </div>
                                `;
                            }
                        }
                        
                        chatSend?.addEventListener('click', () => sendAIChatMessage(chatInput.value, chatMessages, company));
                        chatInput?.addEventListener('keypress', (e) => {
                            if (e.key === 'Enter') sendAIChatMessage(chatInput.value, chatMessages, company);
                        });
                        
                        // Quick prompt buttons
                        page.querySelectorAll('.ai-quick-prompt').forEach(btn => {
                            btn.addEventListener('click', () => {
                                sendAIChatMessage(btn.dataset.prompt, chatMessages, company);
                            });
                        });
                        
                        // Asset preview functionality
                        page.querySelectorAll('.company-asset-card').forEach(card => {
                            card.addEventListener('mouseenter', () => {
                                card.querySelector('.asset-preview-overlay').style.opacity = '1';
                            });
                            card.addEventListener('mouseleave', () => {
                                card.querySelector('.asset-preview-overlay').style.opacity = '0';
                            });
                            card.addEventListener('click', () => {
                                const idx = parseInt(card.dataset.assetIdx);
                                const asset = assets[idx];
                                if (!asset) return;
                                
                                const previewModal = document.createElement('div');
                                previewModal.style.cssText = 'position: fixed; inset: 0; z-index: 100002; background: rgba(0,0,0,0.95); display: flex; flex-direction: column;';
                                previewModal.innerHTML = `
                                    <div style="padding: 1rem 2rem; display: flex; justify-content: space-between; align-items: center; background: rgba(0,0,0,0.5);">
                                        <div>
                                            <h3 style="margin: 0; color: #fff;">${asset.filename}</h3>
                                            <p style="margin: 0.25rem 0 0; color: #6b7280; font-size: 0.85rem;">${asset.width || '?'}√ó${asset.height || '?'} ‚Ä¢ ${asset.type || 'image'}</p>
                                        </div>
                                        <div style="display: flex; gap: 0.75rem; align-items: center;">
                                            <button id="prev-asset" style="background: rgba(255,255,255,0.1); border: none; width: 40px; height: 40px; border-radius: 50%; color: #fff; cursor: pointer; font-size: 1.25rem;">‚Üê</button>
                                            <span style="color: #6b7280; font-size: 0.85rem;">${idx + 1} / ${assets.length}</span>
                                            <button id="next-asset" style="background: rgba(255,255,255,0.1); border: none; width: 40px; height: 40px; border-radius: 50%; color: #fff; cursor: pointer; font-size: 1.25rem;">‚Üí</button>
                                            <button id="close-preview" style="background: rgba(239,68,68,0.2); border: none; width: 40px; height: 40px; border-radius: 50%; color: #fca5a5; cursor: pointer; font-size: 1.25rem;">‚úï</button>
                                        </div>
                                    </div>
                                    <div style="flex: 1; display: flex; align-items: center; justify-content: center; padding: 2rem; overflow: auto;">
                                        <img src="${asset.thumbnail_url || asset.dataUrl || asset.thumbnail}" style="max-width: 100%; max-height: 100%; object-fit: contain; border-radius: 8px; box-shadow: 0 8px 32px rgba(0,0,0,0.5);">
                                    </div>
                                    <div style="padding: 1rem 2rem; background: rgba(0,0,0,0.5); display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1rem;">
                                        ${asset.validation ? `
                                            <div>
                                                <p style="margin: 0; font-size: 0.75rem; color: #6b7280;">Compatible Channels</p>
                                                <p style="margin: 0.25rem 0 0; color: #4ade80; font-size: 0.9rem;">${(asset.validation.compatible_channels || []).join(', ') || 'None'}</p>
                                            </div>
                                        ` : ''}
                                        <div>
                                            <p style="margin: 0; font-size: 0.75rem; color: #6b7280;">Status</p>
                                            <p style="margin: 0.25rem 0 0; color: #fff; font-size: 0.9rem;">${asset.status || 'DRAFT'}</p>
                                        </div>
                                        <div>
                                            <p style="margin: 0; font-size: 0.75rem; color: #6b7280;">File Size</p>
                                            <p style="margin: 0.25rem 0 0; color: #fff; font-size: 0.9rem;">${asset.fileSize ? (asset.fileSize / 1024 / 1024).toFixed(2) + ' MB' : 'Unknown'}</p>
                                        </div>
                                        <div>
                                            <p style="margin: 0; font-size: 0.75rem; color: #6b7280;">Uploaded</p>
                                            <p style="margin: 0.25rem 0 0; color: #fff; font-size: 0.9rem;">${asset.uploadedAt ? new Date(asset.uploadedAt).toLocaleDateString() : 'Unknown'}</p>
                                        </div>
                                    </div>
                                `;
                                document.body.appendChild(previewModal);
                                
                                let currentIdx = idx;
                                
                                const updatePreview = () => {
                                    const a = assets[currentIdx];
                                    previewModal.querySelector('img').src = a.thumbnail_url || a.dataUrl || a.thumbnail;
                                    previewModal.querySelector('h3').textContent = a.filename;
                                };
                                
                                previewModal.querySelector('#close-preview').addEventListener('click', () => previewModal.remove());
                                previewModal.querySelector('#prev-asset').addEventListener('click', () => {
                                    currentIdx = (currentIdx - 1 + assets.length) % assets.length;
                                    updatePreview();
                                });
                                previewModal.querySelector('#next-asset').addEventListener('click', () => {
                                    currentIdx = (currentIdx + 1) % assets.length;
                                    updatePreview();
                                });
                                previewModal.addEventListener('click', (e) => {
                                    if (e.target === previewModal) previewModal.remove();
                                });
                                document.addEventListener('keydown', function escHandler(e) {
                                    if (e.key === 'Escape') {
                                        previewModal.remove();
                                        document.removeEventListener('keydown', escHandler);
                                    }
                                    if (e.key === 'ArrowLeft') {
                                        currentIdx = (currentIdx - 1 + assets.length) % assets.length;
                                        updatePreview();
                                    }
                                    if (e.key === 'ArrowRight') {
                                        currentIdx = (currentIdx + 1) % assets.length;
                                        updatePreview();
                                    }
                                });
                            });
                        });
                        
                        // Strategy module buttons
                        page.querySelectorAll('.open-strategy-module').forEach(btn => {
                            btn.addEventListener('click', () => {
                                const view = btn.dataset.view;
                                overlay.remove();
                                // Open Strategy module
                                if (window.CAVStrategy) {
                                    window.CAVStrategy.setCurrentCompany?.(companyId);
                                    showV3Module?.('strategy');
                                } else {
                                    alert('Strategy module not loaded. Click Strategy in the navigation.');
                                }
                            });
                        });
                        
                        // Learn module buttons
                        page.querySelectorAll('.open-learn-module').forEach(btn => {
                            btn.addEventListener('click', () => {
                                const view = btn.dataset.view;
                                overlay.remove();
                                // Open Learn module
                                if (window.CAVLearn) {
                                    window.CAVLearn.setCurrentCompany?.(companyId);
                                    showV3Module?.('learn');
                                } else {
                                    alert('Learn module not loaded. Click Learn in the navigation.');
                                }
                            });
                        });
                        
                        // URL Analyzer in Learn tab
                        const urlAnalyzeBtn = page.querySelector('.analyze-url-btn');
                        const urlInput = page.querySelector('#company-url-input');
                        if (urlAnalyzeBtn && urlInput) {
                            urlAnalyzeBtn.addEventListener('click', async () => {
                                const url = urlInput.value.trim();
                                if (!url) {
                                    alert('Please enter a URL to analyze');
                                    return;
                                }
                                
                                urlAnalyzeBtn.innerHTML = '‚è≥ Analyzing...';
                                urlAnalyzeBtn.disabled = true;
                                
                                try {
                                    if (window.CAVLearn?.analyzeURL) {
                                        const analysis = await window.CAVLearn.analyzeURL(url);
                                        // Save to company
                                        if (!company.urlAnalyses) company.urlAnalyses = [];
                                        company.urlAnalyses.push({
                                            url,
                                            analyzedAt: new Date().toISOString(),
                                            ...analysis
                                        });
                                        window.cavCRM.updateCompany(companyId, { urlAnalyses: company.urlAnalyses });
                                        alert('‚úÖ URL analyzed and saved to company!');
                                        overlay.remove();
                                        showCompanyDetailModal(companyId);
                                    } else {
                                        alert('URL Analyzer not loaded. Use the Learn module to analyze URLs.');
                                    }
                                } catch (e) {
                                    alert('Error analyzing URL: ' + e.message);
                                }
                                
                                urlAnalyzeBtn.innerHTML = 'üîç Analyze URL';
                                urlAnalyzeBtn.disabled = false;
                            });
                        }
                        
                        // Notes functionality
                        const addNoteBtn = page.querySelector('#add-new-note');
                        const noteForm = page.querySelector('#quick-note-form');
                        const cancelNoteBtn = page.querySelector('#cancel-note');
                        const saveNoteBtn = page.querySelector('#save-note-btn');
                        
                        if (addNoteBtn && noteForm) {
                            addNoteBtn.addEventListener('click', () => {
                                noteForm.style.display = 'block';
                                addNoteBtn.style.display = 'none';
                            });
                        }
                        
                        if (cancelNoteBtn && noteForm && addNoteBtn) {
                            cancelNoteBtn.addEventListener('click', () => {
                                noteForm.style.display = 'none';
                                addNoteBtn.style.display = 'block';
                                page.querySelector('#note-title').value = '';
                                page.querySelector('#note-content').value = '';
                                page.querySelector('#note-category').value = 'general';
                            });
                        }
                        
                        if (saveNoteBtn) {
                            saveNoteBtn.addEventListener('click', () => {
                                const title = page.querySelector('#note-title')?.value?.trim();
                                const content = page.querySelector('#note-content')?.value?.trim();
                                const category = page.querySelector('#note-category')?.value || 'general';
                                
                                if (!content) {
                                    alert('Please enter note content.');
                                    return;
                                }
                                
                                const newNote = {
                                    id: 'note_' + Date.now(),
                                    title: title || 'Untitled Note',
                                    content: content,
                                    category: category,
                                    createdAt: new Date().toISOString(),
                                    updatedAt: new Date().toISOString()
                                };
                                
                                if (!company.notes_list) company.notes_list = [];
                                company.notes_list.unshift(newNote);
                                window.cavCRM.updateCompany(companyId, { notes_list: company.notes_list });
                                
                                alert('‚úÖ Note saved!');
                                showCompanyDetailModal(companyId); // Refresh the view
                            });
                        }
                        
                        // Delete note buttons
                        page.querySelectorAll('.delete-note-btn').forEach(btn => {
                            btn.addEventListener('click', () => {
                                const idx = parseInt(btn.dataset.idx);
                                if (confirm('Delete this note?')) {
                                    company.notes_list.splice(idx, 1);
                                    window.cavCRM.updateCompany(companyId, { notes_list: company.notes_list });
                                    showCompanyDetailModal(companyId); // Refresh the view
                                }
                            });
                        });
                        
                        // Edit note buttons
                        page.querySelectorAll('.edit-note-btn').forEach(btn => {
                            btn.addEventListener('click', () => {
                                const idx = parseInt(btn.dataset.idx);
                                const note = company.notes_list[idx];
                                if (!note) return;
                                
                                // Show form with note data
                                noteForm.style.display = 'block';
                                addNoteBtn.style.display = 'none';
                                page.querySelector('#note-title').value = note.title || '';
                                page.querySelector('#note-content').value = note.content || '';
                                page.querySelector('#note-category').value = note.category || 'general';
                                
                                // Change save button to update mode
                                saveNoteBtn.textContent = 'Update Note';
                                saveNoteBtn.dataset.editIdx = idx;
                                
                                // Update the save handler for edit mode
                                const originalHandler = saveNoteBtn.onclick;
                                saveNoteBtn.onclick = () => {
                                    const editIdx = parseInt(saveNoteBtn.dataset.editIdx);
                                    const title = page.querySelector('#note-title')?.value?.trim();
                                    const content = page.querySelector('#note-content')?.value?.trim();
                                    const category = page.querySelector('#note-category')?.value || 'general';
                                    
                                    if (!content) {
                                        alert('Please enter note content.');
                                        return;
                                    }
                                    
                                    company.notes_list[editIdx] = {
                                        ...company.notes_list[editIdx],
                                        title: title || 'Untitled Note',
                                        content: content,
                                        category: category,
                                        updatedAt: new Date().toISOString()
                                    };
                                    
                                    window.cavCRM.updateCompany(companyId, { notes_list: company.notes_list });
                                    alert('‚úÖ Note updated!');
                                    showCompanyDetailModal(companyId); // Refresh the view
                                };
                            });
                        });
                    }
                    
                    // Expose globally for onclick handlers
                    window.showCompanyDetailModal = showCompanyDetailModal;
                    window._fullShowCompanyDetailModal = showCompanyDetailModal;
                    
                    function editCompany(company) {
                        const form = window.cavCRM.createCompanyForm(company);
                        document.body.appendChild(form);
                        
                        form.querySelector('.crm-modal-close')?.addEventListener('click', () => form.remove());
                        form.querySelector('.crm-modal-cancel')?.addEventListener('click', () => form.remove());
                        form.querySelector('.crm-modal-save')?.addEventListener('click', () => {
                            const companyData = {
                                name: document.getElementById('company-name')?.value,
                                industry: document.getElementById('company-industry')?.value,
                                website: document.getElementById('company-website')?.value,
                                phone: document.getElementById('company-phone')?.value,
                                email: document.getElementById('company-email')?.value,
                                location: document.getElementById('company-location')?.value,
                                type: document.getElementById('company-type')?.value,
                                description: document.getElementById('company-description')?.value,
                                tags: document.getElementById('company-tags')?.value.split(',').map(t => t.trim()).filter(Boolean),
                                notes: document.getElementById('company-notes')?.value,
                            };
                            
                            if (!companyData.name) {
                                alert('Company name is required.');
                                return;
                            }
                            
                            window.cavCRM.updateCompany(company.id, companyData);
                            form.remove();
                            renderCompaniesList();
                            alert('Company updated successfully!');
                        });
                    }
                    
                    function renderProjectsList() {
                        const projects = window.cavCRM.getAllProjects();
                        const list = document.getElementById('crm-projects-list');
                        
                        if (projects.length === 0) {
                            list.innerHTML = '<p style="color: #c4b5fd; text-align: center; padding: 2rem;">No projects yet. Click "+ Add Project" to get started.</p>';
                            return;
                        }
                        
                        list.innerHTML = projects.map(p => `
                            <div class="crm-list-item" data-id="${p.id}">
                                <div class="crm-list-avatar" style="background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%);">üìÅ</div>
                                <div class="crm-list-info">
                                    <div class="crm-list-name">${p.name}</div>
                                    <div class="crm-list-meta">${p.clientName || 'No client'} ‚Ä¢ ${p.linkedAssets.length} assets</div>
                                </div>
                                <span class="crm-list-badge" style="background: ${p.status === 'active' ? '#22c55e' : p.status === 'completed' ? '#3b82f6' : '#6b7280'}; color: #fff;">${p.status}</span>
                            </div>
                        `).join('');
                    }
                    
                    function renderDealPipeline() {
                        const pipeline = window.cavCRM.getDealPipeline();
                        const container = document.getElementById('crm-deal-pipeline');
                        
                        const stages = ['lead', 'qualified', 'proposal', 'negotiation', 'closed_won', 'closed_lost'];
                        const stageLabels = {
                            lead: 'üéØ Lead',
                            qualified: '‚úÖ Qualified',
                            proposal: 'üìù Proposal',
                            negotiation: 'ü§ù Negotiation',
                            closed_won: 'üéâ Won',
                            closed_lost: '‚ùå Lost'
                        };
                        
                        container.innerHTML = stages.map(stage => `
                            <div class="crm-pipeline-stage">
                                <div class="crm-pipeline-header">
                                    <span class="crm-pipeline-title">${stageLabels[stage]}</span>
                                    <span class="crm-pipeline-value">$${(pipeline[stage]?.totalValue || 0).toLocaleString()}</span>
                                </div>
                                ${(pipeline[stage]?.deals || []).map(d => `
                                    <div class="crm-list-item" style="margin-bottom: 0.5rem;">
                                        <div class="crm-list-info">
                                            <div class="crm-list-name">${d.name}</div>
                                            <div class="crm-list-meta">$${d.value.toLocaleString()}</div>
                                        </div>
                                    </div>
                                `).join('')}
                                ${(pipeline[stage]?.deals || []).length === 0 ? '<p style="color: #6b7280; font-size: 0.8rem; text-align: center;">No deals</p>' : ''}
                            </div>
                        `).join('');
                    }
                    
                    function renderActivityFeed() {
                        const activities = window.cavCRM.getActivities({ limit: 50 });
                        const feed = document.getElementById('crm-activity-feed');
                        
                        if (activities.length === 0) {
                            feed.innerHTML = '<p style="color: #c4b5fd; text-align: center; padding: 2rem;">No activity recorded yet.</p>';
                            return;
                        }
                        
                        feed.innerHTML = activities.map(a => `
                            <div class="crm-activity-item">
                                <div class="crm-activity-icon">${a.type.includes('contact') ? 'üë§' : a.type.includes('company') ? 'üè¢' : a.type.includes('deal') ? 'üí∞' : 'üìã'}</div>
                                <div class="crm-activity-content">
                                    <div class="crm-activity-text">${a.type.replace(/_/g, ' ')}</div>
                                    <div class="crm-activity-time">${new Date(a.timestamp).toLocaleString()} ‚Ä¢ ${a.userName || 'System'}</div>
                                </div>
                            </div>
                        `).join('');
                    }
                    
                    // Initial render
                    renderContactsList();
                } else {
                    alert('CRM module not loaded. Please refresh the page.');
                }
            });
        }
        
        // Integrations Link
        const integrationsLink = document.getElementById('integrations-link');
        if (integrationsLink) {
            integrationsLink.addEventListener('click', (e) => {
                e.preventDefault();
                const session = getSession();
                if (!session) {
                    alert('Please sign in to access Integrations.');
                    return;
                }
                
                if (window.cavIntegrations) {
                    // Create Integrations modal
                    const intModal = document.createElement('div');
                    intModal.id = 'integrations-modal-container';
                    intModal.innerHTML = `
                        <div class="admin-modal-overlay">
                            <div class="admin-modal" style="max-width: 1200px;">
                                <div class="admin-header">
                                    <h2>üîó Integration Hub</h2>
                                    <button class="admin-close-btn" id="int-close">‚úï</button>
                                </div>
                                <div id="int-content-area" style="overflow-y: auto; max-height: 80vh;"></div>
                            </div>
                        </div>
                    `;
                    document.body.appendChild(intModal);
                    
                    // Render integrations panel
                    const intPanel = window.cavIntegrations.createPanel(window.cavIntegrations);
                    document.getElementById('int-content-area').appendChild(intPanel);
                    
                    // Close button
                    document.getElementById('int-close').addEventListener('click', () => intModal.remove());
                    
                    // Connect buttons
                    intModal.querySelectorAll('.int-btn-connect').forEach(btn => {
                        btn.addEventListener('click', async () => {
                            const integrationId = btn.dataset.id;
                            btn.textContent = 'Connecting...';
                            btn.disabled = true;
                            
                            try {
                                await window.cavIntegrations.connect(integrationId);
                                alert(`Connected to ${window.INTEGRATIONS[integrationId]?.name}!`);
                                intModal.remove();
                                document.getElementById('integrations-link').click();
                            } catch (err) {
                                alert(`Failed to connect: ${err.message}`);
                                btn.textContent = 'Connect';
                                btn.disabled = false;
                            }
                        });
                    });
                    
                    // Scan buttons
                    intModal.querySelectorAll('.int-btn-scan').forEach(btn => {
                        btn.addEventListener('click', async () => {
                            const integrationId = btn.dataset.id;
                            btn.textContent = 'Scanning...';
                            btn.disabled = true;
                            
                            try {
                                const results = await window.cavIntegrations.scanService(integrationId);
                                
                                // Show results
                                const resultsDiv = document.getElementById('int-results');
                                resultsDiv.style.display = 'block';
                                document.getElementById('int-results-content').innerHTML = `
                                    <div style="background: rgba(0,0,0,0.3); padding: 1rem; border-radius: 8px; margin-bottom: 1rem;">
                                        <h4 style="color: #fff; margin-bottom: 0.5rem;">Scan Complete</h4>
                                        <p style="color: #c4b5fd;">Found ${results.assets?.length || 0} assets ‚Ä¢ ${results.issues?.length || 0} with issues</p>
                                    </div>
                                    ${results.assets?.length > 0 ? `
                                        <div style="max-height: 300px; overflow-y: auto;">
                                            ${results.assets.map(a => `
                                                <div style="display: flex; justify-content: space-between; align-items: center; padding: 0.75rem; background: rgba(0,0,0,0.2); border-radius: 6px; margin-bottom: 0.5rem;">
                                                    <div>
                                                        <div style="color: #fff;">${a.name}</div>
                                                        <div style="color: #6b7280; font-size: 0.8rem;">${a.width}x${a.height} ‚Ä¢ ${a.type}</div>
                                                    </div>
                                                    <div>
                                                        ${a.validationIssues?.length > 0 
                                                            ? `<span style="color: #f59e0b;">‚ö†Ô∏è ${a.validationIssues.length} issues</span>`
                                                            : `<span style="color: #22c55e;">‚úÖ Valid</span>`
                                                        }
                                                    </div>
                                                </div>
                                            `).join('')}
                                        </div>
                                    ` : '<p style="color: #c4b5fd;">No assets found.</p>'}
                                `;
                                
                                btn.textContent = 'Scan';
                                btn.disabled = false;
                            } catch (err) {
                                alert(`Scan failed: ${err.message}`);
                                btn.textContent = 'Scan';
                                btn.disabled = false;
                            }
                        });
                    });
                    
                    // Disconnect buttons
                    intModal.querySelectorAll('.int-btn-disconnect').forEach(btn => {
                        btn.addEventListener('click', () => {
                            const integrationId = btn.dataset.id;
                            if (confirm(`Disconnect from ${window.INTEGRATIONS[integrationId]?.name}?`)) {
                                window.cavIntegrations.disconnect(integrationId);
                                intModal.remove();
                                document.getElementById('integrations-link').click();
                            }
                        });
                    });
                    
                    // Save settings
                    document.getElementById('int-save-settings')?.addEventListener('click', () => {
                        window.cavIntegrations.updateSettings({
                            notifyOnIssues: document.getElementById('int-notify-issues').checked,
                            notifyVia: document.getElementById('int-notify-via').value,
                            emailAddress: document.getElementById('int-email').value,
                            slackWebhookUrl: document.getElementById('int-slack-webhook').value,
                        });
                        alert('Settings saved!');
                    });
                } else {
                    alert('Integration Hub not loaded. Please refresh the page.');
                }
            });
        }

        document.addEventListener('click', () => updateActivity());
        
        // =============================================
        // THEME TOGGLE - Adobe Express Style
        // =============================================
        function initThemeToggle() {
            const toggle = document.getElementById('theme-toggle');
            if (!toggle) return;
            
            // Check for saved theme preference
            const savedTheme = localStorage.getItem('cav-theme') || 'dark';
            document.documentElement.setAttribute('data-theme', savedTheme);
            updateThemeIcon(savedTheme);
            
            toggle.addEventListener('click', () => {
                const currentTheme = document.documentElement.getAttribute('data-theme') || 'dark';
                const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
                
                document.documentElement.setAttribute('data-theme', newTheme);
                localStorage.setItem('cav-theme', newTheme);
                updateThemeIcon(newTheme);
                
                // Smooth transition
                document.body.style.transition = 'background-color 0.3s ease, color 0.3s ease';
            });
            
            function updateThemeIcon(theme) {
                toggle.textContent = theme === 'dark' ? '‚òÄÔ∏è' : 'üåô';
                toggle.title = theme === 'dark' ? 'Switch to light mode' : 'Switch to dark mode';
            }
        }
        
        // Initialize theme toggle
        initThemeToggle();
        
        // =============================================
        // GLOBAL COMPANY DETAIL VIEW FUNCTION
        // =============================================
        // This needs to be defined globally before renderCRMPage is called
        window.showCompanyDetailModal = window.showCompanyDetailModal || function(companyId) {
            console.log('[CRM] Global showCompanyDetailModal called for:', companyId);
            // Delegate to the proper function if it's been fully defined
            if (window._fullShowCompanyDetailModal) {
                return window._fullShowCompanyDetailModal(companyId);
            }
            
            const company = window.cavCRM?.getCompany(companyId);
            if (!company) {
                console.warn('[CRM] Company not found:', companyId);
                return;
            }
            
            // Simple fallback: trigger the CRM link click handler which defines the full function
            const crmLink = document.getElementById('crm-link');
            if (crmLink) {
                crmLink.click();
                // Wait for the modal to be set up, then call the full function
                setTimeout(() => {
                    if (window.showCompanyDetailModal !== this) {
                        window.showCompanyDetailModal(companyId);
                    }
                }, 100);
            }
        };
        
        // =============================================
        // NAVIGATION INITIALIZATION
        // =============================================
        function initNavigation() {
            const dynamicContentArea = document.getElementById('cav-dynamic-content');
            
            // Helper to show/hide main validator and dynamic content
            function showDynamicContent() {
                const validator = document.getElementById('creative-asset-validator-root');
                if (!dynamicContentArea) return;
                
                if (!document.getElementById('cav-dynamic-content')) {
                    const container = document.createElement('div');
                    container.id = 'cav-dynamic-content';
                    container.className = 'cav-dynamic-content';
                    container.style.cssText = 'display: none; min-height: 80vh; padding: 2rem;';
                    validator?.parentNode?.insertBefore(container, validator.nextSibling);
                }
            }
            
            // Library button
            document.getElementById('nav-library')?.addEventListener('click', () => {
                setActiveNav('nav-library');
                const validator = document.getElementById('creative-asset-validator-root');
                const dynamic = document.getElementById('cav-dynamic-content');
                if (validator) validator.style.display = 'block';
                if (dynamic) dynamic.style.display = 'none';
                validator?.scrollIntoView({ behavior: 'smooth' });
            });
            
            // Analyze button - v3.0 Creative Intelligence
            document.getElementById('nav-analyze')?.addEventListener('click', () => {
                setActiveNav('nav-analyze');
                showV3Module('analyze');
            });
            
            // Strategy button - v3.0 Deployment Planning
            document.getElementById('nav-strategy')?.addEventListener('click', () => {
                setActiveNav('nav-strategy');
                showV3Module('strategy');
            });
            
            // Learn button - v3.0 Knowledge Intelligence
            document.getElementById('nav-learn')?.addEventListener('click', () => {
                setActiveNav('nav-learn');
                showV3Module('learn');
            });
            
            // Settings button - v3.0 API Configuration
            document.getElementById('nav-settings')?.addEventListener('click', () => {
                setActiveNav('nav-settings');
                showV3Module('settings');
            });
            
            // AI Studio button (main top nav)
            document.getElementById('nav-ai-studio')?.addEventListener('click', () => {
                setActiveNav('nav-ai-studio');
                if (window.showAIStudio) {
                    window.showAIStudio();
                } else {
                    document.getElementById('ai-studio-link')?.click();
                }
            });
            
            // Brand Kit button
            document.getElementById('nav-brand-kit')?.addEventListener('click', () => {
                setActiveNav('nav-brand-kit');
                showV3Module('brand-kit');
            });
            
            // CRM button - render as page, not modal
            document.getElementById('nav-crm')?.addEventListener('click', () => {
                const session = getSession();
                if (!session) {
                    alert('Please sign in to access the CRM.');
                    return;
                }
                setActiveNav('nav-crm');
                
                // Ensure CRM helper functions are initialized by triggering the old handler once
                if (!window._fullShowCompanyDetailModal) {
                    const crmLink = document.getElementById('crm-link');
                    if (crmLink) {
                        // Create and immediately remove the modal to initialize functions
                        crmLink.click();
                        const modal = document.getElementById('crm-modal-container');
                        if (modal) modal.remove();
                    }
                }
                
                showV3Module('crm');
            });
            
            // Integrations button - render as page, not modal
            document.getElementById('nav-integrations')?.addEventListener('click', () => {
                const session = getSession();
                if (!session) {
                    alert('Please sign in to access Integrations.');
                    return;
                }
                setActiveNav('nav-integrations');
                showV3Module('integrations');
            });
            
            // Usage button - render as page, not modal
            document.getElementById('nav-usage')?.addEventListener('click', () => {
                const session = getSession();
                if (!session) {
                    alert('Please sign in to view usage statistics.');
                    return;
                }
                setActiveNav('nav-usage');
                showV3Module('usage');
            });
        }
        
        // Show v3.0 module in dynamic content area
        function showV3Module(module) {
            const validator = document.getElementById('creative-asset-validator-root');
            let dynamic = document.getElementById('cav-dynamic-content');
            
            // Get sidebar width CSS variable - check for mobile first
            const isMobile = window.innerWidth <= 1024;
            const sidebarWidth = isMobile ? '0' : (getComputedStyle(document.documentElement).getPropertyValue('--sidebar-width-collapsed') || '72px');
            const topbarHeight = getComputedStyle(document.documentElement).getPropertyValue('--topbar-height') || '56px';
            const padding = isMobile ? '12px' : '24px';
            
            // Create dynamic content area if not exists
            if (!dynamic) {
                dynamic = document.createElement('div');
                dynamic.id = 'cav-dynamic-content';
                dynamic.className = 'cav-dynamic-content cav-page';
                validator?.parentNode?.insertBefore(dynamic, validator.nextSibling);
            }
            
            // Apply responsive positioning - CSS media queries will handle mobile
            dynamic.style.cssText = `
                margin-left: ${sidebarWidth};
                margin-top: ${topbarHeight};
                padding: ${padding};
                min-height: calc(100vh - ${topbarHeight});
                transition: margin-left 0.3s cubic-bezier(0.4, 0, 0.2, 1);
                box-sizing: border-box;
                width: ${isMobile ? '100%' : 'auto'};
            `;
            
            // Hide validator, show dynamic
            if (validator) validator.style.display = 'none';
            dynamic.style.display = 'block';
            
            // Handle window resize for responsiveness
            const updateResponsive = () => {
                const nowMobile = window.innerWidth <= 1024;
                if (nowMobile) {
                    dynamic.style.marginLeft = '0';
                    dynamic.style.padding = '12px';
                    dynamic.style.width = '100%';
                } else {
                    dynamic.style.marginLeft = getComputedStyle(document.documentElement).getPropertyValue('--sidebar-width-collapsed') || '72px';
                    dynamic.style.padding = '24px';
                    dynamic.style.width = 'auto';
                }
            };
            
            // Add resize listener (remove old one first to prevent duplicates)
            window.removeEventListener('resize', window._cavResizeHandler);
            window._cavResizeHandler = updateResponsive;
            window.addEventListener('resize', window._cavResizeHandler);
            
            // Render appropriate module
            switch (module) {
                case 'analyze':
                    if (window.CAVAnalyze?.render) {
                        window.CAVAnalyze.render(dynamic);
                    } else {
                        dynamic.innerHTML = '<div class="cav-page-empty"><p>‚è≥ Loading Analyze module...</p></div>';
                    }
                    break;
                case 'strategy':
                    if (window.CAVStrategy?.render) {
                        window.CAVStrategy.render(dynamic);
                    } else {
                        dynamic.innerHTML = '<div class="cav-page-empty"><p>‚è≥ Loading Strategy module...</p></div>';
                    }
                    break;
                case 'learn':
                    if (window.CAVLearn?.render) {
                        window.CAVLearn.render(dynamic);
                    } else {
                        dynamic.innerHTML = '<div class="cav-page-empty"><p>‚è≥ Loading Learn module...</p></div>';
                    }
                    break;
                case 'settings':
                    if (window.CAVSettings?.render) {
                        window.CAVSettings.render(dynamic);
                    } else {
                        dynamic.innerHTML = '<div class="cav-page-empty"><p>‚è≥ Loading Settings module...</p></div>';
                    }
                    break;
                case 'crm':
                    renderCRMPage(dynamic);
                    break;
                case 'integrations':
                    renderIntegrationsPage(dynamic);
                    break;
                case 'usage':
                    renderUsagePage(dynamic);
                    break;
                case 'brand-kit':
                    renderBrandKitPage(dynamic);
                    break;
                default:
                    dynamic.innerHTML = '<div class="cav-page-empty"><p>‚ùå Unknown module</p></div>';
            }
            
            // Scroll to top
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }
        
        function setActiveNav(activeId) {
            // Update sidebar nav items
            document.querySelectorAll('.cav-nav-item').forEach(btn => {
                btn.classList.remove('active');
                if (btn.id === activeId) btn.classList.add('active');
            });
        }
        
        // NOTE: showCompanyDetailModal is defined above in the renderCRMDashboard scope and exposed globally at window.showCompanyDetailModal
        
        // =============================================
        // CRM PAGE (Full Page, Not Modal) - Library Style
        // =============================================
        function renderCRMPage(container) {
            const session = getSession();
            if (!window.cavCRM) {
                container.innerHTML = '<div class="cav-page-empty"><p>‚è≥ Loading CRM module...</p></div>';
                return;
            }
            
            const companies = window.cavCRM.getAllCompanies();
            const contacts = window.cavCRM.getAllContacts();
            const projects = window.cavCRM.getAllProjects();
            const deals = window.cavCRM.getAllDeals();
            
            container.innerHTML = `
                <!-- Action Cards - Library Style -->
                <div class="cav-action-cards">
                    <div class="cav-action-card" id="crm-add-contact-btn" data-tooltip="Create a new contact record">
                        <div class="cav-action-card-icon"><svg class="cav-icon" style="width:32px;height:32px;"><use href="#icon-plus"/></svg></div>
                        <h3 class="cav-action-card-title">Add Contact</h3>
                        <p class="cav-action-card-description">New person or lead</p>
                    </div>
                    <div class="cav-action-card" id="crm-add-company-btn" data-tooltip="Create a new company record">
                        <div class="cav-action-card-icon"><svg class="cav-icon" style="width:32px;height:32px;"><use href="#icon-crm"/></svg></div>
                        <h3 class="cav-action-card-title">Add Company</h3>
                        <p class="cav-action-card-description">New client or prospect</p>
                    </div>
                    <div class="cav-action-card" id="crm-add-project-btn" data-tooltip="Create a new project">
                        <div class="cav-action-card-icon"><svg class="cav-icon" style="width:32px;height:32px;"><use href="#icon-library"/></svg></div>
                        <h3 class="cav-action-card-title">Add Project</h3>
                        <p class="cav-action-card-description">Track a campaign</p>
                    </div>
                    <div class="cav-action-card" id="crm-add-deal-btn" data-tooltip="Track a new sales opportunity">
                        <div class="cav-action-card-icon"><svg class="cav-icon" style="width:32px;height:32px;"><use href="#icon-analyze"/></svg></div>
                        <h3 class="cav-action-card-title">Add Deal</h3>
                        <p class="cav-action-card-description">Sales opportunity</p>
                    </div>
                </div>
                
                <!-- Quick Stats Section -->
                <div class="cav-section-header">
                    <div>
                        <h3 class="cav-section-title">Quick Stats</h3>
                        <p class="cav-section-subtitle">Overview of your CRM data</p>
                    </div>
                </div>
                <div class="cav-quick-actions">
                    <button class="cav-quick-pill" data-tooltip="View all contacts">
                        <svg class="cav-icon cav-quick-pill-icon purple"><use href="#icon-crm"/></svg>
                        <span>${contacts.length} Contacts</span>
                    </button>
                    <button class="cav-quick-pill" data-tooltip="View all companies">
                        <svg class="cav-icon cav-quick-pill-icon blue"><use href="#icon-library"/></svg>
                        <span>${companies.length} Companies</span>
                    </button>
                    <button class="cav-quick-pill" data-tooltip="View all projects">
                        <svg class="cav-icon cav-quick-pill-icon green"><use href="#icon-library"/></svg>
                        <span>${projects.length} Projects</span>
                    </button>
                    <button class="cav-quick-pill" data-tooltip="View all deals">
                        <svg class="cav-icon cav-quick-pill-icon orange"><use href="#icon-analyze"/></svg>
                        <span>${deals.length} Deals</span>
                    </button>
                </div>
                
                <!-- Tabs - Same style as Library filter buttons -->
                <div class="cav-module-tabs">
                    <button class="cav-module-tab active" data-tab="companies" data-tooltip="View and manage companies">
                        <svg class="cav-icon"><use href="#icon-library"/></svg> Companies
                    </button>
                    <button class="cav-module-tab" data-tab="contacts" data-tooltip="View and manage contacts">
                        <svg class="cav-icon"><use href="#icon-crm"/></svg> Contacts
                    </button>
                    <button class="cav-module-tab" data-tab="projects" data-tooltip="View and manage projects">
                        <svg class="cav-icon"><use href="#icon-library"/></svg> Projects
                    </button>
                    <button class="cav-module-tab" data-tab="deals" data-tooltip="View sales pipeline">
                        <svg class="cav-icon"><use href="#icon-analyze"/></svg> Deals
                    </button>
                    <button class="cav-module-tab" data-tab="activity" data-tooltip="View recent activity">
                        <svg class="cav-icon"><use href="#icon-usage"/></svg> Activity
                    </button>
                </div>
                
                <!-- Tab Content -->
                <div class="cav-page-section">
                    <div id="crm-page-content">
                        <!-- Companies list rendered here -->
                    </div>
                </div>
            `;
            
            // Tab switching
            container.querySelectorAll('.cav-page-tab').forEach(tab => {
                tab.addEventListener('click', () => {
                    container.querySelectorAll('.cav-page-tab').forEach(t => t.classList.remove('active'));
                    tab.classList.add('active');
                    renderCRMTabContent(tab.dataset.tab);
                });
            });
            
            // Add buttons
            container.querySelector('#crm-add-contact-btn')?.addEventListener('click', () => showCRMForm('contact'));
            container.querySelector('#crm-add-company-btn')?.addEventListener('click', () => showCRMForm('company'));
            container.querySelector('#crm-add-project-btn')?.addEventListener('click', () => showCRMForm('project'));
            
            // Initial render
            renderCRMTabContent('companies');
        }
        
        function renderCRMTabContent(tab) {
            const content = document.getElementById('crm-page-content');
            if (!content || !window.cavCRM) return;
            
            switch (tab) {
                case 'companies':
                    const companies = window.cavCRM.getAllCompanies();
                    if (companies.length === 0) {
                        content.innerHTML = '<div class="cav-page-empty"><div class="cav-page-empty-icon">üè¢</div><div class="cav-page-empty-title">No Companies Yet</div><div class="cav-page-empty-text">Add your first company to get started with CRM tracking.</div></div>';
                    } else {
                        content.innerHTML = `
                            <table class="cav-page-table">
                                <thead>
                                    <tr>
                                        <th>Company</th>
                                        <th>Industry</th>
                                        <th>Website</th>
                                        <th>Type</th>
                                        <th>Assets</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${companies.map(c => `
                                        <tr class="crm-row" data-id="${c.id}">
                                            <td><strong style="color: var(--cav-primary);">${c.name}</strong></td>
                                            <td>${c.industry || '-'}</td>
                                            <td>${c.website ? '<a href="'+c.website+'" target="_blank" style="color: var(--cav-primary);">'+c.website+'</a>' : '-'}</td>
                                            <td><span class="cav-badge">${c.type || 'client'}</span></td>
                                            <td>${(c.linkedAssets || []).length}</td>
                                            <td>
                                                <button class="cav-btn cav-btn-ghost cav-btn-sm crm-view-company" data-id="${c.id}">View</button>
                                            </td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        `;
                        // View handlers
                        content.querySelectorAll('.crm-view-company').forEach(btn => {
                            btn.addEventListener('click', () => {
                                const companyId = btn.dataset.id;
                                if (companyId && window.showCompanyDetailModal) {
                                    window.showCompanyDetailModal(companyId);
                                }
                            });
                        });
                    }
                    break;
                    
                case 'contacts':
                    const contacts = window.cavCRM.getAllContacts();
                    if (contacts.length === 0) {
                        content.innerHTML = '<div class="cav-page-empty"><div class="cav-page-empty-icon">üë•</div><div class="cav-page-empty-title">No Contacts Yet</div><div class="cav-page-empty-text">Add your first contact to build your network.</div></div>';
                    } else {
                        content.innerHTML = `
                            <table class="cav-page-table">
                                <thead>
                                    <tr>
                                        <th>Name</th>
                                        <th>Email</th>
                                        <th>Company</th>
                                        <th>Title</th>
                                        <th>Type</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${contacts.map(c => `
                                        <tr>
                                            <td><strong>${c.firstName} ${c.lastName}</strong></td>
                                            <td><a href="mailto:${c.email}" style="color: var(--cav-primary);">${c.email}</a></td>
                                            <td>${c.companyName || '-'}</td>
                                            <td>${c.title || '-'}</td>
                                            <td><span class="cav-badge">${c.type || 'lead'}</span></td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        `;
                    }
                    break;
                    
                case 'projects':
                    const projects = window.cavCRM.getAllProjects();
                    if (projects.length === 0) {
                        content.innerHTML = '<div class="cav-page-empty"><div class="cav-page-empty-icon">üìÅ</div><div class="cav-page-empty-title">No Projects Yet</div><div class="cav-page-empty-text">Create your first project to track campaign progress.</div></div>';
                    } else {
                        content.innerHTML = `
                            <table class="cav-page-table">
                                <thead>
                                    <tr>
                                        <th>Project</th>
                                        <th>Client</th>
                                        <th>Status</th>
                                        <th>Deadline</th>
                                        <th>Budget</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${projects.map(p => `
                                        <tr>
                                            <td><strong>${p.name}</strong></td>
                                            <td>${p.clientName || '-'}</td>
                                            <td><span class="cav-badge cav-badge-${p.status}">${p.status}</span></td>
                                            <td>${p.deadline ? new Date(p.deadline).toLocaleDateString() : '-'}</td>
                                            <td>${p.budget ? '$' + p.budget.toLocaleString() : '-'}</td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        `;
                    }
                    break;
                    
                case 'deals':
                    const deals = window.cavCRM.getAllDeals();
                    if (deals.length === 0) {
                        content.innerHTML = '<div class="cav-page-empty"><div class="cav-page-empty-icon">üí∞</div><div class="cav-page-empty-title">No Deals Yet</div><div class="cav-page-empty-text">Track your sales pipeline by creating deals.</div></div>';
                    } else {
                        content.innerHTML = `
                            <table class="cav-page-table">
                                <thead>
                                    <tr>
                                        <th>Deal</th>
                                        <th>Company</th>
                                        <th>Stage</th>
                                        <th>Value</th>
                                        <th>Probability</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${deals.map(d => `
                                        <tr>
                                            <td><strong>${d.name}</strong></td>
                                            <td>${d.companyName || '-'}</td>
                                            <td><span class="cav-badge">${d.stage}</span></td>
                                            <td style="color: var(--cav-success);">${d.value ? '$' + d.value.toLocaleString() : '-'}</td>
                                            <td>${d.probability || 0}%</td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        `;
                    }
                    break;
                    
                case 'activity':
                    const activities = window.cavCRM.getRecentActivities(50);
                    if (activities.length === 0) {
                        content.innerHTML = '<div class="cav-page-empty"><div class="cav-page-empty-icon">üìä</div><div class="cav-page-empty-title">No Activity Yet</div><div class="cav-page-empty-text">Activity will appear here as you use the CRM.</div></div>';
                    } else {
                        content.innerHTML = `
                            <div class="cav-activity-list">
                                ${activities.map(a => `
                                    <div class="cav-activity-item">
                                        <span class="cav-activity-icon">${getActivityIcon(a.type)}</span>
                                        <div class="cav-activity-content">
                                            <p>${a.description}</p>
                                            <span class="cav-activity-time">${new Date(a.timestamp).toLocaleString()}</span>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        `;
                    }
                    break;
            }
        }
        
        function getActivityIcon(type) {
            const icons = {
                'contact_created': 'üë§',
                'company_created': 'üè¢',
                'project_created': 'üìÅ',
                'deal_created': 'üí∞',
                'analysis_linked': 'üìä',
                'asset_linked': 'üñºÔ∏è',
                'note_added': 'üìù',
                'default': 'üìå'
            };
            return icons[type] || icons.default;
        }
        
        function showCRMForm(type) {
            if (!window.cavCRM) return;
            
            let form;
            switch (type) {
                case 'contact':
                    form = window.cavCRM.createContactForm();
                    break;
                case 'company':
                    form = window.cavCRM.createCompanyForm();
                    break;
                case 'project':
                    form = window.cavCRM.createProjectForm();
                    break;
            }
            
            if (form) {
                document.body.appendChild(form);
                
                // Form handlers
                form.querySelector('.crm-modal-close')?.addEventListener('click', () => form.remove());
                form.querySelector('.crm-modal-cancel')?.addEventListener('click', () => form.remove());
                form.querySelector('.crm-modal-save')?.addEventListener('click', () => {
                    saveCRMFormData(type, form);
                });
            }
        }
        
        function saveCRMFormData(type, form) {
            if (type === 'contact') {
                const data = {
                    firstName: form.querySelector('#contact-firstName')?.value,
                    lastName: form.querySelector('#contact-lastName')?.value,
                    email: form.querySelector('#contact-email')?.value,
                    phone: form.querySelector('#contact-phone')?.value,
                    companyName: form.querySelector('#contact-company')?.value,
                    title: form.querySelector('#contact-title')?.value,
                    type: form.querySelector('#contact-type')?.value,
                    notes: form.querySelector('#contact-notes')?.value,
                };
                if (!data.firstName || !data.email) {
                    alert('First name and email are required.');
                    return;
                }
                window.cavCRM.createContact(data);
                form.remove();
                renderCRMTabContent('contacts');
            } else if (type === 'company') {
                const data = {
                    name: form.querySelector('#company-name')?.value,
                    industry: form.querySelector('#company-industry')?.value,
                    website: form.querySelector('#company-website')?.value,
                    phone: form.querySelector('#company-phone')?.value,
                    email: form.querySelector('#company-email')?.value,
                    location: form.querySelector('#company-location')?.value,
                    type: form.querySelector('#company-type')?.value,
                    description: form.querySelector('#company-description')?.value,
                };
                if (!data.name) {
                    alert('Company name is required.');
                    return;
                }
                window.cavCRM.createCompany(data);
                form.remove();
                renderCRMTabContent('companies');
            } else if (type === 'project') {
                const data = {
                    name: form.querySelector('#project-name')?.value,
                    client: form.querySelector('#project-client')?.value,
                    type: form.querySelector('#project-type')?.value,
                    status: form.querySelector('#project-status')?.value,
                    startDate: form.querySelector('#project-start')?.value,
                    deadline: form.querySelector('#project-deadline')?.value,
                    budget: parseFloat(form.querySelector('#project-budget')?.value) || 0,
                    priority: form.querySelector('#project-priority')?.value,
                    description: form.querySelector('#project-description')?.value,
                };
                if (!data.name) {
                    alert('Project name is required.');
                    return;
                }
                window.cavCRM.createProject(data);
                form.remove();
                renderCRMTabContent('projects');
            }
        }
        
        // =============================================
        // BRAND KIT PAGE - Logo Generator
        // =============================================
        function renderBrandKitPage(container) {
            // Use the Brand Kit Generator module
            if (window.CAVBrandKit && window.CAVBrandKit.createUI) {
                container.innerHTML = window.CAVBrandKit.createUI(window.cavBrandKitGenerator);
                container.className = 'cav-brand-kit-page';
                
                // Attach event handlers after rendering
                setTimeout(() => {
                    window.CAVBrandKit.attachHandlers(window.cavBrandKitGenerator);
                }, 100);
            } else {
                container.innerHTML = `
                    <div class="cav-empty-state">
                        <div class="cav-empty-icon">üé®</div>
                        <h2>Brand Kit Generator</h2>
                        <p>Loading Brand Kit module...</p>
                    </div>
                `;
                console.warn('[BrandKit] Brand Kit Generator not loaded');
            }
        }
        
        // =============================================
        // INTEGRATIONS PAGE - Uses Full Integration Hub v3.0
        // =============================================
        function renderIntegrationsPage(container) {
            // Use the comprehensive Integration Hub panel
            if (window.cavIntegrations && window.cavIntegrations.createPanel) {
                container.innerHTML = '';
                container.className = 'cav-integrations-page';
                const panel = window.cavIntegrations.createPanel(window.cavIntegrations);
                container.appendChild(panel);
            } else {
                container.innerHTML = `
                    <div class="cav-empty-state">
                        <div class="cav-empty-icon">üîó</div>
                        <h2>Integration Hub</h2>
                        <p>Loading integrations...</p>
                    </div>
                `;
                console.error('[Integrations] Integration Hub not loaded');
            }
        }
        
        // =============================================
        // USAGE PAGE (Full Page, Not Modal) - Library Style
        // =============================================
        function renderUsagePage(container) {
            const session = getSession();
            const activities = getActivityLog().filter(a => a.email === session?.email);
            const aiHistory = JSON.parse(localStorage.getItem('cav_ai_history') || '[]');
            const assets = window.cavValidatorApp?.assets || [];
            const derivatives = assets.filter(a => a.isDerivative || a.is_ai_derivative);
            const folders = JSON.parse(localStorage.getItem('cav_folders') || '[]');
            
            // Calculate stats
            const totalAssets = assets.length;
            const totalDerivatives = derivatives.length;
            const totalVideos = assets.filter(a => a.file_type === 'video').length;
            const totalImages = assets.filter(a => a.file_type === 'image').length;
            const aiOperations = aiHistory.length;
            
            // Model usage breakdown
            const modelUsage = {};
            aiHistory.forEach(h => {
                const model = h.modelName || h.model || 'Unknown';
                modelUsage[model] = (modelUsage[model] || 0) + 1;
            });
            
            container.innerHTML = `
                <!-- Action Cards - Library Style -->
                <div class="cav-action-cards">
                    <div class="cav-action-card" data-tooltip="View your complete asset library">
                        <div class="cav-action-card-icon"><svg class="cav-icon" style="width:32px;height:32px;"><use href="#icon-library"/></svg></div>
                        <h3 class="cav-action-card-title">${totalAssets}</h3>
                        <p class="cav-action-card-description">Total Assets</p>
                    </div>
                    <div class="cav-action-card" data-tooltip="AI-generated derivatives and variations">
                        <div class="cav-action-card-icon"><svg class="cav-icon" style="width:32px;height:32px;"><use href="#icon-ai-studio"/></svg></div>
                        <h3 class="cav-action-card-title">${totalDerivatives}</h3>
                        <p class="cav-action-card-description">AI Derivatives</p>
                    </div>
                    <div class="cav-action-card" data-tooltip="Total AI operations performed">
                        <div class="cav-action-card-icon"><svg class="cav-icon" style="width:32px;height:32px;"><use href="#icon-analyze"/></svg></div>
                        <h3 class="cav-action-card-title">${aiOperations}</h3>
                        <p class="cav-action-card-description">AI Operations</p>
                    </div>
                    <div class="cav-action-card" data-tooltip="Organized asset folders">
                        <div class="cav-action-card-icon"><svg class="cav-icon" style="width:32px;height:32px;"><use href="#icon-library"/></svg></div>
                        <h3 class="cav-action-card-title">${folders.length}</h3>
                        <p class="cav-action-card-description">Folders</p>
                    </div>
                </div>
                
                <!-- Asset Breakdown -->
                <div class="cav-section-header">
                    <div>
                        <h3 class="cav-section-title">Asset Breakdown</h3>
                        <p class="cav-section-subtitle">Your content by type</p>
                    </div>
                </div>
                <div class="cav-quick-actions">
                    <button class="cav-quick-pill" data-tooltip="Image files in your library">
                        <svg class="cav-icon cav-quick-pill-icon purple"><use href="#icon-library"/></svg>
                        <span>${totalImages} Images</span>
                    </button>
                    <button class="cav-quick-pill" data-tooltip="Video files in your library">
                        <svg class="cav-icon cav-quick-pill-icon red"><use href="#icon-youtube-thumb"/></svg>
                        <span>${totalVideos} Videos</span>
                    </button>
                    <button class="cav-quick-pill" data-tooltip="AI-created derivative assets">
                        <svg class="cav-icon cav-quick-pill-icon green"><use href="#icon-ai-studio"/></svg>
                        <span>${totalDerivatives} Derivatives</span>
                    </button>
                </div>
                
                <!-- Tabs for different views -->
                <div class="cav-module-tabs">
                    <button class="cav-module-tab active" data-tab="ai-models" data-tooltip="View AI model usage statistics">
                        <svg class="cav-icon"><use href="#icon-ai-studio"/></svg> AI Models
                    </button>
                    <button class="cav-module-tab" data-tab="activity" data-tooltip="View your recent activity log">
                        <svg class="cav-icon"><use href="#icon-usage"/></svg> Activity Log
                    </button>
                </div>
                
                <!-- Tab Content -->
                <div id="usage-tab-content">
                    <div class="cav-page-section">
                        <div class="cav-section-header">
                            <div>
                                <h3 class="cav-section-title">AI Model Usage</h3>
                                <p class="cav-section-subtitle">Operations by model</p>
                            </div>
                        </div>
                        ${Object.keys(modelUsage).length > 0 ? `
                            <div class="cav-quick-actions">
                                ${Object.entries(modelUsage).map(([model, count]) => `
                                    <button class="cav-quick-pill" data-tooltip="Used ${count} times">
                                        <svg class="cav-icon cav-quick-pill-icon blue"><use href="#icon-ai-studio"/></svg>
                                        <span>${model}: ${count}</span>
                                    </button>
                                `).join('')}
                            </div>
                        ` : '<div class="cav-page-empty"><p>No AI operations recorded yet.</p></div>'}
                    </div>
                </div>
            `;
            
            // Add tab switching functionality
            container.querySelectorAll('.cav-module-tab').forEach(tab => {
                tab.addEventListener('click', () => {
                    container.querySelectorAll('.cav-module-tab').forEach(t => t.classList.remove('active'));
                    tab.classList.add('active');
                    
                    const tabType = tab.dataset.tab;
                    const contentArea = container.querySelector('#usage-tab-content');
                    
                    if (tabType === 'ai-models') {
                        let modelHtml = '<div class="cav-page-empty"><p>No AI operations recorded yet.</p></div>';
                        if (Object.keys(modelUsage).length > 0) {
                            modelHtml = '<div class="cav-quick-actions">' + 
                                Object.entries(modelUsage).map(([model, count]) => 
                                    '<button class="cav-quick-pill" data-tooltip="Used ' + count + ' times">' +
                                    '<svg class="cav-icon cav-quick-pill-icon blue"><use href="#icon-ai-studio"/></svg>' +
                                    '<span>' + model + ': ' + count + '</span></button>'
                                ).join('') + '</div>';
                        }
                        contentArea.innerHTML = '<div class="cav-page-section">' +
                            '<div class="cav-section-header"><div>' +
                            '<h3 class="cav-section-title">AI Model Usage</h3>' +
                            '<p class="cav-section-subtitle">Operations by model</p>' +
                            '</div></div>' + modelHtml + '</div>';
                    } else if (tabType === 'activity') {
                        let activityHtml = '<div class="cav-page-empty"><p>No recent activity.</p></div>';
                        if (activities.length > 0) {
                            activityHtml = '<div class="cav-activity-list">' + 
                                activities.slice(0, 20).map(a => 
                                    '<div class="cav-activity-item">' +
                                    '<span class="cav-activity-icon">' +
                                    '<svg class="cav-icon"><use href="#icon-' + (a.type === 'login' ? 'crm' : a.type === 'upload' ? 'upload' : 'info') + '"/></svg>' +
                                    '</span>' +
                                    '<div class="cav-activity-content">' +
                                    '<p>' + a.action + '</p>' +
                                    '<span class="cav-activity-time">' + new Date(a.timestamp).toLocaleString() + '</span>' +
                                    '</div></div>'
                                ).join('') + '</div>';
                        }
                        contentArea.innerHTML = '<div class="cav-page-section">' +
                            '<div class="cav-section-header"><div>' +
                            '<h3 class="cav-section-title">Recent Activity</h3>' +
                            '<p class="cav-section-subtitle">Your latest actions</p>' +
                            '</div></div>' + activityHtml + '</div>';
                    }
                });
            });
        }
        
        // =============================================
        // LEGACY USAGE DASHBOARD (Keep for compatibility)
        // =============================================
        function showUsageDashboard() {
            const session = getSession();
            if (!session) {
                alert('Please sign in to view usage statistics.');
                return;
            }
            
            // Get usage data
            const activities = getActivityLog().filter(a => a.email === session.email);
            const aiHistory = JSON.parse(localStorage.getItem('cav_ai_history') || '[]');
            const assets = window.cavValidatorApp?.assets || [];
            const derivatives = assets.filter(a => a.isDerivative || a.is_ai_derivative);
            const folders = JSON.parse(localStorage.getItem('cav_folders') || '[]');
            
            // Calculate stats
            const totalAssets = assets.length;
            const totalDerivatives = derivatives.length;
            const totalVideos = assets.filter(a => a.file_type === 'video').length;
            const totalImages = assets.filter(a => a.file_type === 'image').length;
            const aiOperations = aiHistory.length;
            const activitiesThisWeek = activities.filter(a => 
                new Date(a.timestamp) > new Date(Date.now() - 7 * 24 * 60 * 60 * 1000)
            ).length;
            
            // Model usage breakdown
            const modelUsage = {};
            aiHistory.forEach(h => {
                const model = h.modelName || h.model || 'Unknown';
                modelUsage[model] = (modelUsage[model] || 0) + 1;
            });
            
            const modal = document.createElement('div');
            modal.id = 'usage-modal-container';
            modal.innerHTML = `
                <div class="admin-modal-overlay">
                    <div class="admin-modal" style="max-width: 1000px;">
                        <div class="admin-header">
                            <h2>üìà Usage Statistics & Activity</h2>
                            <button class="admin-close-btn" id="usage-close">‚úï</button>
                        </div>
                        <div style="padding: 2rem; overflow-y: auto; max-height: 80vh;">
                            <!-- Stats Overview -->
                            <div class="stats-grid" style="margin-bottom: 2rem;">
                                <div class="stat-card">
                                    <div class="stat-value">${totalAssets}</div>
                                    <div class="stat-label">Total Assets</div>
                                </div>
                                <div class="stat-card">
                                    <div class="stat-value">${totalImages}</div>
                                    <div class="stat-label">Images</div>
                                </div>
                                <div class="stat-card">
                                    <div class="stat-value">${totalVideos}</div>
                                    <div class="stat-label">Videos</div>
                                </div>
                                <div class="stat-card">
                                    <div class="stat-value">${totalDerivatives}</div>
                                    <div class="stat-label">AI Derivatives</div>
                                </div>
                                <div class="stat-card">
                                    <div class="stat-value">${aiOperations}</div>
                                    <div class="stat-label">AI Operations</div>
                                </div>
                                <div class="stat-card">
                                    <div class="stat-value">${folders.length}</div>
                                    <div class="stat-label">Folders</div>
                                </div>
                            </div>
                            
                            <!-- AI Model Usage -->
                            <div style="background: rgba(0,0,0,0.3); border-radius: 12px; padding: 1.5rem; margin-bottom: 1.5rem;">
                                <h3 style="color: #e9d5ff; margin-bottom: 1rem;">ü§ñ AI Model Usage</h3>
                                ${Object.keys(modelUsage).length > 0 ? `
                                    <div style="display: grid; gap: 0.5rem;">
                                        ${Object.entries(modelUsage).map(([model, count]) => `
                                            <div style="display: flex; justify-content: space-between; padding: 0.5rem 1rem; background: rgba(139,92,246,0.2); border-radius: 6px;">
                                                <span style="color: #c4b5fd;">${model}</span>
                                                <span style="color: #fff; font-weight: 600;">${count} uses</span>
                                            </div>
                                        `).join('')}
                                    </div>
                                ` : '<p style="color: #94a3b8;">No AI operations recorded yet.</p>'}
                            </div>
                            
                            <!-- Recent Activity -->
                            <div style="background: rgba(0,0,0,0.3); border-radius: 12px; padding: 1.5rem;">
                                <h3 style="color: #e9d5ff; margin-bottom: 1rem;">üìã Recent Activity (${activitiesThisWeek} this week)</h3>
                                <div style="max-height: 300px; overflow-y: auto;">
                                    ${activities.slice(0, 20).map(a => `
                                        <div style="display: flex; justify-content: space-between; padding: 0.5rem 0; border-bottom: 1px solid rgba(255,255,255,0.1);">
                                            <span style="color: #fff;">${a.action}</span>
                                            <span style="color: #94a3b8; font-size: 0.8rem;">${new Date(a.timestamp).toLocaleString()}</span>
                                        </div>
                                    `).join('') || '<p style="color: #94a3b8;">No recent activity.</p>'}
                                </div>
                            </div>
                            
                            <!-- Storage Info -->
                            <div style="margin-top: 1.5rem; padding: 1rem; background: rgba(139,92,246,0.1); border-radius: 8px; border: 1px solid rgba(139,92,246,0.3);">
                                <p style="color: #c4b5fd; font-size: 0.875rem;">
                                    üíæ Storage: IndexedDB for videos ‚Ä¢ localStorage for settings ‚Ä¢ API key stored locally
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            document.getElementById('usage-close').addEventListener('click', () => modal.remove());
        }
        
        // =============================================
        // INITIALIZATION (v3.0 - Secure)
        // =============================================
        async function init() {
            console.log('[CAV Auth] Initializing v3.0...');
            
            // Clean any stale OAuth state
            localStorage.removeItem('cav_oauth_pending');
            localStorage.removeItem('cav_oauth_token');
            localStorage.removeItem('cav_oauth_error');
            
            // Wait for secure session restoration
            let session = null;
            
            if (pendingSessionRestore) {
                try {
                    session = await pendingSessionRestore;
                    console.log('[CAV Auth] Secure session restore completed:', session ? 'found' : 'none');
                } catch (e) {
                    console.error('[CAV Auth] Session restore failed:', e);
                }
            }
            
            // Fallback to legacy session if secure session not available
            if (!session && !window.CAVSecurity) {
                session = getSession();
                if (session) {
                    console.log('[CAV Auth] Using legacy session fallback');
                }
            }
            
            // Re-validate session permissions
            if (session) {
                session.role = getUserRole(session.email);
                session.canAccessTeam = canAccessTeam(session.userType, session.role);
                
                // Update permissions
                session.permissions = {
                    canUpload: canUpload(session.role),
                    canEdit: canEdit(session.role),
                    canDelete: canDelete(session.role),
                    canManageUsers: canManageUsers(session.role),
                    canAccessTeam: session.canAccessTeam
                };
                
                // Set global session
                window.cavUserSession = session;
                
                console.log('[CAV Auth] Session validated:', session.email, 'Role:', session.role);
            }
            
            // Setup event listeners now that DOM is ready
            setupEventListeners();
            
            updateUI(session);
            
            if (!session) {
                // Always setup sign-in - initGoogleSignIn will fallback to demo mode if needed
                if (document.readyState === 'complete') {
                    initGoogleSignIn();
                } else {
                    window.addEventListener('load', () => {
                        // Small delay to ensure all scripts are loaded
                        setTimeout(initGoogleSignIn, 300);
                    });
                }
            } else {
                // Update activity for active sessions
                if (window.CAVSecurity?.SecureSessionManager) {
                    window.CAVSecurity.SecureSessionManager.updateActivity();
                }
            }
            
            console.log('[CAV Auth] Initialization complete');
        }

        // Start initialization - wait for both DOM and security module
        async function startApp() {
            // DEV MODE: Allow bypassing auth with ?dev=1 URL parameter
            const urlParams = new URLSearchParams(window.location.search);
            const isDevMode = urlParams.get('dev') === '1' || urlParams.get('dev') === 'true';
            
            if (isDevMode) {
                console.log('[CAV Auth] DEV MODE ENABLED - Creating mock session');
                
                // Create mock admin session
                const devSession = {
                    id: 'dev_session_' + Date.now(),
                    email: window.AUTH_CONFIG?.ADMIN_EMAILS?.[0] || 'dev@localhost',
                    name: 'Developer',
                    picture: '',
                    role: 'admin',
                    userType: 'corporate',
                    canAccessTeam: true,
                    permissions: {
                        canUpload: true,
                        canDelete: true,
                        canShare: true,
                        canManageUsers: true,
                        canAccessAdmin: true,
                        canEditSettings: true
                    },
                    createdAt: Date.now(),
                    expiresAt: Date.now() + (30 * 24 * 60 * 60 * 1000), // 30 days
                    lastActivity: Date.now()
                };
                
                // Set session globally before init
                window.cavUserSession = devSession;
                
                // Also set in security manager if available
                if (window.CAVSecurity?.SecureSessionManager) {
                    window.CAVSecurity.SecureSessionManager._currentSession = devSession;
                }
                
                console.log('[CAV Auth] Dev session created:', window.cavUserSession.email);
            }
            
            // Wait for pending session restore first (skip if dev mode)
            if (!isDevMode && pendingSessionRestore) {
                try {
                    await pendingSessionRestore;
                    console.log('[CAV Auth] Session restore complete before init');
                } catch (e) {
                    console.warn('[CAV Auth] Session restore error:', e);
                }
            }
            
            // Now run init with restored session
            await init();
            
            // DEV MODE: Hide modal and update UI after init
            if (isDevMode) {
                // Force update UI for logged-in state
                if (typeof updateUI === 'function') {
                    updateUI(window.cavUserSession);
                    console.log('[CAV Auth] Dev mode: Updated UI');
                }
                
                // Hide all possible login overlays/modals with immediate effect
                const hideModals = () => {
                    const selectors = [
                        '#login-modal',
                        '#welcome-overlay',
                        '.cav-login-overlay',
                        '.cav-login-modal',
                        '.cav-welcome-modal',
                        '.cav-auth-modal',
                        '[class*="login-overlay"]',
                        '[class*="welcome-modal"]',
                        '[class*="login-modal"]'
                    ];
                    
                    selectors.forEach(selector => {
                        document.querySelectorAll(selector).forEach(el => {
                            if (el.style) {
                                el.style.display = 'none';
                                el.style.visibility = 'hidden';
                                el.style.opacity = '0';
                                el.style.pointerEvents = 'none';
                            }
                        });
                    });
                    console.log('[CAV Auth] Dev mode: Hid login modals');
                };
                
                // Hide immediately and again after delay
                hideModals();
                setTimeout(hideModals, 100);
                setTimeout(hideModals, 500);
            }
        }
        
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', startApp);
        } else {
            startApp();
        }
        
        // ========================================
        // RESPONSIVE HANDLER - Force mobile layout
        // ========================================
        function handleResponsiveLayout() {
            const isMobile = window.innerWidth <= 1024;
            const isSmallMobile = window.innerWidth <= 768;
            const sidebar = document.querySelector('.cav-sidebar');
            const dynamicContent = document.getElementById('cav-dynamic-content');
            const mainContent = document.getElementById('creative-asset-validator-root');
            const topbar = document.querySelector('.cav-topbar');
            const footer = document.querySelector('.site-footer');
            
            if (sidebar) {
                if (isMobile && !sidebar.classList.contains('mobile-open') && !sidebar.classList.contains('open')) {
                    sidebar.style.display = 'none';
                    sidebar.style.visibility = 'hidden';
                    sidebar.style.width = '0';
                    sidebar.style.opacity = '0';
                } else if (!isMobile) {
                    sidebar.style.display = '';
                    sidebar.style.visibility = '';
                    sidebar.style.width = '';
                    sidebar.style.opacity = '';
                }
            }
            
            if (dynamicContent) {
                if (isMobile) {
                    dynamicContent.style.marginLeft = '0';
                    dynamicContent.style.width = '100%';
                    dynamicContent.style.maxWidth = '100vw';
                    dynamicContent.style.padding = isSmallMobile ? '8px' : '12px';
                } else {
                    // Let CSS handle desktop
                    dynamicContent.style.marginLeft = '';
                    dynamicContent.style.width = '';
                    dynamicContent.style.maxWidth = '';
                    dynamicContent.style.padding = '';
                }
            }
            
            if (mainContent) {
                if (isMobile) {
                    mainContent.style.marginLeft = '0';
                    mainContent.style.width = '100%';
                    mainContent.style.maxWidth = '100vw';
                } else {
                    mainContent.style.marginLeft = '';
                    mainContent.style.width = '';
                    mainContent.style.maxWidth = '';
                }
            }
            
            if (topbar) {
                if (isMobile) {
                    topbar.style.left = '0';
                    topbar.style.width = '100%';
                } else {
                    topbar.style.left = '';
                    topbar.style.width = '';
                }
            }
            
            if (footer) {
                if (isMobile) {
                    footer.style.marginLeft = '0';
                    footer.style.width = '100%';
                } else {
                    footer.style.marginLeft = '';
                    footer.style.width = '';
                }
            }
            
            console.log('[CAV Responsive] Layout updated - isMobile:', isMobile, 'width:', window.innerWidth);
        }
        
        // Run on load and resize
        window.addEventListener('resize', handleResponsiveLayout);
        window.addEventListener('load', handleResponsiveLayout);
        document.addEventListener('DOMContentLoaded', handleResponsiveLayout);
        
        // Also run after a short delay to ensure all elements are rendered
        setTimeout(handleResponsiveLayout, 100);
        setTimeout(handleResponsiveLayout, 500);
    })();
    </script>
    
    <!-- Service Worker Registration for Speed & Offline Support -->
    <script>
    (function() {
        // Register Service Worker for instant loading
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', function() {
                navigator.serviceWorker.register('./sw.js')
                    .then(function(registration) {
                        console.log('[CAV] Service Worker registered successfully');
                        
                        // Check for updates
                        registration.addEventListener('updatefound', function() {
                            const newWorker = registration.installing;
                            newWorker.addEventListener('statechange', function() {
                                if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                                    // New version available
                                    console.log('[CAV] New version available');
                                    // Auto-update without prompting
                                    newWorker.postMessage('SKIP_WAITING');
                                }
                            });
                        });
                    })
                    .catch(function(error) {
                        console.warn('[CAV] Service Worker registration failed:', error);
                    });
            });
            
            // Listen for controller changes (update applied)
            navigator.serviceWorker.addEventListener('controllerchange', function() {
                console.log('[CAV] Service Worker updated, refreshing...');
                // Optionally refresh the page
                // window.location.reload();
            });
        }
        
        // Performance monitoring
        if ('performance' in window) {
            window.addEventListener('load', function() {
                setTimeout(function() {
                    const timing = performance.getEntriesByType('navigation')[0];
                    if (timing) {
                        console.log('[CAV Performance] Page load: ' + Math.round(timing.loadEventEnd - timing.startTime) + 'ms');
                        console.log('[CAV Performance] DOM ready: ' + Math.round(timing.domContentLoadedEventEnd - timing.startTime) + 'ms');
                    }
                }, 0);
            });
        }
    })();
    </script>
</body>
</html>

